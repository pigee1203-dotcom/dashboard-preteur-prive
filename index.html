<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard pr√™teur priv√©</title>
  <style>
    :root{
      --bg:#0f0f12;
      --bg2:#18181c;
      --glass:rgba(255,255,255,.03);
      --glass2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --text:#f5f5f7;
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#f87171;
      --accent:#60a5fa;
      --purple:#a78bfa;
      --glow:0 0 40px rgba(96,165,250,.15);
      --shadow:0 4px 24px rgba(0,0,0,.4);
      --shadow2:0 8px 40px rgba(0,0,0,.5);
      --r:20px;
      --r2:24px;
      --r3:32px;
      --mono:'SF Mono', ui-monospace, Consolas, monospace;
      --sans:-apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:var(--sans);
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
      line-height:1.4;
      -webkit-font-smoothing:antialiased;
    }

    /* === LAYOUT === */
    .app{
      max-width:1400px;
      margin:0 auto;
      padding:16px;
      display:grid;
      gap:16px;
    }

    /* === TOP BAR - iPhone style === */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 20px;
      background:linear-gradient(180deg, rgba(255,255,255,.08) 0%, rgba(255,255,255,.04) 100%);
      border:1px solid var(--stroke2);
      border-radius:var(--r2);
      backdrop-filter:blur(20px);
      box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,.1);
    }
    .brand{display:flex;align-items:center;gap:14px}
    .logo{
      width:44px;height:44px;
      border-radius:14px;
      background:linear-gradient(135deg, var(--accent), var(--good));
      display:flex;align-items:center;justify-content:center;
      font-size:22px;
      box-shadow:0 4px 16px rgba(96,165,250,.3), inset 0 1px 0 rgba(255,255,255,.3);
    }
    .brand-text h1{font-size:17px;font-weight:600;letter-spacing:-.02em}
    .brand-text p{font-size:12px;color:var(--muted2);margin-top:2px}
    .status-pill{
      display:flex;align-items:center;gap:8px;
      padding:8px 14px;
      background:var(--glass2);
      border:1px solid var(--stroke2);
      border-radius:999px;
      font-size:12px;
      font-weight:500;
    }
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--good);box-shadow:0 0 8px var(--good)}
    .status-pill.demo .status-dot{background:var(--warn);box-shadow:0 0 8px var(--warn)}

    /* === KPI CARDS - Glossy pills === */
    .kpi-row{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:12px;
    }
    @media(max-width:900px){.kpi-row{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:500px){.kpi-row{grid-template-columns:1fr}}

    .kpi-card{
      position:relative;
      padding:16px 18px;
      background:linear-gradient(180deg, rgba(255,255,255,.07) 0%, rgba(255,255,255,.03) 100%);
      border:1px solid var(--stroke2);
      border-radius:var(--r2);
      backdrop-filter:blur(12px);
      box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,.08);
      overflow:hidden;
    }
    .kpi-card::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent);
    }
    .kpi-card .kpi-label{
      display:flex;align-items:center;justify-content:space-between;
      font-size:12px;color:var(--muted2);font-weight:500;
      text-transform:uppercase;letter-spacing:.04em;
    }
    .kpi-card .kpi-dot{width:8px;height:8px;border-radius:50%}
    .kpi-card .kpi-dot.good{background:var(--good);box-shadow:0 0 10px var(--good)}
    .kpi-card .kpi-dot.warn{background:var(--warn);box-shadow:0 0 10px var(--warn)}
    .kpi-card .kpi-dot.bad{background:var(--bad);box-shadow:0 0 10px var(--bad)}
    .kpi-card .kpi-value{
      margin-top:10px;
      font-size:26px;font-weight:700;
      font-family:var(--mono);
      letter-spacing:-.02em;
      display:flex;align-items:center;gap:10px;
    }
    .kpi-card .kpi-sub{margin-top:6px;font-size:11px;color:var(--muted2)}
    .kpi-btn{
      background:var(--warn);
      border:none;border-radius:8px;
      padding:6px 10px;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(251,191,36,.3);
      transition:transform .1s, box-shadow .1s;
    }
    .kpi-btn:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(251,191,36,.4)}

    /* === MAIN GRID === */
    .main-grid{
      display:grid;
      grid-template-columns:1fr 380px;
      gap:16px;
    }
    @media(max-width:1100px){.main-grid{grid-template-columns:1fr}}

    /* === PANEL - Glossy card === */
    .panel{
      background:linear-gradient(180deg, var(--glass2) 0%, var(--glass) 100%);
      border:1px solid var(--stroke);
      border-radius:var(--r2);
      backdrop-filter:blur(16px);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .panel-head{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:16px 20px;
      background:linear-gradient(180deg, rgba(255,255,255,.05) 0%, transparent 100%);
      border-bottom:1px solid var(--stroke);
    }
    .panel-head h2{font-size:15px;font-weight:600}
    .panel-head small{color:var(--muted2);font-size:11px;margin-top:2px}

    /* === ACTION BUTTONS - Pill style === */
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;gap:6px;
      padding:10px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,.1) 0%, rgba(255,255,255,.05) 100%);
      border:1px solid var(--stroke2);
      border-radius:14px;
      color:var(--text);
      font-size:12px;font-weight:500;
      cursor:pointer;
      transition:all .15s ease;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.1);
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.18)}
    .btn:active{transform:scale(.98)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(96,165,250,.4) 0%, rgba(96,165,250,.25) 100%);
      border-color:rgba(96,165,250,.5);
      box-shadow:0 2px 12px rgba(96,165,250,.2), inset 0 1px 0 rgba(255,255,255,.15);
    }
    .btn.danger{
      background:linear-gradient(180deg, rgba(248,113,113,.35) 0%, rgba(248,113,113,.2) 100%);
      border-color:rgba(248,113,113,.5);
    }
    .btn.good{
      background:linear-gradient(180deg, rgba(52,211,153,.35) 0%, rgba(52,211,153,.2) 100%);
      border-color:rgba(52,211,153,.5);
    }
    .btn.ghost{background:transparent;border-color:transparent;box-shadow:none}
    .btn.ghost:hover{background:var(--glass2)}
    .btn.disabled{opacity:.4;pointer-events:none}

    /* === TABLE === */
    .table-wrap{overflow-y:auto;overflow-x:hidden;padding:0;max-height:420px}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:11px;table-layout:fixed}
    th,td{padding:6px 4px;text-align:left;overflow:hidden;text-overflow:ellipsis}
    th{
      position:sticky;top:0;z-index:5;
      background:rgba(15,15,18,.95);
      backdrop-filter:blur(8px);
      color:var(--muted2);
      font-weight:600;font-size:11px;
      text-transform:uppercase;letter-spacing:.04em;
      border-bottom:1px solid var(--stroke);
    }
    td{border-bottom:1px solid rgba(255,255,255,.04)}
    tr:hover td{background:rgba(255,255,255,.03)}
    tr.selected td{background:rgba(96,165,250,.1)}
    .mono{font-family:var(--mono)}

    .status{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;
      background:var(--glass2);
      border:1px solid var(--stroke);
      border-radius:999px;
      font-size:10px;font-weight:500;
    }
    .dot{width:6px;height:6px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .table-footer{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 20px;
      background:var(--glass);
      border-top:1px solid var(--stroke);
      font-size:11px;color:var(--muted2);
    }
    .hint{padding:12px 20px;font-size:11px;color:var(--muted2);border-bottom:1px solid var(--stroke)}

    /* === RIGHT COLUMN === */
    .right-col{display:flex;flex-direction:column;gap:16px}

    /* === CLIENT CARD === */
    .client-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      padding:16px;
    }
    .client-item{
      padding:12px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:14px;
    }
    .client-item .k{font-size:10px;color:var(--muted2);text-transform:uppercase;letter-spacing:.04em}
    .client-item .v{margin-top:6px;font-size:13px;font-weight:600}

    /* === ARREARS BOX === */
    .section{padding:16px}
    .arrears-box{
      margin-top:12px;
      max-height:200px;
      overflow-y:auto;
    }
    .arrears-row{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:14px;
      margin-bottom:8px;
    }
    .arrears-row:hover{border-color:var(--stroke2)}
    .arrears-left{flex:1;min-width:0}
    .arrears-title{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:500}
    .arrears-calc{
      display:flex;align-items:center;gap:6px;
      margin-top:6px;
      font-family:var(--mono);font-size:12px;
    }
    .arrears-calc .item{color:var(--muted)}
    .arrears-calc .fee{color:var(--bad)}
    .arrears-calc .op{color:var(--muted2);font-size:10px}
    .arrears-calc .total{color:var(--text);font-weight:700;font-size:14px}
    .arrears-meta{margin-top:4px;font-size:10px;color:var(--muted2)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;
      background:rgba(248,113,113,.15);
      border:1px solid rgba(248,113,113,.25);
      border-radius:999px;
      font-size:10px;font-weight:500;
      color:var(--bad);
    }

    /* === EVENTS/NOTES === */
    .notes{display:flex;flex-direction:column;gap:8px;margin-top:12px;max-height:250px;overflow-y:auto}
    .note{
      padding:12px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:12px;
      border-left:3px solid var(--muted);
    }
    .note.note-report{border-left-color:var(--accent)}
    .note.note-nsf{border-left-color:var(--bad)}
    .note.note-paiement{border-left-color:var(--good)}
    .note.note-souffrance{border-left-color:var(--warn)}
    .note.note-client{border-left-color:var(--purple);background:rgba(167,139,250,.08)}
    .note .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .note .title{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:500}
    .note .time{font-size:10px;color:var(--muted2);font-family:var(--mono)}
    .note .txt{margin-top:6px;font-size:11px;color:var(--muted);line-height:1.5}

    /* === MODAL - iOS style === */
    .modalOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.7);
      backdrop-filter:blur(8px);
      display:none;align-items:center;justify-content:center;
      padding:20px;
      z-index:1000;
    }
    .modal{
      width:min(720px, 100%);
      background:linear-gradient(180deg, rgba(30,30,35,.98) 0%, rgba(24,24,28,.98) 100%);
      border:1px solid var(--stroke2);
      border-radius:var(--r3);
      box-shadow:0 40px 120px rgba(0,0,0,.6);
      backdrop-filter:blur(20px);
      overflow:hidden;
    }
    .modalHead{
      display:flex;justify-content:space-between;align-items:center;
      padding:16px 20px;
      background:linear-gradient(180deg, rgba(255,255,255,.06) 0%, transparent 100%);
      border-bottom:1px solid var(--stroke);
    }
    .modalHead h3{font-size:16px;font-weight:600}
    .modalBody{padding:20px;max-height:60vh;overflow-y:auto}
    .modalFoot{
      display:flex;justify-content:flex-end;gap:10px;
      padding:16px 20px;
      background:var(--glass);
      border-top:1px solid var(--stroke);
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:600px){.row{grid-template-columns:1fr}}

    .field{
      padding:14px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:16px;
    }
    .field label{display:block;font-size:11px;color:var(--muted2);margin-bottom:8px;text-transform:uppercase;letter-spacing:.04em}
    .field input, .field select{
      width:100%;
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke2);
      border-radius:10px;
      color:var(--text);
      padding:10px 12px;
      font-size:13px;
      outline:none;
      transition:border-color .15s;
    }
    .field input:focus, .field select:focus{border-color:var(--accent)}
    .field select option{background:#1e1e23;color:#fff}

    .summary{
      margin-top:16px;
      padding:14px;
      background:rgba(96,165,250,.08);
      border:1px solid rgba(96,165,250,.2);
      border-radius:14px;
      font-size:12px;color:var(--muted);
    }

    .listBox{
      margin-top:12px;
      padding:10px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:14px;
      max-height:180px;
      overflow-y:auto;
    }
    .chk{
      display:grid;grid-template-columns:20px 1fr auto;gap:10px;
      align-items:center;
      padding:10px 12px;
      background:rgba(255,255,255,.02);
      border:1px solid var(--stroke);
      border-radius:10px;
      margin-bottom:6px;
      cursor:pointer;
    }
    .chk:hover{background:rgba(255,255,255,.04)}
    .chk.selected{background:rgba(96,165,250,.1);border-color:rgba(96,165,250,.3)}
    .chk input{margin:0}
    .chk .info{min-width:0}
    .chk .t{font-size:12px;font-weight:500}
    .chk .m{font-size:10px;color:var(--muted2)}
    .chk .amounts{text-align:right;font-family:var(--mono);font-size:11px}
    .chk .current{color:var(--muted)}
    .chk .add{color:var(--good)}
    .chk .newtotal{color:var(--text);font-weight:600}

    .inlineInfo{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
      margin:12px 0;
      padding:12px;
      background:rgba(96,165,250,.08);
      border:1px solid rgba(96,165,250,.2);
      border-radius:12px;
    }
    .inlineInfo .label{font-size:10px;color:var(--muted2);text-transform:uppercase}
    .inlineInfo .value{font-family:var(--mono);font-weight:600;margin-top:4px}

    .nsfCalc{
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:14px;
      overflow:hidden;
    }
    .nsfRow{
      display:grid;grid-template-columns:120px 1fr auto;gap:12px;
      padding:14px 16px;
      align-items:center;
      border-bottom:1px solid var(--stroke);
    }
    .nsfRow:last-child{border-bottom:none}
    .nsfRow.add{background:rgba(248,113,113,.08)}
    .nsfRow.total{background:rgba(248,113,113,.15)}
    .nsfLabel{font-size:12px;color:var(--muted2)}
    .nsfLine{font-size:12px;color:var(--muted)}
    .nsfAmount{font-family:var(--mono);font-size:14px;font-weight:600;text-align:right}
    .nsfRow.add .nsfAmount{color:var(--bad)}
    .nsfRow.total .nsfAmount{font-size:18px}

    /* === KV Grid (fiche client) === */
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kv .item{
      padding:12px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:14px;
    }
    .kv .k{font-size:10px;color:var(--muted2);text-transform:uppercase;letter-spacing:.04em}
    .kv .v{margin-top:6px;font-size:13px;font-weight:600}

    /* Arrears list style */
    .arrearsBox{margin-top:12px;max-height:200px;overflow-y:auto}
    .arrearsRow{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:14px;
      margin-bottom:8px;
    }
    .arrearsLeft{flex:1}
    .arrearsTitle{display:flex;align-items:center;gap:8px;font-size:12px}
    .arrearsCalc{display:flex;align-items:center;gap:6px;margin:6px 0 4px;font-family:var(--mono);font-size:12px}
    .arrearsCalc .calcItem{color:var(--muted)}
    .arrearsCalc .calcItem.fee{color:var(--bad)}
    .arrearsCalc .calcOp{color:var(--muted2);font-size:10px}
    .arrearsCalc .calcTotal{color:var(--text);font-weight:700;font-size:14px}
    .arrearsMeta{font-size:10px;color:var(--muted2)}

    /* scrollbar */
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:3px}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}

    /* === FLIP CARD === */
    .flip-container{
      perspective:1000px;
      cursor:pointer;
    }
    .flip-card{
      position:relative;
      width:100%;
      transition:transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
      transform-style:preserve-3d;
    }
    .flip-container.flipped .flip-card{
      transform:rotateY(180deg);
    }
    .flip-front, .flip-back{
      backface-visibility:hidden;
      -webkit-backface-visibility:hidden;
    }
    .flip-front{
      position:relative;
    }
    .flip-back{
      position:absolute;
      top:0;left:0;right:0;
      transform:rotateY(180deg);
      background:linear-gradient(180deg, var(--glass2) 0%, var(--glass) 100%);
      border-radius:var(--r2);
      min-height:100%;
    }
    .flip-hint{
      position:absolute;
      bottom:8px;right:12px;
      font-size:10px;
      color:var(--muted2);
      display:flex;align-items:center;gap:4px;
      opacity:0.7;
      transition:opacity .2s;
    }
    .flip-container:hover .flip-hint{opacity:1}
  </style>
</head>

<body>
  <div class="app">
    <!-- TOP BAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">üíº</div>
        <div class="brand-text">
          <h1>Dashboard Pr√™teur</h1>
          <p>Gestion simplifi√©e</p>
        </div>
      </div>

      <!-- SEARCH BAR -->
      <div class="search-box" style="flex:1;max-width:450px;position:relative">
        <div style="display:flex;align-items:center;gap:10px;padding:10px 16px;background:var(--glass2);border:1px solid var(--stroke2);border-radius:14px;transition:all .2s" id="searchContainer">
          <span style="font-size:16px">üîç</span>
          <input type="text" id="clientSearch" placeholder="Rechercher un client (nom, #, t√©l√©phone, courriel...)"
            style="flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:13px"
            oninput="searchClients(this.value)"
            onfocus="document.getElementById('searchContainer').style.borderColor='var(--accent)'"
            onblur="setTimeout(()=>{document.getElementById('searchContainer').style.borderColor='var(--stroke2)';document.getElementById('searchResults').style.display='none'},200)"
          />
          <kbd style="padding:3px 8px;background:var(--glass);border:1px solid var(--stroke);border-radius:6px;font-size:10px;color:var(--muted2)">ESC</kbd>
        </div>
        <!-- Search Results Dropdown -->
        <div id="searchResults" style="display:none;position:absolute;top:100%;left:0;right:0;margin-top:8px;background:rgba(24,24,28,.98);border:1px solid var(--stroke2);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5);max-height:320px;overflow-y:auto;z-index:100"></div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <div class="status-pill"><span class="status-dot"></span> Connect√©</div>
        <div class="status-pill demo"><span class="status-dot"></span> Mode D√©mo</div>
      </div>
    </div>

    <!-- KPI ROW -->
    <div class="kpi-row" id="kpi"></div>

    <!-- MAIN GRID -->
    <div class="main-grid">
      <!-- LEFT: Payment Calendar -->
      <div class="panel">
        <div class="panel-head">
          <div>
            <h2>Calendrier des paiements</h2>
            <small id="subHeader">26 paiements ¬∑ 14 jours ¬∑ Adh√©sion 45,00$</small>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="openAction('report')">üìÖ Reporter</button>
            <button class="btn" onclick="openAction('capital')">üí∞ Capital</button>
            <button class="btn" onclick="openAction('manual')">üíµ Manuel</button>
            <button class="btn" onclick="openAction('entente')">üìã Entente</button>
            <button class="btn danger" onclick="openAction('nsf')">‚ùå NSF</button>
            <button class="btn ghost" onclick="resetDemo()">‚Ü©Ô∏è</button>
          </div>
        </div>

        <div class="hint">S√©lectionner une ligne pour agir dessus</div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:30px">#</th>
                <th style="width:85px">Date</th>
                <th style="width:95px">Type</th>
                <th style="width:60px">Total</th>
                <th style="width:55px">Pr√™t</th>
                <th style="width:55px">Int.</th>
                <th style="width:55px">Cap.</th>
                <th style="width:55px">Adh.</th>
                <th style="width:50px">NSF</th>
                <th style="width:50px">Ajust</th>
                <th style="width:70px">Statut</th>
                <th style="width:60px">Avant</th>
                <th style="width:60px">Apr√®s</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div class="table-footer">
          <div>Taux nominal <span class="mono">18.99%</span> ¬∑ Fr√©quence 7 ou 14 jours</div>
          <div class="mono" id="selectedInfo">S√©lection: #1</div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="right-col">
        <!-- Client Card - Flip -->
        <div class="panel flip-container" onclick="this.classList.toggle('flipped')">
          <div class="flip-card">
            <!-- FRONT - Info client -->
            <div class="flip-front">
              <div class="panel-head">
                <div>
                  <h2>Fiche client</h2>
                  <small>#10023</small>
                </div>
                <div class="status-pill"><span class="status-dot"></span> Actif</div>
              </div>
              <div class="client-grid">
                <div class="client-item">
                  <div class="k">Pr√©nom</div>
                  <div class="v">Marc</div>
                </div>
                <div class="client-item">
                  <div class="k">Nom</div>
                  <div class="v">Savoie</div>
                </div>
                <div class="client-item">
                  <div class="k">Adresse</div>
                  <div class="v" style="font-size:11px">123 Rue Principale</div>
                </div>
                <div class="client-item">
                  <div class="k">App</div>
                  <div class="v">4B</div>
                </div>
                <div class="client-item">
                  <div class="k">Ville</div>
                  <div class="v">Montr√©al</div>
                </div>
                <div class="client-item">
                  <div class="k">Prov/√âtat</div>
                  <div class="v">QC</div>
                </div>
                <div class="client-item">
                  <div class="k">Code postal</div>
                  <div class="v mono">H2X 1Y4</div>
                </div>
                <div class="client-item">
                  <div class="k">Date naissance</div>
                  <div class="v mono">1985-03-22</div>
                </div>
                <div class="client-item">
                  <div class="k">Num√©ro 1</div>
                  <div class="v mono">514-555-1234</div>
                </div>
                <div class="client-item">
                  <div class="k">Num√©ro 2</div>
                  <div class="v mono">438-555-9876</div>
                </div>
                <div class="client-item" style="grid-column:span 2">
                  <div class="k">Courriel</div>
                  <div class="v">marc.savoie@email.com</div>
                </div>
              </div>
              <div class="flip-hint">üîÑ Infos pr√™t & banque</div>
            </div>
            <!-- BACK - Info pr√™t & bancaire -->
            <div class="flip-back">
              <div class="panel-head">
                <div>
                  <h2>Pr√™t & Banque</h2>
                  <small>Marc Savoie #10023</small>
                </div>
                <div class="status-pill"><span class="status-dot"></span> PAD Actif</div>
              </div>
              <div class="client-grid">
                <div class="client-item">
                  <div class="k">Produit</div>
                  <div class="v">Marge de cr√©dit</div>
                </div>
                <div class="client-item">
                  <div class="k">Montant pr√™t</div>
                  <div class="v mono">
                    <input type="number" id="loanAmount" value="2000" step="0.01"
                      style="width:90px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:13px;font-family:var(--mono);text-align:right"
                      oninput="updateTotalFinanced()" onclick="event.stopPropagation()"/> $
                  </div>
                </div>
                <div class="client-item">
                  <div class="k">Frais ouverture</div>
                  <div class="v mono">
                    <input type="number" id="openingFees" value="250" step="0.01"
                      style="width:90px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:13px;font-family:var(--mono);text-align:right"
                      oninput="updateTotalFinanced()" onclick="event.stopPropagation()"/> $
                  </div>
                </div>
                <div class="client-item">
                  <div class="k">Montant financ√©</div>
                  <div class="v mono" id="totalFinanced">2 250,00 $</div>
                </div>
                <div class="client-item">
                  <div class="k">Date origine</div>
                  <div class="v mono">
                    <input type="date" id="originDate" value="2024-11-07"
                      style="width:120px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:12px"
                      onclick="event.stopPropagation()"/>
                  </div>
                </div>
                <div class="client-item">
                  <div class="k">1er paiement</div>
                  <div class="v mono">
                    <input type="date" id="firstPaymentDate" value="2024-11-15"
                      style="width:120px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:12px"
                      onclick="event.stopPropagation()"/>
                  </div>
                </div>
                <div class="client-item">
                  <div class="k">Nb paiements</div>
                  <div class="v mono">
                    <input type="number" id="numPayments" value="26" min="1" max="104"
                      style="width:60px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:13px;font-family:var(--mono);text-align:right"
                      onclick="event.stopPropagation()"/>
                  </div>
                </div>
                <div class="client-item">
                  <div class="k">Paiement souhait√©</div>
                  <div class="v mono">
                    <input type="number" id="desiredPayment" value="147" step="0.01" min="1"
                      style="width:70px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:13px;font-family:var(--mono);text-align:right"
                      onclick="event.stopPropagation()"/> $
                  </div>
                </div>
                <div class="client-item">
                  <div class="k">Taux int√©r√™t</div>
                  <div class="v mono">
                    <input type="number" id="interestRate" value="18.99" step="0.01" min="0" max="100"
                      style="width:70px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:13px;font-family:var(--mono);text-align:right"
                      onclick="event.stopPropagation()"/> %
                  </div>
                </div>
                <div class="client-item">
                  <div class="k">Type taux</div>
                  <div class="v">
                    <select id="rateType" style="background:#1a1a2e;border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:12px" onclick="event.stopPropagation()">
                      <option value="annual" style="background:#1a1a2e;color:#fff">Annuel</option>
                      <option value="monthly" style="background:#1a1a2e;color:#fff">Mensuel</option>
                      <option value="periodic" style="background:#1a1a2e;color:#fff">Par p√©riode</option>
                    </select>
                  </div>
                </div>
                <div class="client-item">
                  <div class="k">Fr√©quence</div>
                  <div class="v">
                    <select id="paymentFrequency" style="background:#1a1a2e;border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:12px" onclick="event.stopPropagation()">
                      <option value="7" style="background:#1a1a2e;color:#fff">7 jours</option>
                      <option value="14" selected style="background:#1a1a2e;color:#fff">14 jours</option>
                    </select>
                  </div>
                </div>
                <div class="client-item" style="grid-column:span 2">
                  <button class="btn primary" onclick="updateLoanAmount();event.stopPropagation()" style="width:100%;justify-content:center">
                    üîÑ G√©n√©rer nouveau plan
                  </button>
                </div>
                <div class="client-item" style="grid-column:span 2">
                  <button class="btn" onclick="restoreLoanBackup();event.stopPropagation()" style="width:100%;justify-content:center">
                    ‚Ü©Ô∏è Restaurer plan pr√©c√©dent
                  </button>
                </div>
                <div class="client-item">
                  <div class="k">Institution</div>
                  <div class="v">Desjardins</div>
                </div>
                <div class="client-item">
                  <div class="k">Transit</div>
                  <div class="v mono">81520</div>
                </div>
                <div class="client-item">
                  <div class="k">Folio</div>
                  <div class="v mono">0648291</div>
                </div>
                <div class="client-item">
                  <div class="k">Compte</div>
                  <div class="v mono">7234851</div>
                </div>
              </div>
              <div class="flip-hint">üîÑ Retour fiche client</div>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="panel">
          <div class="panel-head">
            <div>
              <h2>Notes</h2>
              <small>Cliquer pour modifier</small>
            </div>
          </div>

          <div class="section">
            <div class="arrearsBox" id="arrearsList"></div>
            <div class="notes" id="events"></div>
            <div id="rightArrears" style="display:none">0,00 $</div>
            <div id="rightNext" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <h3 id="modalTitle">Action</h3>
        <button class="btn" onclick="closeModal()">‚úï Fermer</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

<script>
  // ===== Utilities
  const money = (n) => (Number(n||0)).toLocaleString('fr-CA',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' $';
  const fmtDate = (iso) => new Date(iso+'T00:00:00').toLocaleDateString('fr-CA',{day:'2-digit',month:'short',year:'numeric'}).replace('.','');
  const clamp2 = (n) => Math.round((Number(n)||0)*100)/100;

  // ===== Base de donn√©es clients (d√©mo)
  const clientsDB = [
    {id:'10023', prenom:'Marc', nom:'Savoie', tel1:'514-555-1234', tel2:'438-555-9876', courriel:'marc.savoie@email.com', ville:'Montr√©al', solde:2156.70, statut:'actif'},
    {id:'10024', prenom:'Julie', nom:'Tremblay', tel1:'514-555-2345', tel2:'', courriel:'julie.tremblay@gmail.com', ville:'Laval', solde:1850.00, statut:'actif'},
    {id:'10025', prenom:'Pierre', nom:'Gagnon', tel1:'450-555-3456', tel2:'514-555-4567', courriel:'pgagnon@outlook.com', ville:'Longueuil', solde:3200.50, statut:'actif'},
    {id:'10026', prenom:'Marie', nom:'Bouchard', tel1:'438-555-5678', tel2:'', courriel:'marie.b@hotmail.com', ville:'Qu√©bec', solde:0, statut:'ferm√©'},
    {id:'10027', prenom:'Jean', nom:'Lavoie', tel1:'514-555-6789', tel2:'', courriel:'jlavoie@gmail.com', ville:'Gatineau', solde:4500.00, statut:'souffrance'},
    {id:'10028', prenom:'Sophie', nom:'Martin', tel1:'450-555-7890', tel2:'438-555-8901', courriel:'sophie.martin@yahoo.com', ville:'Sherbrooke', solde:1200.00, statut:'actif'},
    {id:'10029', prenom:'Fran√ßois', nom:'Roy', tel1:'514-555-9012', tel2:'', courriel:'froy@videotron.ca', ville:'Trois-Rivi√®res', solde:2800.00, statut:'actif'},
    {id:'10030', prenom:'Isabelle', nom:'C√¥t√©', tel1:'438-555-0123', tel2:'514-555-1234', courriel:'isabelle.cote@gmail.com', ville:'Montr√©al', solde:950.00, statut:'actif'},
    {id:'10031', prenom:'Michel', nom:'B√©langer', tel1:'450-555-2345', tel2:'', courriel:'mbelanger@bell.net', ville:'Laval', solde:0, statut:'ferm√©'},
    {id:'10032', prenom:'Catherine', nom:'Fortin', tel1:'514-555-3456', tel2:'', courriel:'cfortin@outlook.com', ville:'Brossard', solde:1750.25, statut:'actif'},
  ];

  // ===== Recherche clients
  function searchClients(query){
    const results = document.getElementById('searchResults');
    if(!query || query.length < 2){
      results.style.display = 'none';
      return;
    }

    const q = query.toLowerCase();
    const matches = clientsDB.filter(c =>
      c.id.includes(q) ||
      c.prenom.toLowerCase().includes(q) ||
      c.nom.toLowerCase().includes(q) ||
      (c.prenom + ' ' + c.nom).toLowerCase().includes(q) ||
      (c.nom + ' ' + c.prenom).toLowerCase().includes(q) ||
      c.tel1.includes(q) ||
      c.tel2.includes(q) ||
      c.courriel.toLowerCase().includes(q) ||
      c.ville.toLowerCase().includes(q)
    ).slice(0, 8);

    if(matches.length === 0){
      results.innerHTML = `<div style="padding:16px;text-align:center;color:var(--muted2)">Aucun client trouv√©</div>`;
    } else {
      results.innerHTML = matches.map(c => {
        const statutColor = c.statut === 'actif' ? 'var(--good)' : c.statut === 'souffrance' ? 'var(--bad)' : 'var(--muted2)';
        const statutLabel = c.statut === 'actif' ? 'Actif' : c.statut === 'souffrance' ? 'Souffrance' : 'Ferm√©';
        return `
          <div onclick="selectClient('${c.id}')" style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;border-bottom:1px solid var(--stroke);cursor:pointer;transition:background .15s" onmouseover="this.style.background='rgba(255,255,255,.05)'" onmouseout="this.style.background=''">
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;font-size:14px">${c.prenom} ${c.nom}</div>
              <div style="font-size:11px;color:var(--muted2);margin-top:2px">#${c.id} ¬∑ ${c.tel1} ¬∑ ${c.ville}</div>
            </div>
            <div style="text-align:right">
              <div style="font-family:var(--mono);font-size:13px;font-weight:600">${money(c.solde)}</div>
              <div style="display:flex;align-items:center;gap:4px;justify-content:flex-end;margin-top:2px">
                <span style="width:6px;height:6px;border-radius:50%;background:${statutColor}"></span>
                <span style="font-size:10px;color:var(--muted2)">${statutLabel}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    results.style.display = 'block';
  }

  function selectClient(clientId){
    const client = clientsDB.find(c => c.id === clientId);
    if(!client) return;

    // Fermer la recherche
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('clientSearch').value = '';

    // Afficher un message (en production, chargerait le dossier du client)
    alert(`Chargement du dossier de ${client.prenom} ${client.nom} (#${client.id})\n\nEn production, ceci chargerait les donn√©es du client depuis la base de donn√©es.`);
  }

  // Fermer avec ESC
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('clientSearch').value = '';
      document.getElementById('clientSearch').blur();
    }
  });

  // ===== Sauvegarde avant modification du pr√™t
  let backupBeforeLoanChange = null;

  // ===== Mettre √† jour le montant financ√© en temps r√©el
  function updateTotalFinanced(){
    const loanAmt = Number(document.getElementById('loanAmount').value) || 0;
    const fees = Number(document.getElementById('openingFees').value) || 0;
    const total = loanAmt + fees;
    document.getElementById('totalFinanced').textContent = money(total);
  }

  // ===== Modifier montant du pr√™t et g√©n√©rer nouveau calendrier
  function updateLoanAmount(){
    const loanAmt = Number(document.getElementById('loanAmount').value) || 0;
    const fees = Number(document.getElementById('openingFees').value) || 0;
    const total = loanAmt + fees;
    const numPay = parseInt(document.getElementById('numPayments').value) || 26;
    const rate = parseFloat(document.getElementById('interestRate').value) || 18.99;
    const freq = parseInt(document.getElementById('paymentFrequency').value) || 14;

    if(total <= 0){
      alert('Le montant doit √™tre sup√©rieur √† 0');
      return;
    }

    if(numPay <= 0){
      alert('Le nombre de paiements doit √™tre sup√©rieur √† 0');
      return;
    }

    // Sauvegarder l'√©tat actuel avant modification
    backupBeforeLoanChange = {
      schedule: JSON.parse(JSON.stringify(state.schedule)),
      initialBalance: loanConfig.initialBalance,
      events: JSON.parse(JSON.stringify(state.events)),
      arrearsItems: JSON.parse(JSON.stringify(state.arrearsItems))
    };

    // Mettre √† jour l'affichage
    document.getElementById('totalFinanced').textContent = money(total);

    // Mettre √† jour la config du pr√™t
    loanConfig.initialBalance = total;

    // G√©n√©rer un nouveau calendrier de paiements
    generateNewPaymentSchedule(total);

    logEvent('üîÑ Nouveau plan g√©n√©r√©', `${money(total)} ¬∑ ${numPay} paiements ¬∑ ${rate}% ¬∑ ${freq}j ‚Äî Sauvegarde cr√©√©e`);
  }

  // ===== G√©n√©rer nouveau calendrier bas√© sur les param√®tres
  function generateNewPaymentSchedule(totalFinanced){
    // Lire les param√®tres du formulaire
    const numPayments = parseInt(document.getElementById('numPayments').value) || 26;
    const nominalRate = (parseFloat(document.getElementById('interestRate').value) || 18.99) / 100;
    const frequency = parseInt(document.getElementById('paymentFrequency').value) || 14;
    const originDate = document.getElementById('originDate').value || '2024-11-07';
    const firstPaymentDate = document.getElementById('firstPaymentDate').value || '2024-11-15';
    const rateType = document.getElementById('rateType')?.value || 'annual';

    // Adh√©sion selon fr√©quence
    const adhesionFee = frequency === 7 ? 22.50 : 45.00;

    // Calculer le taux quotidien selon le type de taux
    let dailyRate;
    if(rateType === 'periodic'){
      // Taux par p√©riode - convertir en taux quotidien
      dailyRate = nominalRate / frequency;
    } else if(rateType === 'monthly'){
      // Taux mensuel - convertir en taux quotidien
      dailyRate = nominalRate / 30;
    } else {
      // Taux annuel avec ajustement Margill (2.8%)
      const effectiveRate = nominalRate * 1.028;
      dailyRate = effectiveRate / 365;
    }

    // Mettre √† jour la config
    loanConfig.originDate = originDate;
    loanConfig.initialBalance = totalFinanced;
    loanConfig.nominalRate = nominalRate;
    loanConfig.effectiveRate = dailyRate * 365;

    // Calculer jours entre origine et premier paiement
    const originD = new Date(originDate + 'T00:00:00');
    const firstD = new Date(firstPaymentDate + 'T00:00:00');
    const daysToFirst = Math.max(1, Math.round((firstD - originD) / (1000 * 60 * 60 * 24)));

    const newSchedule = [];
    let principalBalance = totalFinanced; // Capital restant √† payer
    let currentDate = new Date(firstPaymentDate + 'T00:00:00');

    for(let i = 1; i <= numPayments; i++){
      // Date du paiement
      let dateStr;
      let daysForInterest;

      if(i === 1){
        dateStr = firstPaymentDate;
        daysForInterest = daysToFirst;
      } else {
        currentDate.setDate(currentDate.getDate() + frequency);
        dateStr = currentDate.toISOString().split('T')[0];
        daysForInterest = frequency;
      }

      // Calculer l'int√©r√™t sur le solde principal actuel
      const interest = clamp2(principalBalance * dailyRate * daysForInterest);

      // Solde avec int√©r√™ts = ce qu'on doit au moment du paiement (AVANT de payer)
      const balanceWithInterest = clamp2(principalBalance + interest);

      // Capital pour ce paiement
      let capital;
      if(i === numPayments){
        // Dernier paiement: payer tout le reste du capital
        capital = principalBalance;
      } else {
        // Capital = portion du principal total
        capital = clamp2(totalFinanced / numPayments);
      }

      // Total = Capital + Int√©r√™t + Adh√©sion
      const loanPart = clamp2(capital + interest);
      const payment = clamp2(loanPart + adhesionFee);

      // Nouveau solde principal = ancien solde - capital pay√©
      const newPrincipalBalance = Math.max(0, clamp2(principalBalance - capital));

      newSchedule.push({
        i: i,
        date: dateStr,
        total: payment,
        interest: interest,
        adhesion: adhesionFee,
        balance: balanceWithInterest, // Solde AVEC int√©r√™ts accumul√©s
        balanceBefore: principalBalance,
        principalAfter: newPrincipalBalance,
        status: '√Ä venir',
        adjustment: 0,
        paid: false,
        method: 'A_VENIR',
        ententeApplied: false,
        nsfReportFee: 0
      });

      principalBalance = newPrincipalBalance;
    }

    state.schedule = newSchedule;

    // Mettre √† jour le sous-header
    const totalInterest = clamp2(newSchedule.reduce((sum, r) => sum + r.interest, 0));
    document.getElementById('subHeader').textContent = `${numPayments} paiements ¬∑ ${frequency}j ¬∑ Adh ${money(adhesionFee)} ¬∑ Int. total: ${money(totalInterest)}`;

    renderAll();
  }

  // ===== Restaurer la sauvegarde
  function restoreLoanBackup(){
    if(!backupBeforeLoanChange){
      alert('Aucune sauvegarde disponible');
      return;
    }

    state.schedule = backupBeforeLoanChange.schedule;
    state.events = backupBeforeLoanChange.events;
    state.arrearsItems = backupBeforeLoanChange.arrearsItems;
    loanConfig.initialBalance = backupBeforeLoanChange.initialBalance;

    // Restaurer les champs
    document.getElementById('loanAmount').value = (backupBeforeLoanChange.initialBalance - 250).toFixed(0);
    document.getElementById('openingFees').value = '250';
    document.getElementById('totalFinanced').textContent = money(backupBeforeLoanChange.initialBalance);

    backupBeforeLoanChange = null;

    renderAll();
    logEvent('‚Ü©Ô∏è Restauration', 'Calendrier restaur√© √† la version pr√©c√©dente');
  }

  // ===== "V√©rit√©" calendrier (d√©mo)
  const originalSchedule = [
    {i:1,  date:'2024-11-15', total:147.92, interest:  9.62, adhesion:45.00, balance:2156.70},
    {i:2,  date:'2024-11-29', total:147.19, interest: 16.15, adhesion:45.00, balance:2070.66},
    {i:3,  date:'2024-12-13', total:146.56, interest: 15.51, adhesion:45.00, balance:1984.61},
    {i:4,  date:'2024-12-27', total:145.94, interest: 14.87, adhesion:45.00, balance:1898.54},
    {i:5,  date:'2025-01-10', total:145.31, interest: 14.22, adhesion:45.00, balance:1812.45},
    {i:6,  date:'2025-01-24', total:144.72, interest: 13.61, adhesion:45.00, balance:1726.34},
    {i:7,  date:'2025-02-07', total:144.09, interest: 12.97, adhesion:45.00, balance:1640.22},
    {i:8,  date:'2025-02-21', total:143.47, interest: 12.32, adhesion:45.00, balance:1554.07},
    {i:9,  date:'2025-03-07', total:142.84, interest: 11.67, adhesion:45.00, balance:1467.90},
    {i:10, date:'2025-03-21', total:142.21, interest: 11.03, adhesion:45.00, balance:1381.72},
    {i:11, date:'2025-04-04', total:141.58, interest: 10.38, adhesion:45.00, balance:1295.52},
    {i:12, date:'2025-04-18', total:140.95, interest:  9.73, adhesion:45.00, balance:1209.30},
    {i:13, date:'2025-05-02', total:140.33, interest:  9.08, adhesion:45.00, balance:1123.05},
    {i:14, date:'2025-05-16', total:139.70, interest:  8.44, adhesion:45.00, balance:1036.79},
    {i:15, date:'2025-05-30', total:139.07, interest:  7.79, adhesion:45.00, balance: 950.51},
    {i:16, date:'2025-06-13', total:138.44, interest:  7.14, adhesion:45.00, balance: 864.21},
    {i:17, date:'2025-06-27', total:137.82, interest:  6.49, adhesion:45.00, balance: 777.88},
    {i:18, date:'2025-07-11', total:137.19, interest:  5.84, adhesion:45.00, balance: 691.53},
    {i:19, date:'2025-07-25', total:136.56, interest:  5.19, adhesion:45.00, balance: 605.16},
    {i:20, date:'2025-08-08', total:135.93, interest:  4.55, adhesion:45.00, balance: 518.78},
    {i:21, date:'2025-08-22', total:135.31, interest:  3.90, adhesion:45.00, balance: 432.37},
    {i:22, date:'2025-09-05', total:134.68, interest:  3.25, adhesion:45.00, balance: 345.94},
    {i:23, date:'2025-09-19', total:134.05, interest:  2.60, adhesion:45.00, balance: 259.49},
    {i:24, date:'2025-10-03', total:133.42, interest:  1.95, adhesion:45.00, balance: 173.02},
    {i:25, date:'2025-10-17', total:132.80, interest:  1.30, adhesion:45.00, balance:  86.52},
    {i:26, date:'2025-10-26', total:132.17, interest:  0.42, adhesion:45.00, balance:   0.00},
  ];

  // ===== Calcul frequence de paiement (7j = hebdo, 14j = aux 2 semaines)
  function getPaymentFrequency(){
    const dates = originalSchedule.map(r => new Date(r.date + 'T00:00:00')).sort((a,b) => a-b);
    if(dates.length < 2) return 14;
    const diff = Math.round((dates[1] - dates[0]) / (1000 * 60 * 60 * 24));
    return diff <= 10 ? 7 : 14;
  }
  function getAdhesionFee(){ return getPaymentFrequency() === 7 ? 22.50 : 45.00; }

  // ===== Configuration du pr√™t (valeurs Margill)
  const loanConfig = {
    initialBalance: 2250.00,    // Solde initial du pr√™t
    originDate: '2024-11-07',   // Date d'origine du pr√™t
    nominalRate: 0.1899,        // Taux nominal 18.99%
    effectiveRate: 0.1952       // Taux effectif 19.52% (d√©riv√© de Margill)
  };

  // ===== Calcul des jours entre deux dates
  function daysBetween(date1, date2){
    const d1 = new Date(date1 + 'T00:00:00');
    const d2 = new Date(date2 + 'T00:00:00');
    return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
  }

  // ===== Recalcul des soldes et int√©r√™ts apr√®s modifications (style Margill)
  // R√©partition √©gale du surplus d'int√©r√™t sur toutes les lignes futures
  function recalculateBalancesAndInterest(){
    const dailyRate = loanConfig.effectiveRate / 365;
    const adhesionFee = getAdhesionFee();

    // Trier par date
    const ordered = [...state.schedule].sort((a,b) => a.date.localeCompare(b.date));

    // V√©rifier s'il y a des modifications
    let hasModifications = false;
    for(let i = 0; i < ordered.length; i++){
      const row = ordered[i];
      const orig = originalSchedule.find(o => o.i === row.i);
      if((row.adjustment || 0) !== 0 || row.status === 'NSF' || row.status === 'Frais report' || !orig || row.ententeApplied){
        hasModifications = true;
        break;
      }
    }

    // Si aucune modification, garder les valeurs Margill originales
    if(!hasModifications){
      let prevBal = loanConfig.initialBalance;
      ordered.forEach((row) => {
        const orig = originalSchedule.find(o => o.i === row.i);
        row.balanceBefore = clamp2(prevBal);
        if(orig){
          row.interest = orig.interest;
          row.balance = orig.balance;
          row.total = orig.total;
          row.adhesion = orig.adhesion;
          prevBal = orig.balance;
        }
      });
      state.schedule = ordered;
      return;
    }

    // ===== R√âPARTITION √âGALE STYLE MARGILL =====

    // √âtape 1: Identifier les lignes √† redistribuer
    // (lignes normales sans ajustement, qui vont recevoir le nouveau montant)
    const linesToRedistribute = [];
    const linesWithAdjustment = [];
    const specialLines = []; // NSF, Frais report

    for(let i = 0; i < ordered.length; i++){
      const row = ordered[i];
      if(row.status === 'NSF' || row.status === 'Frais report'){
        specialLines.push({idx: i, row: row});
      } else if((row.adjustment || 0) !== 0 || row.ententeApplied){
        // Lignes avec ajustement OU entente appliqu√©e: garder leur total
        linesWithAdjustment.push({idx: i, row: row});
      } else {
        linesToRedistribute.push({idx: i, row: row});
      }
    }

    // √âtape 2: Calculer avec les montants actuels pour trouver le d√©ficit/surplus
    let tempBalance = loanConfig.initialBalance;
    let prevDate = loanConfig.originDate;

    for(let i = 0; i < ordered.length; i++){
      const row = ordered[i];
      const orig = originalSchedule.find(o => o.i === row.i);
      const days = Math.max(1, daysBetween(prevDate, row.date));

      if(row.status === 'Frais report'){
        prevDate = row.date;
        continue;
      }
      if(row.status === 'NSF'){
        prevDate = row.date;
        continue;
      }

      // Calculer l'int√©r√™t sur le solde actuel
      const interest = clamp2(tempBalance * dailyRate * days);

      // Total collect√© - utiliser le montant entente si applicable
      let totalCollect;
      if(row.ententeApplied){
        totalCollect = row.total || 0;
      } else {
        const baseTotal = orig ? orig.total : (row.total || 0);
        totalCollect = clamp2(baseTotal + (row.adjustment || 0));
      }

      const adhesion = row.adhesion || (orig ? orig.adhesion : adhesionFee);
      const loanPart = clamp2(totalCollect - adhesion);
      const capitalPaid = Math.max(0, clamp2(loanPart - interest));
      tempBalance = clamp2(tempBalance - capitalPaid);

      prevDate = row.date;
    }

    // tempBalance = montant restant (positif = manque √† payer, n√©gatif = trop pay√©)
    const deficit = tempBalance;

    // √âtape 3: R√©partir le d√©ficit sur les lignes √† redistribuer
    const numLines = linesToRedistribute.length;
    const adjustmentPerLine = numLines > 0 ? clamp2(deficit / numLines) : 0;

    // √âtape 4: Appliquer les nouveaux montants et recalculer
    let runningBalance = loanConfig.initialBalance;
    prevDate = loanConfig.originDate;

    for(let i = 0; i < ordered.length; i++){
      const row = ordered[i];
      const orig = originalSchedule.find(o => o.i === row.i);
      const days = Math.max(1, daysBetween(prevDate, row.date));

      row.balanceBefore = clamp2(runningBalance);

      // Frais report: pas d'impact sur le pr√™t
      if(row.status === 'Frais report'){
        row.interest = 0;
        row.balance = clamp2(runningBalance);
        prevDate = row.date;
        continue;
      }

      // NSF: int√©r√™t calcul√© mais solde ne bouge pas
      if(row.status === 'NSF'){
        row.interest = clamp2(runningBalance * dailyRate * days);
        row.balance = clamp2(runningBalance);
        prevDate = row.date;
        continue;
      }

      // Calculer l'int√©r√™t
      row.interest = clamp2(runningBalance * dailyRate * days);

      // D√©terminer le total pour cette ligne
      const hasAdj = (row.adjustment || 0) !== 0;
      const hasEntente = row.ententeApplied === true;
      const baseTotal = orig ? orig.total : (row.total || 0);
      const adhesion = row.adhesion || (orig ? orig.adhesion : adhesionFee);
      row.adhesion = adhesion;

      if(hasEntente){
        // Ligne avec entente: garder le total fix√© par l'entente
        const totalCollect = row.total || 0;
        const loanPart = clamp2(totalCollect - adhesion);
        const capitalPaid = Math.max(0, clamp2(loanPart - row.interest));
        runningBalance = clamp2(runningBalance - capitalPaid);
      } else if(hasAdj){
        // Ligne avec ajustement: garder total original + ajustement
        row.total = baseTotal;
        const totalCollect = clamp2(baseTotal + row.adjustment);
        const loanPart = clamp2(totalCollect - adhesion);
        const capitalPaid = Math.max(0, clamp2(loanPart - row.interest));
        runningBalance = clamp2(runningBalance - capitalPaid);
      } else {
        // Ligne √† redistribuer: ajouter sa part du d√©ficit
        const newLoanPart = clamp2((baseTotal - adhesion) + adjustmentPerLine);
        row.total = clamp2(newLoanPart + adhesion);
        const capitalPaid = Math.max(0, clamp2(newLoanPart - row.interest));
        runningBalance = clamp2(runningBalance - capitalPaid);
      }

      row.balance = clamp2(runningBalance);
      prevDate = row.date;
    }

    // √âtape 5: Ajustement final sur la derni√®re ligne pour arrondi
    let lastNormalIdx = -1;
    for(let i = ordered.length - 1; i >= 0; i--){
      if(ordered[i].status !== 'NSF' && ordered[i].status !== 'Frais report'){
        lastNormalIdx = i;
        break;
      }
    }

    if(lastNormalIdx >= 0 && ordered[lastNormalIdx].balance !== 0){
      const lastRow = ordered[lastNormalIdx];
      const remainingBalance = lastRow.balance;

      // Ajuster le total de la derni√®re ligne pour absorber l'arrondi
      const currentLoanPart = clamp2(lastRow.total - lastRow.adhesion);
      const newLoanPart = clamp2(currentLoanPart + remainingBalance);
      lastRow.total = clamp2(newLoanPart + lastRow.adhesion);
      lastRow.balance = 0;
    }

    state.schedule = ordered;
  }

  // ===== State
  let state = {
    schedule: [],
    selected: 1,
    arrearsItems: [], // {id,type,sourceLine,amount,fee,total,status:'OPEN'|'RESOLVED', createdAt}
    events: []
  };

  function resetDemo(skipConfirm = false){
    if(!skipConfirm && !confirm('‚ö†Ô∏è R√©initialiser le dossier?\n\nToutes les modifications (ententes, reports, NSF) seront perdues.')){
      return;
    }
    state.schedule = originalSchedule.map(r => ({
      ...r,
      status:'√Ä venir',
      adjustment:0.00,
      paid:false,
      method:'A_VENIR',
      ententeApplied: false,
      nsfReportFee: 0
      }));
    state.selected = 1;
    state.arrearsItems = [];
    state.events = [{
      id: 'evt_' + Date.now() + '_init',
      ts:new Date().toISOString(),
      title:'üîÑ Dossier r√©initialis√©',
      txt:'Le dossier a √©t√© remis √† son √©tat initial.'
    }];
    renderAll();
  }

  function calcDerived(row){
    const loanPart = clamp2((row.total||0) - (row.adhesion||0));
    const capital  = clamp2(loanPart - (row.interest||0));
    return {loanPart, capital};
  }

  function arrearsTotal(){
    return clamp2(state.arrearsItems
      .filter(a => a.status === 'OPEN')
      .reduce((s,a)=> s + (a.total || 0), 0));
  }

  function renderKPI(){
    const financed = loanConfig.initialBalance || 2250.00;
    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
    const next = ordered.find(r => !r.paid) || ordered[0];
    const aTotal = arrearsTotal();

    // Calculer l'int√©r√™t total depuis le calendrier
    const interestTotal = clamp2(state.schedule.reduce((sum, r) => sum + (r.interest || 0), 0));

    const kpis = [
      {label:'Solde contrat', dot:'good', value: money(next?.balance ?? 0), sub:'Solde apr√®s la ligne'},
      {label:'Souffrance', dot: aTotal>0?'bad':'good', value: money(aTotal), sub:'NSF = paiement + 48$', hasBtn: aTotal > 0},
      {label:'Montant financ√©', dot:'good', value: money(financed), sub:'Pr√™t + frais ouverture'},
      {label:'Int√©r√™t total', dot:'warn', value: money(interestTotal), sub:'Somme des int√©r√™ts'}
    ];

    document.getElementById('kpi').innerHTML = kpis.map(k=>`
      <div class="kpi-card">
        <div class="kpi-label"><span>${k.label}</span><span class="kpi-dot ${k.dot}"></span></div>
        <div class="kpi-value">
          ${k.value}
          ${k.hasBtn ? `<button class="kpi-btn" onclick="openFirstArrears()" title="R√©partir la souffrance">üìä</button>` : ''}
        </div>
        <div class="kpi-sub">${k.sub}</div>
      </div>
    `).join('');

    document.getElementById('rightArrears').textContent = money(aTotal);
    document.getElementById('rightNext').innerHTML =
      `${fmtDate(next.date)} ¬∑ <span class="mono">${money((next.total||0)+(next.adjustment||0))}</span>`;
  }

  function renderTable(){
    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
    const tbody = document.getElementById('rows');

    tbody.innerHTML = ordered.map(r=>{
      const sel = r.i===state.selected;
      const {loanPart, capital} = calcDerived(r);
      const totalToCollect = clamp2((r.total||0) + (r.adjustment||0));
      const nsfRepFee = r.nsfReportFee || 0;

      // Ligne sp√©ciale CAPITAL
      if(r.isCapitalLine){
        return `
          <tr onclick="selectRow(${r.i})" style="background:rgba(34,197,94,0.15);${sel?'outline:2px solid var(--good)':''}">
            <td class="mono" style="color:var(--good);font-weight:bold">${r.i}</td>
            <td style="color:var(--good)">${fmtDate(r.date)}</td>
            <td colspan="10" style="text-align:left;padding-left:20px">
              <span style="background:var(--good);color:#000;padding:4px 12px;border-radius:20px;font-weight:bold;font-size:12px">
                üí∞ AJOUT DE CAPITAL FINANC√â: ${money(r.capitalAmount || r.total)}
              </span>
              <span style="margin-left:15px;color:var(--muted2);font-size:11px">Ce montant est ajout√© au solde du pr√™t</span>
            </td>
            <td class="mono" style="color:var(--good);font-weight:bold">${money(r.balance||0)}</td>
          </tr>
        `;
      }

      const statusDot =
        r.status === 'NSF' ? 'bad' :
        r.status === 'Frais report' ? 'warn' :
        (r.paid ? 'good' : 'warn');

      const statusLabel =
        r.status === 'NSF' ? 'NSF' :
        r.status === 'Frais report' ? 'Frais report' :
        (r.paid ? 'Pay√©' : '√Ä venir');

      const inputStyle = "width:55px;background:transparent;border:1px solid var(--stroke);border-radius:3px;color:var(--text);text-align:right;padding:2px 3px;font-size:10px";
      const selectStyle = "width:100%;background:#1a1a2e;border:1px solid var(--stroke);border-radius:3px;color:var(--text);padding:2px;font-size:9px";
      const dateStyle = "width:85px;background:transparent;border:1px solid var(--stroke);border-radius:3px;color:var(--text);padding:2px 3px;font-size:10px";

      return `
        <tr onclick="selectRow(${r.i})" style="${sel?'background:rgba(96,165,250,.08)':''}">
          <td class="mono">${r.i}</td>
          <td><input type="date" value="${r.date}" style="${dateStyle}" onchange="editCell(${r.i}, 'date', this.value)" onclick="event.stopPropagation()"/></td>
          <td>
            <select style="${selectStyle}" onchange="editCell(${r.i}, 'method', this.value)" onclick="event.stopPropagation()">
              <option value="NON_PAYE" style="background:#1a1a2e;color:#fff" ${r.method==='NON_PAYE'?'selected':''}>PMNT NON PAY√â</option>
              <option value="A_VENIR" style="background:#1a1a2e;color:#fff" ${(r.method||'A_VENIR')==='A_VENIR'?'selected':''}>PMNT A VENIR</option>
              <option value="A_VENIR_CASH" style="background:#1a1a2e;color:#fff" ${r.method==='A_VENIR_CASH'?'selected':''}>PMNT A VENIR CASH</option>
              <option value="PPA_FAIT" style="background:#1a1a2e;color:#fff" ${r.method==='PPA_FAIT'?'selected':''}>PPA FAIT</option>
              <option value="FAIT_CASH" style="background:#1a1a2e;color:#fff" ${r.method==='FAIT_CASH'?'selected':''}>PMNT FAIT CASH</option>
            </select>
          </td>
          <td class="mono"><input type="number" step="0.01" value="${totalToCollect.toFixed(2)}" style="${inputStyle}" onchange="editCell(${r.i}, 'total', this.value)" onclick="event.stopPropagation()"/></td>
          <td class="mono">${money(loanPart)}</td>
          <td class="mono"><input type="number" step="0.01" value="${(r.interest||0).toFixed(2)}" style="${inputStyle}" onchange="editCell(${r.i}, 'interest', this.value)" onclick="event.stopPropagation()"/></td>
          <td class="mono">${money(capital)}</td>
          <td class="mono"><input type="number" step="0.01" value="${(r.adhesion||0).toFixed(2)}" style="${inputStyle}" onchange="editCell(${r.i}, 'adhesion', this.value)" onclick="event.stopPropagation()"/></td>
          <td class="mono"><input type="number" step="0.01" value="${nsfRepFee || ''}" placeholder="-" style="${inputStyle}" onchange="applyNSFDirect(${r.i}, this.value)" onclick="event.stopPropagation()"/></td>
          <td class="mono"><input type="number" step="0.01" value="${(r.adjustment||0).toFixed(2)}" style="${inputStyle}" onchange="editCell(${r.i}, 'adjustment', this.value)" onclick="event.stopPropagation()"/></td>
          <td><span class="status"><span class="dot ${statusDot}"></span>${statusLabel}</span></td>
          <td class="mono">${money(r.balanceBefore||0)}</td>
          <td class="mono">${money(r.balance||0)}</td>
        </tr>
      `;
    }).join('');

    const row = state.schedule.find(r=>r.i===state.selected) || ordered[0];
    document.getElementById('selectedInfo').textContent =
      `S√©lection: #${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Total ${money((row.total||0)+(row.adjustment||0))}`;
  }

  function renderEvents(){
    const items = [...state.events].slice(-15).reverse();
    const getIcon = (title) => {
      if(title.includes('Note client')) return 'üìã';
      if(title.includes('Report')) return 'üìÖ';
      if(title.includes('NSF')) return '‚ùå';
      if(title.includes('Paiement')) return 'üíµ';
      if(title.includes('Souffrance')) return '‚ö†Ô∏è';
      if(title.includes('Note')) return 'üìù';
      if(title.includes('Modification')) return '‚úèÔ∏è';
      if(title.includes('Capital')) return 'üí∞';
      if(title.includes('Entente')) return 'üìã';
      return 'üìã';
    };
    const getClass = (title) => {
      if(title.includes('Note client')) return 'note-client';
      if(title.includes('Report')) return 'note-report';
      if(title.includes('NSF')) return 'note-nsf';
      if(title.includes('Paiement')) return 'note-paiement';
      if(title.includes('Souffrance')) return 'note-souffrance';
      if(title.includes('Note')) return 'note-note';
      return '';
    };
    document.getElementById('events').innerHTML = items.map(e=>{
      const d = new Date(e.ts);
      const dateStr = d.toLocaleDateString('fr-CA',{day:'2-digit',month:'short'});
      const timeStr = d.toLocaleTimeString('fr-CA',{hour:'2-digit',minute:'2-digit'});
      const eventId = e.id || '';
      return `
        <div class="note ${getClass(e.title)}" onclick="${eventId ? `openEditNote('${eventId}')` : ''}" style="cursor:pointer;transition:background .15s" onmouseover="this.style.background='rgba(255,255,255,.06)'" onmouseout="this.style.background=''">
          <div class="meta">
            <span class="title"><span class="icon">${getIcon(e.title)}</span> ${e.title}</span>
            <span class="time">${dateStr} ¬∑ ${timeStr}</span>
          </div>
          <div class="txt">${e.txt}</div>
        </div>
      `;
    }).join('');
  }

  // ‚úÖ Liste Souffrance (NSF) dans le panneau Souffrance
  function renderArrearsList(){
    const box = document.getElementById('arrearsList');
    const open = state.arrearsItems
      .filter(a => a.status === 'OPEN')
      .sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));

    if(!open.length){
      box.innerHTML = `<div style="color:var(--muted2); font-size:12px; padding:6px 4px;">Aucune souffrance ouverte.</div>`;
      return;
    }

    box.innerHTML = open.map(a=>{
      const dateStr = new Date(a.createdAt).toLocaleString('fr-CA',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
      return `
        <div class="arrearsRow">
          <div class="arrearsLeft">
            <div class="arrearsTitle">
              <span class="tag"><span class="dot bad"></span> NSF</span>
              Ligne #${a.sourceLine}
            </div>
            <div class="arrearsCalc">
              <span class="calcItem">${money(a.amount)}</span>
              <span class="calcOp">+</span>
              <span class="calcItem fee">${money(a.fee)} frais</span>
              <span class="calcOp">=</span>
              <span class="calcTotal">${money(a.total)}</span>
            </div>
            <div class="arrearsMeta">${dateStr}</div>
          </div>
          <div class="actions">
            <button class="btn" onclick="openArrearsResolver('${a.id}')" title="R√©partir sur plusieurs paiements" style="font-size:16px;padding:6px 10px">üìä</button>
            <button class="btn danger" onclick="openArrearsResolver('${a.id}')">Traiter</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderAll(){
    renderKPI();
    renderTable();
    renderArrearsList();
    renderEvents();
  }

  function selectRow(i){ state.selected=i; renderAll(); }
  function logEvent(title, txt){
    state.events.push({
      id: 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2,5),
      ts: new Date().toISOString(),
      title,
      txt
    });
  }

  // ===== Ouvrir et modifier une note
  function openEditNote(eventId){
    const evt = state.events.find(e => e.id === eventId);
    if(!evt) return;

    const overlay = document.getElementById('overlay');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    const foot = document.getElementById('modalFoot');

    title.textContent = 'üìù Modifier la note';

    const d = new Date(evt.ts);
    const dateStr = d.toLocaleDateString('fr-CA',{day:'2-digit',month:'short',year:'numeric'});
    const timeStr = d.toLocaleTimeString('fr-CA',{hour:'2-digit',minute:'2-digit'});

    body.innerHTML = `
      <div class="field">
        <label>Titre</label>
        <input id="editNoteTitle" value="${evt.title.replace(/"/g, '&quot;')}" />
      </div>
      <div class="field" style="margin-top:12px">
        <label>Contenu</label>
        <textarea id="editNoteTxt" rows="4" style="width:100%;background:rgba(255,255,255,.05);border:1px solid var(--stroke2);border-radius:10px;color:var(--text);padding:10px 12px;font-size:13px;resize:vertical;font-family:inherit">${evt.txt}</textarea>
      </div>
      <div style="margin-top:12px;font-size:11px;color:var(--muted2)">
        Cr√©√© le ${dateStr} √† ${timeStr}
      </div>
    `;

    foot.innerHTML = `
      <button class="btn danger" onclick="deleteNote('${eventId}')">üóëÔ∏è Supprimer</button>
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn primary" onclick="saveEditNote('${eventId}')">Enregistrer</button>
    `;

    overlay.style.display = 'flex';
  }

  function saveEditNote(eventId){
    const evt = state.events.find(e => e.id === eventId);
    if(!evt) return;

    evt.title = document.getElementById('editNoteTitle').value || evt.title;
    evt.txt = document.getElementById('editNoteTxt').value || evt.txt;

    closeModal();
    renderAll();
  }

  function deleteNote(eventId){
    if(!confirm('Supprimer cette note?')) return;
    state.events = state.events.filter(e => e.id !== eventId);
    closeModal();
    renderAll();
  }

  // ===== Edit cell directly in table
  function editCell(lineNum, field, value){
    const row = state.schedule.find(r => r.i === lineNum);
    if(!row) return;

    if(field === 'date'){
      row.date = value;
      logEvent('‚úèÔ∏è Modification', `Ligne #${lineNum}: date modifi√©e ‚Üí ${fmtDate(value)}`);
    } else if(field === 'method'){
      const oldMethod = row.method;
      row.method = value;

      // Si chang√© vers NON_PAYE ‚Üí automatiquement ajouter NSF 48$ et souffrance
      if(value === 'NON_PAYE' && oldMethod !== 'NON_PAYE'){
        const nsfFee = 48.00;
        const paymentAmt = clamp2((row.total || 0) + (row.adjustment || 0));
        const totalArrears = clamp2(paymentAmt + nsfFee);

        // Ajouter les frais NSF √† la ligne
        row.nsfReportFee = nsfFee;
        row.status = 'NSF';

        // Cr√©er l'item de souffrance
        const arrearsId = 'arr_' + Date.now() + '_' + Math.random().toString(36).substr(2,5);
        state.arrearsItems.push({
          id: arrearsId,
          type: 'NSF',
          sourceLine: lineNum,
          amount: paymentAmt,
          fee: nsfFee,
          total: totalArrears,
          status: 'OPEN',
          createdAt: new Date().toISOString()
        });

        logEvent('‚ùå NSF Automatique', `Ligne #${lineNum}: Paiement non pay√© ‚Üí Souffrance ${money(totalArrears)} (${money(paymentAmt)} + ${money(nsfFee)} frais)`);
      } else {
        logEvent('‚úèÔ∏è Modification', `Ligne #${lineNum}: type modifi√© ‚Üí ${value}`);
      }
    } else if(field === 'total'){
      const newTotal = clamp2(Number(value) || 0);
      row.total = newTotal;
      row.adjustment = 0; // Reset adjustment when total is manually set
      logEvent('‚úèÔ∏è Modification', `Ligne #${lineNum}: total modifi√© ‚Üí ${money(newTotal)}`);
    } else if(field === 'interest'){
      row.interest = clamp2(Number(value) || 0);
      logEvent('‚úèÔ∏è Modification', `Ligne #${lineNum}: int√©r√™t modifi√© ‚Üí ${money(row.interest)}`);
    } else if(field === 'adhesion'){
      row.adhesion = clamp2(Number(value) || 0);
      logEvent('‚úèÔ∏è Modification', `Ligne #${lineNum}: adh√©sion modifi√©e ‚Üí ${money(row.adhesion)}`);
    } else if(field === 'adjustment'){
      row.adjustment = clamp2(Number(value) || 0);
      logEvent('‚úèÔ∏è Modification', `Ligne #${lineNum}: ajustement modifi√© ‚Üí ${money(row.adjustment)}`);
    }

    recalculateBalancesAndInterest();
    renderAll();
  }

  // ===== MODAL helpers
  function closeModal(ev){
    if(ev && ev.target && ev.target.id !== 'overlay') return;
    document.getElementById('overlay').style.display = 'none';
  }

  // ===== Reporter UI (S√©lection / Auto 1-5 / Tous / NEW)
  function onRepPlanChange(){
    const plan = document.getElementById('repPlan').value;
    const pick = document.getElementById('pickTargets');
    const nl = document.getElementById('newLine');
    const confirm = document.getElementById('repConfirm');

    document.querySelectorAll('.tchk').forEach(c => c.checked = false);

    if(plan === 'NEW'){
      pick.style.display = 'none';
      nl.style.display = 'block';
      document.getElementById('repNeed').textContent = 'Mode: ajout d‚Äôune ligne VIREMENT';
      document.getElementById('repPreview').textContent = 'Ajout par ligne: ‚Äî';
      document.getElementById('newAdhesion').value = getAdhesionFee();
      confirm.classList.remove('disabled');
      return;
    }

    pick.style.display = 'block';
    nl.style.display = 'none';

    if(plan === 'ALL' || plan.startsWith('AUTO_')){
      const n = plan === 'ALL' ? 9999 : Number(plan.replace('AUTO_',''));
      const boxes = Array.from(document.querySelectorAll('.tchk')).slice(0, n);
      boxes.forEach(b => b.checked = true);
    }

    validateRepSelection();
  }

  function validateRepSelection(){
    const plan = document.getElementById('repPlan').value;
    const confirm = document.getElementById('repConfirm');
    const amt = clamp2(Number(document.getElementById('repAmt').value || 0));

    // Reset all line previews
    document.querySelectorAll('.chk').forEach(chk => {
      chk.classList.remove('selected');
      const addEl = chk.querySelector('[data-add]');
      const newEl = chk.querySelector('[data-new]');
      if(addEl) addEl.textContent = '';
      if(newEl) newEl.textContent = '';
    });

    if(plan === 'NEW'){
      if(amt > 0) confirm.classList.remove('disabled');
      else confirm.classList.add('disabled');
      return;
    }

    const allBoxes = Array.from(document.querySelectorAll('.tchk'));
    const checked = allBoxes.filter(x=>x.checked);
    const count = checked.length;

    document.getElementById('repNeed').textContent = count.toString();

    if(count > 0 && amt > 0){
      const per = clamp2(amt / count);
      document.getElementById('repPreview').textContent = money(per);
      confirm.classList.remove('disabled');

      // Update each checked line with preview
      checked.forEach(box => {
        const i = box.value;
        const chk = box.closest('.chk');
        const row = state.schedule.find(r => r.i == i);
        if(chk && row){
          chk.classList.add('selected');
          const currentTotal = clamp2((row.total||0)+(row.adjustment||0));
          const newTotal = clamp2(currentTotal + per);
          const addEl = chk.querySelector('[data-add]');
          const newEl = chk.querySelector('[data-new]');
          if(addEl) addEl.textContent = '+ ' + money(per);
          if(newEl) newEl.textContent = '= ' + money(newTotal);
        }
      });
    } else {
      document.getElementById('repPreview').textContent = '‚Äî';
      confirm.classList.add('disabled');
    }
  }

  // ===== Souffrance(NSF) UI (m√™mes options que Reporter)
  function onArrPlanChange(){
    const plan = document.getElementById('arrPlan').value;
    const pick = document.getElementById('arrPickTargets');
    const nl = document.getElementById('arrNewLine');
    const confirm = document.getElementById('arrConfirm');

    document.querySelectorAll('.arrchk').forEach(c => c.checked = false);

    if(plan === 'NEW'){
      pick.style.display = 'none';
      nl.style.display = 'block';
      document.getElementById('arrNeed').textContent = 'Mode: ajout d‚Äôune ligne VIREMENT';
      document.getElementById('arrPreview').textContent = 'Ajout par ligne: ‚Äî';
      confirm.classList.remove('disabled');
      return;
    }

    pick.style.display = 'block';
    nl.style.display = 'none';

    if(plan === 'ALL' || plan.startsWith('AUTO_')){
      const n = plan === 'ALL' ? 9999 : Number(plan.replace('AUTO_',''));
      const boxes = Array.from(document.querySelectorAll('.arrchk')).slice(0, n);
      boxes.forEach(b => b.checked = true);
    }

    validateArrSelection();
  }

  function validateArrSelection(){
    const plan = document.getElementById('arrPlan').value;
    const confirm = document.getElementById('arrConfirm');
    const amt = clamp2(Number(document.getElementById('arrAmt').value || 0));

    if(plan === 'NEW'){
      if(amt > 0) confirm.classList.remove('disabled');
      else confirm.classList.add('disabled');
      return;
    }

    const checked = Array.from(document.querySelectorAll('.arrchk')).filter(x=>x.checked);
    const count = checked.length;

    document.getElementById('arrNeed').textContent = `S√©lection: ${count} ligne(s)`;

    if(count > 0 && amt > 0){
      const per = clamp2(amt / count);
      document.getElementById('arrPreview').textContent = `Ajout par ligne: ${money(per)}`;
      confirm.classList.remove('disabled');
    } else {
      document.getElementById('arrPreview').textContent = 'Ajout par ligne: ‚Äî';
      confirm.classList.add('disabled');
    }
  }

  // ===== Open modal
  function openAction(kind){
    const row = state.schedule.find(r=>r.i===state.selected) || state.schedule[0];
    const overlay = document.getElementById('overlay');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    const foot = document.getElementById('modalFoot');

    title.textContent = ({
      report:'üìÖ Reporter un paiement',
      capital:'üí∞ Ajout de capital (financement)',
      nsf:'‚ùå NSF (banque) ‚Üí Souffrance automatique',
      manual:'üíµ Paiement manuel',
      note:'üìù Ajouter une note',
      entente:'üìã Entente fixe'
    })[kind] || 'Action';

    // ===== REPORT
    if(kind === 'report'){
      const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
      const targets = ordered.filter(r =>
        r.i !== row.i &&
        !r.paid &&
        r.status !== 'NSF' &&
        (r.method||'PAD') === 'PAD'
      );

      const dateOptions = ordered
        .filter(r => !r.paid && r.status !== 'NSF')
        .map(r => `<option value="${r.date}">${fmtDate(r.date)}</option>`)
        .join('');

      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne report√©e (source) ‚Äî devient 25,00$ PAD</label>
            <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ ${money((row.total||0)+(row.adjustment||0))}" />
          </div>
          <div class="field">
            <label>Montant √† d√©placer</label>
            <input id="repAmt" type="number" step="0.01"
              value="${clamp2((row.total||0)+(row.adjustment||0))}"
              oninput="validateRepSelection()" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Mode</label>
            <select id="repPlan" onchange="onRepPlanChange()">
              <option value="SEL" selected>R√©partir sur les lignes coch√©es</option>
              <option value="AUTO_1">Auto: 1 prochain paiement</option>
              <option value="AUTO_2">Auto: 2 prochains paiements</option>
              <option value="AUTO_3">Auto: 3 prochains paiements</option>
              <option value="AUTO_4">Auto: 4 prochains paiements</option>
              <option value="AUTO_5">Auto: 5 prochains paiements</option>
              <option value="ALL">Auto: tous les paiements √† venir</option>
              <option value="NEW">+ Ajouter une ligne de paiement (VIREMENT)</option>
            </select>
          </div>
          <div class="field">
            <label>Frais de report (pr√©lev√©s sur la ligne source)</label>
            <input disabled value="25.00" />
          </div>
        </div>

        <div id="pickTargets" style="margin-top:10px">
          <div class="field">
            <label>R√©partition du montant sur les lignes s√©lectionn√©es</label>

            <div class="inlineInfo">
              <div><span class="label">Lignes s√©lectionn√©es</span><div class="value" id="repNeed">0</div></div>
              <div><span class="label">Ajout par ligne</span><div class="value" id="repPreview">‚Äî</div></div>
            </div>

            <div class="listBox" id="targetsList">
              ${targets.map(t=>{
                const total = clamp2((t.total||0)+(t.adjustment||0));
                return `
                  <div class="chk" data-i="${t.i}">
                    <input type="checkbox" class="tchk" value="${t.i}" onchange="validateRepSelection()"/>
                    <div class="info">
                      <div class="t">#${t.i} ¬∑ ${fmtDate(t.date)}</div>
                      <div class="m">PAD</div>
                    </div>
                    <div class="amounts">
                      <div class="current">${money(total)}</div>
                      <div class="add" data-add="${t.i}"></div>
                      <div class="newtotal" data-new="${t.i}"></div>
                    </div>
                  </div>
                `;
              }).join('') || `<div class="m">Aucune ligne PAD disponible.</div>`}
            </div>
          </div>
        </div>

        <div id="newLine" style="margin-top:10px; display:none">
          <div class="row">
            <div class="field">
              <label>Date du virement</label>
              <select id="newDate">${dateOptions}</select>
            </div>
            <div class="field">
              <label>Frais d'adhesion</label>
              <input id="newAdhesion" type="number" step="0.01" value="0" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Type</label>
              <input disabled value="VIREMENT (cash √† venir)" />
            </div>
          </div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>üìù Note interne (raison du report)</label>
          <select id="repReason" onchange="if(this.value==='autre')document.getElementById('repReasonCustom').style.display='block'">
            <option value="Appel client">Appel du client</option>
            <option value="Entente de paiement">Entente de paiement</option>
            <option value="Difficult√©s financi√®res">Difficult√©s financi√®res temporaires</option>
            <option value="Demande √©crite">Demande √©crite du client</option>
            <option value="autre">Autre (pr√©ciser)...</option>
          </select>
          <input id="repReasonCustom" style="display:none;margin-top:8px" placeholder="Pr√©ciser la raison..." />
        </div>

        <div class="summary">
          ‚úÖ Une note interne sera g√©n√©r√©e automatiquement avec les d√©tails du report.
        </div>
      `;

      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary disabled" id="repConfirm" onclick="applyReportV4()">Confirmer</button>
      `;

      overlay.style.display = 'flex';
      setTimeout(()=> onRepPlanChange(), 0);
      return;
    }

    // ===== NSF -> Souffrance automatique (paiement + 48$)
    // NSF est ici parce qu'il est dans la section "Souffrance"
    if(kind === 'nsf'){
      const nsfPayAmt = clamp2((row.total||0)+(row.adjustment||0));
      const nsfDefaultFee = 48.00;
      const nsfTotal = clamp2(nsfPayAmt + nsfDefaultFee);

      body.innerHTML = `
        <div class="nsfCalc">
          <div class="nsfRow">
            <div class="nsfLabel">Paiement rejet√©</div>
            <div class="nsfLine">#${row.i} ¬∑ ${fmtDate(row.date)}</div>
            <div class="nsfAmount">${money(nsfPayAmt)}</div>
          </div>
          <div class="nsfRow add">
            <div class="nsfLabel">Frais NSF (banque)</div>
            <div class="nsfLine">
              <input id="nsfFee" type="number" step="0.01" value="48.00" oninput="updateNSFTotal()" style="width:80px;text-align:right"/>
            </div>
            <div class="nsfAmount" id="nsfFeeDisplay">+ ${money(nsfDefaultFee)}</div>
          </div>
          <div class="nsfRow total">
            <div class="nsfLabel">Total Souffrance</div>
            <div class="nsfLine">‚Üí Ajout√© automatiquement</div>
            <div class="nsfAmount" id="nsfTotalDisplay">${money(nsfTotal)}</div>
          </div>
        </div>
        <div class="field" style="margin-top:10px">
          <label>üìù Note interne (contexte du NSF)</label>
          <select id="nsfReason">
            <option value="Fonds insuffisants">Fonds insuffisants signal√© par la banque</option>
            <option value="Compte ferm√©">Compte ferm√©</option>
            <option value="Paiement bloqu√©">Paiement bloqu√© par le client</option>
            <option value="Erreur bancaire">Erreur bancaire</option>
          </select>
        </div>

        <div class="summary" style="background:rgba(251,113,133,.1);border-color:rgba(251,113,133,.25)">
          ‚ö†Ô∏è Une note interne sera g√©n√©r√©e automatiquement.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn danger" onclick="applyNSF()">Confirmer NSF</button>
      `;
      overlay.style.display = 'flex';
      return;
    }

    // ===== Paiement manuel
    if(kind === 'manual'){
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Montant re√ßu</label>
            <input id="manualAmt" type="number" step="0.01" value="148.00" />
          </div>
          <div class="field">
            <label>Appliquer √†</label>
            <select id="manualTo">
              <option value="arrears" selected>Souffrance (r√©duire)</option>
              <option value="note">Note seulement</option>
            </select>
          </div>
        </div>
        <div class="summary">
          D√©mo : ‚ÄúSouffrance‚Äù = ferme des items OPEN (FIFO) jusqu‚Äô√† √©puisement du montant.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="applyManual()">Enregistrer</button>
      `;
      overlay.style.display = 'flex';
      return;
    }

    // ===== Note
    if(kind === 'note'){
      body.innerHTML = `
        <div class="field">
          <label>Note</label>
          <input id="noteTxt" placeholder="Ex: client reporte au prochain vendredi‚Ä¶" />
        </div>
        <div class="summary">Les notes restent dans l'historique (audit).</div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="applyNote()">Ajouter</button>
      `;
      overlay.style.display = 'flex';
      return;
    }

    // ===== Ajout de capital (complet)
    if(kind === 'capital'){
      const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
      const availableLines = ordered.filter(r => !r.paid && r.status !== 'NSF');

      body.innerHTML = `
        <!-- En-t√™te avec montant et stats -->
        <div style="display:grid;grid-template-columns:1fr auto auto auto;gap:12px;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.1)">
          <div class="field" style="padding:0">
            <label style="font-size:11px">Montant √† financer au client</label>
            <input id="capitalAmt" type="number" step="0.01" placeholder="500.00" oninput="updateCapitalPreview()" style="font-size:24px;font-weight:bold;padding:8px 12px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px" />
          </div>
          <div style="text-align:center;padding:0 12px;border-left:1px solid rgba(255,255,255,0.1)">
            <div style="font-size:10px;color:var(--muted2)">Lignes</div>
            <div id="capitalCount" style="font-size:22px;font-weight:bold">0</div>
          </div>
          <div style="text-align:center;padding:0 12px;border-left:1px solid rgba(255,255,255,0.1)">
            <div style="font-size:10px;color:var(--muted2)">Par ligne</div>
            <div id="capitalPerLine" style="font-size:14px;font-weight:bold;color:var(--good)">-</div>
          </div>
        </div>
        <div style="font-size:11px;color:var(--good);margin-bottom:15px;padding:8px;background:rgba(34,197,94,0.1);border-radius:6px">
          üí∞ <b>Ajout de capital:</b> Ce montant sera financ√© au client et ajout√© au solde du pr√™t. Les int√©r√™ts seront recalcul√©s automatiquement sur le nouveau solde.
        </div>

        <!-- 2 colonnes -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">

          <!-- Colonne gauche: Lignes existantes -->
          <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.08)">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <div style="font-size:12px;font-weight:bold;color:var(--good)">üìã R√©partir sur lignes existantes</div>
              <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:11px">
                <input type="checkbox" id="capitalSelectAll" onchange="toggleCapitalSelectAll()" />
                Tout
              </label>
            </div>
            <div class="listBox" style="max-height:200px;background:transparent;border:none;padding:0;overflow-y:auto">
              ${availableLines.map(t=>{
                const total = clamp2((t.total||0)+(t.adjustment||0));
                return `
                  <div style="display:grid;grid-template-columns:22px 1fr 65px 65px;gap:4px;padding:6px 8px;border-radius:6px;align-items:center;font-size:12px" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <input type="checkbox" class="capitalLineChk" value="${t.i}" onchange="updateCapitalPreview()" style="width:16px;height:16px"/>
                    <div><span style="color:var(--muted2)">#${t.i}</span> ${fmtDate(t.date)}</div>
                    <div style="text-align:right;color:var(--muted2)">${money(total)}</div>
                    <div class="capitalNewAmt" data-i="${t.i}" style="text-align:right;font-weight:bold;color:var(--good)">-</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Colonne droite: Ajouter nouvelles lignes -->
          <div style="background:rgba(34,197,94,0.05);border-radius:12px;padding:10px;border:1px solid rgba(34,197,94,0.2)">
            <div style="font-size:12px;font-weight:bold;color:var(--good);margin-bottom:8px">‚ûï Ou ajouter nouvelles lignes</div>

            <div style="margin-bottom:10px">
              <label style="font-size:10px;color:var(--muted2)">Nombre de lignes √† ajouter</label>
              <input type="number" id="capitalNewCount" min="0" value="0" oninput="updateCapitalPreview()" style="width:100%;padding:8px;border-radius:6px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);color:#fff;font-size:14px;text-align:center" />
            </div>

            <div id="capitalNewLinesPreview" style="padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:12px;color:var(--muted2);text-align:center">
              Aucune nouvelle ligne
            </div>

            <div style="margin-top:10px">
              <label style="font-size:10px;color:var(--muted2)">Date de d√©but</label>
              <input type="date" id="capitalNewDate" value="${new Date().toISOString().split('T')[0]}" style="width:100%;padding:8px;border-radius:6px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);color:#fff;font-size:12px" />
            </div>

            <div style="margin-top:10px">
              <label style="font-size:10px;color:var(--muted2)">Mode de paiement</label>
              <select id="capitalNewMethod" style="width:100%;padding:8px;border-radius:6px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);color:#fff;font-size:12px">
                <option value="PPA">PPA</option>
                <option value="VIREMENT" selected>√Ä venir cash (Virement)</option>
              </select>
            </div>
          </div>
        </div>
      `;

      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="applyCapital()">Ajouter le capital</button>
      `;

      overlay.style.display = 'flex';
      return;
    }

    // ===== Entente fixe
    if(kind === 'entente'){
      const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
      const availableLines = ordered.filter(r =>
        !r.paid &&
        r.status !== 'NSF' &&
        r.status !== 'Frais report'
      );

      body.innerHTML = `
        <!-- En-t√™te avec montant et stats -->
        <div style="display:grid;grid-template-columns:1fr auto auto auto;gap:12px;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.1)">
          <div class="field" style="padding:0">
            <label style="font-size:11px">Montant fixe / ligne</label>
            <input id="ententeAmt" type="number" step="0.01" placeholder="150.00" oninput="updateEntentePreview()" style="font-size:20px;font-weight:bold;padding:8px 12px" />
          </div>
          <div style="text-align:center;padding:0 12px">
            <div style="font-size:10px;color:var(--muted2)">Lignes</div>
            <div id="ententeCount" style="font-size:22px;font-weight:bold">0</div>
          </div>
          <div style="text-align:center;padding:0 12px;border-left:1px solid rgba(255,255,255,0.1)">
            <div style="font-size:10px;color:var(--muted2)">Original</div>
            <div id="ententeOriginal" style="font-size:14px">0$</div>
          </div>
          <div style="text-align:center;padding:0 12px;border-left:1px solid rgba(255,255,255,0.1)">
            <div style="font-size:10px;color:var(--muted2)">Entente</div>
            <div id="ententeTotal" style="font-size:14px;font-weight:bold;color:var(--good)">0$</div>
          </div>
          <div style="text-align:center;padding:0 12px;border-left:1px solid rgba(255,255,255,0.1)">
            <div style="font-size:10px;color:var(--muted2)">Diff√©rence</div>
            <div id="ententeDiff" style="font-size:14px;font-weight:bold;color:var(--warn)">0$</div>
          </div>
        </div>

        <!-- 2 colonnes: R√©duire | Placer diff√©rence -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">

          <!-- Colonne gauche: Lignes √† r√©duire -->
          <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.08)">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <div style="font-size:12px;font-weight:bold;color:var(--good)">üìâ R√©duire ces lignes</div>
              <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:11px">
                <input type="checkbox" id="ententeSelectAll" onchange="toggleEntenteSelectAll()" />
                Tout
              </label>
            </div>
            <div class="listBox" id="ententeList" style="max-height:220px;background:transparent;border:none;padding:0">
              ${availableLines.map(t=>{
                const total = clamp2((t.total||0)+(t.adjustment||0));
                return `
                  <div style="display:grid;grid-template-columns:22px 1fr 65px 65px;gap:4px;padding:6px 8px;border-radius:6px;align-items:center;font-size:12px" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <input type="checkbox" class="ententeChk" value="${t.i}" onchange="updateEntentePreview()" style="width:16px;height:16px"/>
                    <div><span style="color:var(--muted2)">#${t.i}</span> ${fmtDate(t.date)}</div>
                    <div style="text-align:right;color:var(--muted2)">${money(total)}</div>
                    <div class="ententeNewAmt" data-i="${t.i}" style="text-align:right;font-weight:bold;color:var(--good)">-</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Colonne droite: Placer la diff√©rence -->
          <div id="ententeDiffSection" style="background:rgba(251,191,36,0.05);border-radius:12px;padding:10px;border:1px solid rgba(251,191,36,0.2)">
            <div style="font-size:12px;font-weight:bold;color:var(--warn);margin-bottom:8px">üìà Placer la diff√©rence sur</div>
            <select id="ententeDiffMode" onchange="onEntenteDiffModeChange()" style="width:100%;padding:8px;font-size:12px;margin-bottom:8px;border-radius:6px">
              <option value="SELECT">Choisir les lignes</option>
              <option value="NEW">+ Nouvelle ligne √† la fin</option>
              <option value="LAST">Dernier paiement existant</option>
            </select>
            <div id="ententeDiffTargets" class="listBox" style="max-height:180px;background:transparent;border:none;padding:0"></div>
            <div id="ententeDiffEmpty" style="text-align:center;padding:20px;color:var(--muted2);font-size:12px">
              ‚Üê S√©lectionnez des lignes √† r√©duire
            </div>
          </div>
        </div>

        <!-- R√©capitulatif -->
        <div id="ententeSummary" style="display:none;padding:12px;background:rgba(34,197,94,0.08);border-radius:10px;border:1px solid rgba(34,197,94,0.25)">
          <div style="font-size:13px;font-weight:bold;color:var(--good);margin-bottom:8px">üìã R√©capitulatif pour le client:</div>
          <div id="ententeSummaryContent" style="font-size:12px;line-height:1.7"></div>
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="applyEntente()">Appliquer l'entente</button>
      `;
      overlay.style.display = 'flex';
      return;
    }
  }

  // ===== REPORT apply
  function applyReportV4(){
    const fee = 25.00;
    const src = state.schedule.find(r=>r.i===state.selected);
    const amt = clamp2(Number(document.getElementById('repAmt').value || 0));
    const plan = document.getElementById('repPlan').value;

    if(!src || amt<=0) return;

    const old = `#${src.i} (${fmtDate(src.date)})`;

    // ligne source devient frais report 25$ (pas dans le pr√™t)
    src.status = 'Frais report';
    src.method = 'PAD';
    src.total = 0;
    src.nsfReportFee = fee;
    src.adjustment = 0.00;
    src.interest = 0.00;
    src.adhesion = 0.00;

    if(plan === 'NEW'){
      const d = document.getElementById('newDate').value;
      const adhesionFee = clamp2(Number(document.getElementById('newAdhesion').value || 0));
      const totalWithAdhesion = clamp2(amt + adhesionFee);
      const maxI = Math.max(...state.schedule.map(r=>r.i));
      state.schedule.push({
        i: maxI + 1,
        date: d,
        total: totalWithAdhesion,
        interest: 0.00,
        adhesion: adhesionFee,
        balance: 0.00,
        adjustment: 0.00,
        status:'√Ä venir',
        paid:false,
        method:'VIREMENT'
      });
      const reason = document.getElementById('repReason').value === 'autre'
        ? document.getElementById('repReasonCustom').value || 'Autre'
        : document.getElementById('repReason').value;
      const noteText = `[${reason}] Report du paiement #${src.i} (${fmtDate(src.date)}). Montant ${money(amt)} + frais adh√©sion ${money(adhesionFee)} = ${money(totalWithAdhesion)} d√©plac√© vers nouvelle ligne VIREMENT le ${fmtDate(d)}. Frais de report: ${money(fee)}.`;
      logEvent('üìã Note client', noteText);
      recalculateBalancesAndInterest();
      logEvent('Report (VIREMENT)', `Source ${old} ‚Üí devient ${money(fee)} (PAD). Nouvelle ligne VIREMENT ${fmtDate(d)} cr√©√©e pour ${money(amt)} + ${money(adhesionFee)} adhesion = ${money(totalWithAdhesion)}.`);
      closeModal();
      renderAll();
      return;
    }

    const ids = Array.from(document.querySelectorAll('.tchk')).filter(x=>x.checked).map(x=>Number(x.value));
    const targets = state.schedule.filter(r => ids.includes(r.i));
    if(!targets.length) return;

    const per = clamp2(amt / targets.length);
    targets.forEach(t => t.adjustment = clamp2((t.adjustment||0) + per));

    const label =
      plan === 'ALL' ? 'Report (AUTO-TOUS)' :
      plan.startsWith('AUTO_') ? 'Report (AUTO)' :
      'Report (S√âLECTION)';

    const reason2 = document.getElementById('repReason').value === 'autre'
      ? document.getElementById('repReasonCustom').value || 'Autre'
      : document.getElementById('repReason').value;
    const targetNums = targets.map(t => '#' + t.i).join(', ');
    const noteText2 = `[${reason2}] Report du paiement #${src.i} (${fmtDate(src.date)}). Montant ${money(amt)} r√©parti sur ${targets.length} ligne(s): ${targetNums}. Ajout de ${money(per)} par ligne. Frais de report: ${money(fee)}.`;
    logEvent('üìã Note client', noteText2);
    logEvent(label, `Source ${old} ‚Üí devient ${money(fee)} (PAD). Montant ${money(amt)} r√©parti sur ${targets.length} paiement(s): +${money(per)} chacun.`);
    recalculateBalancesAndInterest();
    closeModal();
    renderAll();
  }

  // ===== NSF apply -> cr√©e souffrance auto (paiement + 48$)
  function updateNSFTotal(){
    const row = state.schedule.find(r=>r.i===state.selected);
    if(!row) return;
    const pay = clamp2((row.total||0) + (row.adjustment||0));
    const fee = clamp2(Number(document.getElementById('nsfFee').value || 48));
    const total = clamp2(pay + fee);
    document.getElementById('nsfFeeDisplay').textContent = '+ ' + money(fee);
    document.getElementById('nsfTotalDisplay').textContent = money(total);
  }

  // ===== NSF direct depuis le tableau (entr√©e manuelle du 48$)
  function applyNSFDirect(lineNum, value){
    const fee = clamp2(Number(value) || 0);
    const row = state.schedule.find(r => r.i === lineNum);
    if(!row) return;

    if(fee > 0){
      // Appliquer NSF
      const pay = clamp2((row.total||0) + (row.adjustment||0));
      const total = clamp2(pay + fee);

      row.status = 'NSF';
      row.nsfReportFee = fee;

      // V√©rifier si un item souffrance existe d√©j√† pour cette ligne
      const existingIdx = state.arrearsItems.findIndex(a => a.sourceLine === lineNum && a.status === 'OPEN');
      if(existingIdx >= 0){
        // Mettre √† jour l'existant
        state.arrearsItems[existingIdx].fee = fee;
        state.arrearsItems[existingIdx].total = total;
      } else {
        // Cr√©er nouveau
        state.arrearsItems.push({
          id: 'arr_' + Date.now(),
          sourceLine: lineNum,
          amount: pay,
          fee: fee,
          total: total,
          type: 'NSF',
          status: 'OPEN',
          createdAt: new Date().toISOString()
        });
      }

      logEvent('NSF', `NSF manuel sur #${lineNum}. Souffrance: ${money(pay)} + ${money(fee)} = ${money(total)}.`);
    } else {
      // Retirer NSF si fee = 0
      if(row.status === 'NSF'){
        row.status = 'A venir';
        row.nsfReportFee = 0;
        // Retirer de la souffrance
        state.arrearsItems = state.arrearsItems.filter(a => !(a.sourceLine === lineNum && a.type === 'NSF'));
        logEvent('NSF retir√©', `NSF retir√© de la ligne #${lineNum}.`);
      }
    }

    renderAll();
  }

  function applyNSF(){
    const row = state.schedule.find(r=>r.i===state.selected);
    const fee = clamp2(Number(document.getElementById('nsfFee').value || 48));
    if(!row) return;

    const pay = clamp2((row.total||0) + (row.adjustment||0));
    const total = clamp2(pay + fee);

    // marque la ligne NSF dans le calendrier
    row.status = 'NSF';
    row.nsfReportFee = fee; // affiche dans colonne Frais NSF/Rep

    // cr√©e item souffrance OPEN (auto)
    const id = 'A' + Date.now();
    state.arrearsItems.push({
      id,
      type: 'NSF',
      sourceLine: row.i,
      amount: pay,
      fee: fee,
      total: total,
      status: 'OPEN',
      createdAt: new Date().toISOString()
    });

    const nsfReasonVal = document.getElementById('nsfReason').value;
    const nsfNoteText = `[NSF - ${nsfReasonVal}] Paiement #${row.i} du ${fmtDate(row.date)} rejet√©. Montant: ${money(pay)} + frais NSF ${money(fee)} = ${money(total)} ajout√© √† la souffrance.`;
    logEvent('üìã Note client', nsfNoteText);
    logEvent('NSF', `NSF sur #${row.i}. Souffrance auto: ${money(pay)} + ${money(fee)} = ${money(total)}.`);
    recalculateBalancesAndInterest();
    closeModal();
    renderAll();

    // tu peux commenter cette ligne si tu veux traiter seulement via le bouton "Traiter" dans Souffrance
    openArrearsResolver(id);
  }

  // ===== Ouvrir le premier item souffrance (depuis pastille KPI)
  function openFirstArrears(){
    const first = state.arrearsItems.find(a => a.status === 'OPEN');
    if(first) openArrearsResolver(first.id);
  }

  // ===== Resolver Souffrance (style entente fixe - 2 colonnes)
  function openArrearsResolver(arrearsId){
    const item = state.arrearsItems.find(a => a.id === arrearsId && a.status === 'OPEN');
    if(!item) return;

    const overlay = document.getElementById('overlay');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    const foot = document.getElementById('modalFoot');

    title.textContent = '‚ö†Ô∏è R√©partir la souffrance';

    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
    const availableLines = ordered.filter(r => !r.paid && r.status !== 'NSF');
    const lastUnpaid = [...ordered].reverse().find(r => !r.paid && r.status !== 'NSF');

    body.innerHTML = `
      <!-- En-t√™te avec montant souffrance et stats -->
      <div style="display:grid;grid-template-columns:1fr auto auto auto;gap:12px;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.1)">
        <div>
          <div style="font-size:11px;color:var(--muted2)">Montant souffrance</div>
          <div style="font-size:28px;font-weight:700;color:var(--warn);">${money(item.total)}</div>
          <div style="font-size:11px;color:var(--muted2);margin-top:4px;">Paiement #${item.sourceLine} : ${money(item.amount)} + ${money(item.fee)} NSF</div>
        </div>
        <div style="text-align:center;padding:0 12px;border-left:1px solid rgba(255,255,255,0.1)">
          <div style="font-size:10px;color:var(--muted2)">Lignes</div>
          <div id="arrCount" style="font-size:22px;font-weight:bold">0</div>
        </div>
        <div style="text-align:center;padding:0 12px;border-left:1px solid rgba(255,255,255,0.1)">
          <div style="font-size:10px;color:var(--muted2)">Par ligne</div>
          <div id="arrPerLine" style="font-size:14px;font-weight:bold;color:var(--warn)">-</div>
        </div>
      </div>

      <!-- 2 colonnes: Info souffrance | Placer sur -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">

        <!-- Colonne gauche: Lignes disponibles -->
        <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.08)">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div style="font-size:12px;font-weight:bold;color:var(--warn)">‚ö†Ô∏è Souffrance √† placer</div>
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:11px">
              <input type="checkbox" id="arrSelectAll" onchange="toggleArrSelectAll()" />
              Tout
            </label>
          </div>
          <div class="listBox" style="max-height:220px;background:transparent;border:none;padding:0;overflow-y:auto">
            ${availableLines.map(t=>{
              const total = clamp2((t.total||0)+(t.adjustment||0));
              return `
                <div style="display:grid;grid-template-columns:22px 1fr 65px 65px;gap:4px;padding:6px 8px;border-radius:6px;align-items:center;font-size:12px" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                  <input type="checkbox" class="arrLineChk" value="${t.i}" onchange="updateArrPreview('${item.id}')" style="width:16px;height:16px"/>
                  <div><span style="color:var(--muted2)">#${t.i}</span> ${fmtDate(t.date)}</div>
                  <div style="text-align:right;color:var(--muted2)">${money(total)}</div>
                  <div class="arrNewAmt" data-i="${t.i}" style="text-align:right;font-weight:bold;color:var(--warn)">-</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- Colonne droite: Placer la souffrance -->
        <div style="background:rgba(251,191,36,0.05);border-radius:12px;padding:10px;border:1px solid rgba(251,191,36,0.2)">
          <div style="font-size:12px;font-weight:bold;color:var(--warn);margin-bottom:8px">üìä Placer la souffrance sur</div>
          <select id="arrMode" onchange="onArrModeChange('${item.id}')" style="width:100%;padding:8px;font-size:12px;margin-bottom:8px;border-radius:6px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);color:#fff">
            <option value="SELECT">Choisir les lignes (√† gauche)</option>
            <option value="NEW">+ Nouvelle ligne de paiement</option>
            <option value="LAST">Dernier paiement existant</option>
          </select>

          <!-- Explications selon le mode -->
          <div id="arrExplainSelect" style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:12px;color:var(--muted2);line-height:1.6">
            <div style="margin-bottom:8px"><b style="color:var(--text)">Mode s√©lection:</b></div>
            Cochez les lignes √† gauche pour y r√©partir la souffrance.<br/>
            Le montant sera divis√© √©galement sur chaque ligne s√©lectionn√©e.
          </div>

          <div id="arrExplainNew" style="display:none;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;">
            <div style="font-size:12px;margin-bottom:10px;color:var(--muted2)"><b style="color:var(--text)">Nouvelle ligne:</b> Cr√©er une ligne de paiement pour la souffrance</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div>
                <label style="font-size:10px;color:var(--muted2)">Date</label>
                <input type="date" id="arrNewDate" value="${new Date().toISOString().split('T')[0]}" style="width:100%;padding:6px;border-radius:6px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);color:#fff;font-size:12px" />
              </div>
              <div>
                <label style="font-size:10px;color:var(--muted2)">Mode</label>
                <select id="arrNewMethod" style="width:100%;padding:6px;border-radius:6px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);color:#fff;font-size:12px">
                  <option value="PPA">PPA</option>
                  <option value="VIREMENT" selected>√Ä venir cash</option>
                </select>
              </div>
            </div>
          </div>

          <div id="arrExplainLast" style="display:none;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:12px;color:var(--muted2);line-height:1.6">
            <div style="margin-bottom:8px"><b style="color:var(--text)">Dernier paiement:</b></div>
            La souffrance sera ajout√©e au dernier paiement non pay√©.<br/>
            ${lastUnpaid ? `<span style="color:var(--warn)">‚Üí Ligne #${lastUnpaid.i} ¬∑ ${fmtDate(lastUnpaid.date)}</span>` : '<span style="color:var(--bad)">Aucune ligne disponible</span>'}
          </div>
        </div>
      </div>
    `;

    foot.innerHTML = `
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn primary" id="arrConfirm" onclick="applyArrearsResolve('${item.id}')">Confirmer</button>
    `;

    overlay.style.display = 'flex';
  }

  function onArrModeChange(arrearsId){
    const mode = document.getElementById('arrMode').value;
    document.getElementById('arrExplainSelect').style.display = mode === 'SELECT' ? 'block' : 'none';
    document.getElementById('arrExplainNew').style.display = mode === 'NEW' ? 'block' : 'none';
    document.getElementById('arrExplainLast').style.display = mode === 'LAST' ? 'block' : 'none';

    // Reset counters when switching modes
    if(mode === 'LAST'){
      document.getElementById('arrCount').textContent = '1';
      const item = state.arrearsItems.find(a => a.id === arrearsId);
      document.getElementById('arrPerLine').textContent = item ? money(item.total) : '-';
    } else if(mode === 'NEW'){
      document.getElementById('arrCount').textContent = '1';
      const item = state.arrearsItems.find(a => a.id === arrearsId);
      document.getElementById('arrPerLine').textContent = item ? money(item.total) : '-';
    } else {
      updateArrPreview(arrearsId);
    }
  }

  function toggleArrSelectAll(){
    const selectAll = document.getElementById('arrSelectAll').checked;
    document.querySelectorAll('.arrLineChk').forEach(chk => {
      chk.checked = selectAll;
    });
    // Get the arrears ID from the confirm button
    const confirmBtn = document.getElementById('arrConfirm');
    const match = confirmBtn.getAttribute('onclick').match(/applyArrearsResolve\('(.+?)'\)/);
    if(match) updateArrPreview(match[1]);
  }

  function updateArrPreview(arrearsId){
    const item = state.arrearsItems.find(a => a.id === arrearsId);
    if(!item) return;

    const checkedIds = Array.from(document.querySelectorAll('.arrLineChk:checked')).map(x => Number(x.value));
    const count = checkedIds.length;
    const perLine = count > 0 ? clamp2(item.total / count) : 0;

    document.getElementById('arrCount').textContent = count;
    document.getElementById('arrPerLine').textContent = count > 0 ? money(perLine) : '-';

    // Update each line's new amount
    document.querySelectorAll('.arrNewAmt').forEach(el => {
      const lineI = Number(el.dataset.i);
      if(checkedIds.includes(lineI)){
        const row = state.schedule.find(r => r.i === lineI);
        const currentTotal = clamp2((row?.total||0) + (row?.adjustment||0));
        el.textContent = money(currentTotal + perLine);
        el.style.color = 'var(--warn)';
      } else {
        el.textContent = '-';
        el.style.color = 'var(--muted2)';
      }
    });

    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.arrLineChk');
    const selectAllChk = document.getElementById('arrSelectAll');
    if(selectAllChk){
      selectAllChk.checked = allCheckboxes.length > 0 && checkedIds.length === allCheckboxes.length;
      selectAllChk.indeterminate = checkedIds.length > 0 && checkedIds.length < allCheckboxes.length;
    }
  }

  function applyArrearsResolve(id){
    const item = state.arrearsItems.find(a => a.id === id && a.status === 'OPEN');
    if(!item) return;

    const mode = document.getElementById('arrMode').value;
    const amt = clamp2(item.total);
    if(amt <= 0) return;

    if(mode === 'NEW'){
      const d = document.getElementById('arrNewDate').value;
      const method = document.getElementById('arrNewMethod').value;
      const maxI = Math.max(...state.schedule.map(r=>r.i));
      state.schedule.push({
        i: maxI + 1,
        date: d,
        total: amt,
        interest: 0.00,
        adhesion: 0.00,
        balance: 0.00,
        adjustment: 0.00,
        status:'√Ä venir',
        paid:false,
        method: method
      });

      item.status = 'RESOLVED';
      const methodLabel = method === 'PPA' ? 'PPA' : '√Ä venir cash';
      logEvent('Souffrance (NOUVELLE LIGNE)', `Souffrance ${money(amt)} d√©plac√©e en nouvelle ligne ${methodLabel} (${fmtDate(d)}).`);
      closeModal();
      renderAll();
      return;
    }

    if(mode === 'LAST'){
      const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
      const lastUnpaid = [...ordered].reverse().find(r => !r.paid && r.status !== 'NSF');
      if(!lastUnpaid) return;

      lastUnpaid.adjustment = clamp2((lastUnpaid.adjustment||0) + amt);
      item.status = 'RESOLVED';
      logEvent('Souffrance (DERNIER)', `Souffrance ${money(amt)} ajout√©e au dernier paiement #${lastUnpaid.i} (${fmtDate(lastUnpaid.date)}).`);
      recalculateBalancesAndInterest();
      closeModal();
      renderAll();
      return;
    }

    if(mode === 'SELECT'){
      const checkedIds = Array.from(document.querySelectorAll('.arrLineChk:checked')).map(x => Number(x.value));
      if(!checkedIds.length) return;

      const perLine = clamp2(amt / checkedIds.length);
      const targets = state.schedule.filter(r => checkedIds.includes(r.i));
      targets.forEach(t => t.adjustment = clamp2((t.adjustment||0) + perLine));

      item.status = 'RESOLVED';
      const lineNums = checkedIds.join(', #');
      logEvent('Souffrance (R√âPARTIE)', `Souffrance ${money(amt)} r√©partie sur ${checkedIds.length} ligne(s): #${lineNums} (+${money(perLine)} chacune).`);
      recalculateBalancesAndInterest();
      closeModal();
      renderAll();
      return;
    }
  }

  // ===== Paiement manuel : ferme des items souffrance OPEN FIFO
  function applyManual(){
    const amt = clamp2(Number(document.getElementById('manualAmt').value || 0));
    const to = document.getElementById('manualTo').value;
    if(amt<=0){ closeModal(); return; }

    if(to === 'arrears'){
      let remaining = amt;
      let closed = 0;

      for(const a of state.arrearsItems){
        if(a.status !== 'OPEN') continue;
        if(remaining >= a.total){
          remaining = clamp2(remaining - a.total);
          a.status = 'RESOLVED';
          closed++;
        } else {
          a.total = clamp2(a.total - remaining);
          remaining = 0;
          break;
        }
      }

      logEvent('Paiement manuel', `Paiement ${money(amt)} appliqu√© √† la souffrance. Items ferm√©s: ${closed}. Reste non utilis√©: ${money(remaining)}.`);
    } else {
      logEvent('Paiement manuel', `Paiement re√ßu ${money(amt)} (note seulement).`);
    }

    closeModal();
    renderAll();
  }

  // ===== Notes
  function applyNote(){
    const txt = (document.getElementById('noteTxt').value || '').trim();
    if(!txt){ closeModal(); return; }
    logEvent('Note', txt);
    closeModal();
    renderAll();
  }

  // ===== Ajout de capital
  function toggleCapitalSelectAll(){
    const selectAll = document.getElementById('capitalSelectAll').checked;
    document.querySelectorAll('.capitalLineChk').forEach(chk => {
      chk.checked = selectAll;
    });
    updateCapitalPreview();
  }

  function updateCapitalPreview(){
    const amt = clamp2(Number(document.getElementById('capitalAmt').value || 0));
    const checkedIds = Array.from(document.querySelectorAll('.capitalLineChk:checked')).map(x => Number(x.value));
    const newCount = Math.max(0, parseInt(document.getElementById('capitalNewCount').value) || 0);

    const totalLines = checkedIds.length + newCount;
    const perLine = totalLines > 0 ? clamp2(amt / totalLines) : 0;

    document.getElementById('capitalCount').textContent = totalLines;
    document.getElementById('capitalPerLine').textContent = totalLines > 0 ? money(perLine) : '-';

    // Update each existing line's new amount
    document.querySelectorAll('.capitalNewAmt').forEach(el => {
      const lineI = Number(el.dataset.i);
      if(checkedIds.includes(lineI)){
        const row = state.schedule.find(r => r.i === lineI);
        const currentTotal = clamp2((row?.total||0) + (row?.adjustment||0));
        el.textContent = money(currentTotal + perLine);
        el.style.color = 'var(--good)';
      } else {
        el.textContent = '-';
        el.style.color = 'var(--muted2)';
      }
    });

    // Update new lines preview
    const previewDiv = document.getElementById('capitalNewLinesPreview');
    if(newCount > 0 && amt > 0){
      previewDiv.innerHTML = `
        <div style="color:var(--good);font-weight:bold">${newCount} nouvelle(s) ligne(s)</div>
        <div style="margin-top:4px">${money(perLine)} par ligne</div>
      `;
    } else {
      previewDiv.innerHTML = `<span style="color:var(--muted2)">Aucune nouvelle ligne</span>`;
    }

    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.capitalLineChk');
    const selectAllChk = document.getElementById('capitalSelectAll');
    if(selectAllChk && allCheckboxes.length > 0){
      selectAllChk.checked = checkedIds.length === allCheckboxes.length;
      selectAllChk.indeterminate = checkedIds.length > 0 && checkedIds.length < allCheckboxes.length;
    }
  }

  function applyCapital(){
    const amt = clamp2(Number(document.getElementById('capitalAmt').value || 0));
    if(amt <= 0){
      alert('Veuillez entrer un montant valide.');
      return;
    }

    const checkedIds = Array.from(document.querySelectorAll('.capitalLineChk:checked')).map(x => Number(x.value));
    const newCount = Math.max(0, parseInt(document.getElementById('capitalNewCount').value) || 0);
    const totalLines = checkedIds.length + newCount;

    if(totalLines === 0){
      alert('Veuillez s√©lectionner des lignes existantes ou ajouter des nouvelles lignes.');
      return;
    }

    const perLine = clamp2(amt / totalLines);
    const d = document.getElementById('capitalNewDate').value;
    const method = document.getElementById('capitalNewMethod').value;
    const methodLabel = method === 'PPA' ? 'PPA' : '√Ä venir cash';

    // Cr√©er une ligne sp√©ciale "CAPITAL" pour indiquer l'ajout de capital
    let maxI = Math.max(...state.schedule.map(r=>r.i));
    maxI++;
    state.schedule.push({
      i: maxI,
      date: d,
      total: amt,
      interest: 0.00,
      adhesion: 0.00,
      balance: 0.00,
      adjustment: 0.00,
      status:'Capital',
      paid: false,
      method: 'CAPITAL',
      isCapitalLine: true,
      capitalAmount: amt
    });
    const capitalLineNum = maxI;

    // Ajouter le capital au solde global (premi√®re ligne non pay√©e apr√®s la ligne capital)
    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
    const firstUnpaid = ordered.find(r => !r.paid && !r.isCapitalLine);
    if(firstUnpaid){
      firstUnpaid.balance = clamp2((firstUnpaid.balance || 0) + amt);
    }

    // R√©partir sur les lignes existantes s√©lectionn√©es
    if(checkedIds.length > 0){
      const targets = state.schedule.filter(r => checkedIds.includes(r.i));
      targets.forEach(t => t.adjustment = clamp2((t.adjustment||0) + perLine));
    }

    // Cr√©er les nouvelles lignes de paiement
    const newLineNums = [];
    for(let i = 0; i < newCount; i++){
      maxI++;
      // Calculer la date (ajouter 14 jours par ligne - bi-hebdomadaire)
      const lineDate = new Date(d);
      lineDate.setDate(lineDate.getDate() + (i * 14));
      const dateStr = lineDate.toISOString().split('T')[0];

      state.schedule.push({
        i: maxI,
        date: dateStr,
        total: perLine,
        interest: 0.00,
        adhesion: 45.00,
        balance: 0.00,
        adjustment: 0.00,
        status:'√Ä venir',
        paid:false,
        method: method
      });
      newLineNums.push(maxI);
    }

    // Log event
    let logMsg = `Capital ${money(amt)} financ√© au client (ligne #${capitalLineNum}).`;
    if(checkedIds.length > 0){
      logMsg += ` R√©parti sur lignes existantes: #${checkedIds.join(', #')} (+${money(perLine)}).`;
    }
    if(newCount > 0){
      logMsg += ` ${newCount} nouvelle(s) ligne(s) cr√©√©e(s): #${newLineNums.join(', #')} (${methodLabel}, ${money(perLine)} chacune).`;
    }
    logEvent('üí∞ Ajout capital', logMsg);

    // Recalculer les soldes et int√©r√™ts
    recalculateBalancesAndInterest();
    closeModal();
    renderAll();
  }

  // ===== Entente fixe
  function toggleEntenteSelectAll(){
    const selectAll = document.getElementById('ententeSelectAll').checked;
    document.querySelectorAll('.ententeChk').forEach(chk => {
      chk.checked = selectAll;
    });
    updateEntentePreview();
  }

  function updateEntentePreview(){
    const amt = clamp2(Number(document.getElementById('ententeAmt').value || 0));
    const checkedIds = Array.from(document.querySelectorAll('.ententeChk:checked')).map(x => Number(x.value));
    const count = checkedIds.length;
    const totalEntente = clamp2(amt * count);

    // Calculer le montant original total des lignes s√©lectionn√©es
    let originalTotal = 0;
    checkedIds.forEach(id => {
      const row = state.schedule.find(r => r.i === id);
      if(row){
        const orig = originalSchedule.find(o => o.i === id);
        originalTotal += orig ? orig.total : (row.total || 0);
      }
    });
    originalTotal = clamp2(originalTotal);

    // Diff√©rence (montant restant √† placer)
    const difference = clamp2(originalTotal - totalEntente);

    document.getElementById('ententeCount').textContent = count;
    document.getElementById('ententeTotal').textContent = money(totalEntente);
    document.getElementById('ententeOriginal').textContent = money(originalTotal);
    document.getElementById('ententeDiff').textContent = money(difference);

    // Mettre √† jour le nouveau montant pour chaque ligne
    document.querySelectorAll('.ententeNewAmt').forEach(el => {
      const lineId = Number(el.dataset.i);
      const isChecked = checkedIds.includes(lineId);
      if(isChecked && amt > 0){
        el.innerHTML = money(amt);
        el.style.color = 'var(--good)';
      } else {
        el.innerHTML = '-';
        el.style.color = 'var(--muted2)';
      }
    });

    // Afficher/masquer le contenu de la section diff√©rence
    const diffEmpty = document.getElementById('ententeDiffEmpty');
    const diffTargets = document.getElementById('ententeDiffTargets');
    const diffMode = document.getElementById('ententeDiffMode');
    if(difference > 0){
      if(diffEmpty) diffEmpty.style.display = 'none';
      if(diffMode) diffMode.style.display = 'block';
      onEntenteDiffModeChange();
    } else {
      if(diffEmpty) diffEmpty.style.display = 'block';
      if(diffTargets) diffTargets.style.display = 'none';
      if(diffMode) diffMode.style.display = 'none';
    }

    // Mettre √† jour le "select all" checkbox
    const allCheckboxes = document.querySelectorAll('.ententeChk');
    const selectAllChk = document.getElementById('ententeSelectAll');
    if(selectAllChk){
      selectAllChk.checked = allCheckboxes.length > 0 && checkedIds.length === allCheckboxes.length;
    }

    // Mettre √† jour le r√©capitulatif
    updateEntenteSummary();
  }

  function updateEntenteSummary(){
    const summaryDiv = document.getElementById('ententeSummary');
    const contentDiv = document.getElementById('ententeSummaryContent');
    if(!summaryDiv || !contentDiv) return;

    const amt = clamp2(Number(document.getElementById('ententeAmt').value || 0));
    const checkedIds = Array.from(document.querySelectorAll('.ententeChk:checked')).map(x => Number(x.value));

    if(checkedIds.length === 0 || amt <= 0){
      summaryDiv.style.display = 'none';
      return;
    }

    // Calculer la diff√©rence
    let originalTotal = 0;
    checkedIds.forEach(id => {
      const orig = originalSchedule.find(o => o.i === id);
      const row = state.schedule.find(r => r.i === id);
      originalTotal += orig ? orig.total : (row ? row.total : 0);
    });
    const totalEntente = clamp2(amt * checkedIds.length);
    const difference = clamp2(originalTotal - totalEntente);

    let html = '';

    // Lignes avec montant fixe
    html += `<div style="margin-bottom:6px"><b>Paiements r√©duits √† ${money(amt)}:</b></div>`;
    checkedIds.forEach(id => {
      const row = state.schedule.find(r => r.i === id);
      if(row){
        html += `<div style="padding-left:10px;color:var(--text)">‚Ä¢ #${id} (${fmtDate(row.date)}): <span style="color:var(--good);font-weight:bold">${money(amt)}</span></div>`;
      }
    });

    // Diff√©rence √† placer
    if(difference > 0){
      const diffMode = document.getElementById('ententeDiffMode')?.value || 'SELECT';
      html += `<div style="margin-top:8px;margin-bottom:6px"><b>Diff√©rence de ${money(difference)} plac√©e sur:</b></div>`;

      if(diffMode === 'SELECT'){
        const diffTargetIds = Array.from(document.querySelectorAll('.ententeDiffChk:checked')).map(x => Number(x.value));
        if(diffTargetIds.length > 0){
          const perLine = clamp2(difference / diffTargetIds.length);
          diffTargetIds.forEach(id => {
            const row = state.schedule.find(r => r.i === id);
            if(row){
              const currentTotal = clamp2((row.total||0)+(row.adjustment||0));
              const newTotal = clamp2(currentTotal + perLine);
              html += `<div style="padding-left:10px;color:var(--text)">‚Ä¢ #${id} (${fmtDate(row.date)}): ${money(currentTotal)} <span style="color:var(--warn)">+${money(perLine)}</span> = <span style="color:var(--good);font-weight:bold">${money(newTotal)}</span></div>`;
            }
          });
        } else {
          html += `<div style="padding-left:10px;color:var(--warn)">‚ö†Ô∏è S√©lectionnez des lignes ci-dessus</div>`;
        }
      } else if(diffMode === 'NEW'){
        html += `<div style="padding-left:10px;color:var(--text)">‚Ä¢ Nouvelle ligne √† la fin: <span style="color:var(--good);font-weight:bold">${money(difference + getAdhesionFee())}</span></div>`;
      } else if(diffMode === 'LAST'){
        const lastLine = [...state.schedule].filter(r => !r.paid && r.status !== 'NSF' && r.status !== 'Frais report').sort((a,b) => b.date.localeCompare(a.date))[0];
        if(lastLine){
          const currentTotal = clamp2((lastLine.total||0)+(lastLine.adjustment||0));
          const newTotal = clamp2(currentTotal + difference);
          html += `<div style="padding-left:10px;color:var(--text)">‚Ä¢ #${lastLine.i} (${fmtDate(lastLine.date)}): ${money(currentTotal)} <span style="color:var(--warn)">+${money(difference)}</span> = <span style="color:var(--good);font-weight:bold">${money(newTotal)}</span></div>`;
        }
      }
    }

    contentDiv.innerHTML = html;
    summaryDiv.style.display = 'block';
  }

  function onEntenteDiffModeChange(){
    const mode = document.getElementById('ententeDiffMode').value;
    const targetsDiv = document.getElementById('ententeDiffTargets');

    if(mode === 'SELECT'){
      // Afficher la liste des lignes non s√©lectionn√©es pour l'entente
      const checkedIds = Array.from(document.querySelectorAll('.ententeChk:checked')).map(x => Number(x.value));
      const ordered = [...state.schedule].sort((a,b) => a.date.localeCompare(b.date));
      const availableForDiff = ordered.filter(r =>
        !checkedIds.includes(r.i) &&
        !r.paid &&
        r.status !== 'NSF' &&
        r.status !== 'Frais report'
      );

      targetsDiv.innerHTML = availableForDiff.map(t => {
        const total = clamp2((t.total||0)+(t.adjustment||0));
        return `
          <div style="display:grid;grid-template-columns:20px 1fr 60px 60px;gap:4px;padding:6px 6px;border-radius:6px;align-items:center;font-size:11px" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" class="ententeDiffChk" value="${t.i}" onchange="updateDiffPreview()" style="width:15px;height:15px"/>
            <div><span style="color:var(--muted2)">#${t.i}</span> ${fmtDate(t.date)}</div>
            <div class="diffAdded" data-i="${t.i}" style="text-align:right;font-weight:bold;color:var(--warn)">-</div>
            <div class="diffPreview" data-i="${t.i}" style="text-align:right;font-weight:bold;color:var(--good)">-</div>
          </div>
        `;
      }).join('');
      targetsDiv.style.display = 'block';
      const emptyDiv = document.getElementById('ententeDiffEmpty');
      if(emptyDiv) emptyDiv.style.display = 'none';
      updateDiffPreview();
    } else {
      targetsDiv.style.display = 'none';
      updateEntenteSummary();
    }
  }

  function updateDiffPreview(){
    const diffCheckedIds = Array.from(document.querySelectorAll('.ententeDiffChk:checked')).map(x => Number(x.value));
    const numDiffLines = diffCheckedIds.length;

    // Calculer la diff√©rence actuelle
    const amt = clamp2(Number(document.getElementById('ententeAmt').value || 0));
    const ententeCheckedIds = Array.from(document.querySelectorAll('.ententeChk:checked')).map(x => Number(x.value));
    let originalTotal = 0;
    ententeCheckedIds.forEach(id => {
      const orig = originalSchedule.find(o => o.i === id);
      const row = state.schedule.find(r => r.i === id);
      originalTotal += orig ? orig.total : (row ? row.total : 0);
    });
    const totalEntente = clamp2(amt * ententeCheckedIds.length);
    const difference = clamp2(originalTotal - totalEntente);

    // Montant par ligne si r√©parti
    const perLine = numDiffLines > 0 ? clamp2(difference / numDiffLines) : 0;

    // Mettre √† jour l'aper√ßu pour chaque ligne (montant ajout√© et nouveau total)
    document.querySelectorAll('.diffPreview').forEach(el => {
      const lineId = Number(el.dataset.i);
      const isChecked = diffCheckedIds.includes(lineId);
      const row = state.schedule.find(r => r.i === lineId);
      const currentTotal = row ? clamp2((row.total||0)+(row.adjustment||0)) : 0;

      // Trouver l'√©l√©ment "Ajout√©" correspondant
      const addedEl = document.querySelector(`.diffAdded[data-i="${lineId}"]`);

      if(isChecked && perLine > 0){
        const newTotal = clamp2(currentTotal + perLine);
        el.innerHTML = money(newTotal);
        el.style.color = 'var(--good)';
        if(addedEl){
          addedEl.innerHTML = '+' + money(perLine);
          addedEl.style.color = 'var(--warn)';
        }
      } else {
        el.innerHTML = '-';
        el.style.color = 'var(--muted2)';
        if(addedEl){
          addedEl.innerHTML = '-';
          addedEl.style.color = 'var(--muted2)';
        }
      }
    });

    // Mettre √† jour le r√©capitulatif
    updateEntenteSummary();
  }

  function applyEntente(){
    const amt = clamp2(Number(document.getElementById('ententeAmt').value || 0));
    const adhesion = getAdhesionFee();

    if(amt <= 0){
      alert('Veuillez entrer un montant fixe valide.');
      return;
    }

    const checkedIds = Array.from(document.querySelectorAll('.ententeChk:checked')).map(x => Number(x.value));

    if(checkedIds.length === 0){
      alert('Veuillez s√©lectionner au moins une ligne.');
      return;
    }

    // Calculer le montant original et la diff√©rence
    let originalTotal = 0;
    checkedIds.forEach(id => {
      const orig = originalSchedule.find(o => o.i === id);
      const row = state.schedule.find(r => r.i === id);
      originalTotal += orig ? orig.total : (row ? row.total : 0);
    });
    const totalEntente = clamp2(amt * checkedIds.length);
    const difference = clamp2(originalTotal - totalEntente);

    // Appliquer le montant fixe √† chaque ligne s√©lectionn√©e
    checkedIds.forEach(id => {
      const row = state.schedule.find(r => r.i === id);
      if(row){
        row.total = amt;
        row.adhesion = adhesion;
        row.ententeApplied = true; // Marquer comme modifi√© par entente
      }
    });

    // G√©rer le montant restant si > 0
    if(difference > 0){
      const diffMode = document.getElementById('ententeDiffMode').value;

      if(diffMode === 'SELECT'){
        // R√©partir sur les lignes s√©lectionn√©es manuellement
        const diffTargetIds = Array.from(document.querySelectorAll('.ententeDiffChk:checked')).map(x => Number(x.value));

        if(diffTargetIds.length === 0){
          alert('Veuillez s√©lectionner au moins une ligne pour placer la diff√©rence.');
          return;
        }

        const perLine = clamp2(difference / diffTargetIds.length);
        diffTargetIds.forEach(id => {
          const row = state.schedule.find(r => r.i === id);
          if(row){
            row.adjustment = clamp2((row.adjustment || 0) + perLine);
          }
        });

        const targetNums = diffTargetIds.map(id => '#' + id).join(', ');
        logEvent('üìã Entente fixe', `Diff√©rence ${money(difference)} r√©partie sur lignes: ${targetNums} (+${money(perLine)} chacune)`);

      } else if(diffMode === 'NEW'){
        // Ajouter une nouvelle ligne √† la fin
        const lastDate = [...state.schedule].sort((a,b) => b.date.localeCompare(a.date))[0];
        const newDate = new Date(lastDate.date + 'T00:00:00');
        newDate.setDate(newDate.getDate() + getPaymentFrequency());
        const dateStr = newDate.toISOString().split('T')[0];

        const maxI = Math.max(...state.schedule.map(r => r.i));
        state.schedule.push({
          i: maxI + 1,
          date: dateStr,
          total: clamp2(difference + adhesion),
          interest: 0,
          adhesion: adhesion,
          balance: 0,
          adjustment: 0,
          status: '√Ä venir',
          paid: false,
          method: 'PAD',
          ententeApplied: true
        });

        logEvent('üìã Entente fixe', `Nouvelle ligne #${maxI + 1} cr√©√©e pour le montant restant: ${money(difference + adhesion)}`);

      } else if(diffMode === 'LAST'){
        // Ajouter au dernier paiement existant
        const lastLine = [...state.schedule]
          .filter(r => !r.paid && r.status !== 'NSF' && r.status !== 'Frais report')
          .sort((a,b) => b.date.localeCompare(a.date))[0];

        if(lastLine){
          lastLine.adjustment = clamp2((lastLine.adjustment || 0) + difference);
          logEvent('üìã Entente fixe', `Montant restant ${money(difference)} ajout√© √† la derni√®re ligne #${lastLine.i}`);
        }
      }
    }

    // Recalculer tout
    recalculateBalancesAndInterest();

    // Log principal
    const lineNums = checkedIds.map(id => '#' + id).join(', ');
    logEvent('üìã Note client', `Entente de paiement fixe √©tablie. Nouveau montant par paiement: ${money(amt)} (incluant ${money(adhesion)} d'adh√©sion). Lignes concern√©es: ${lineNums}. Diff√©rence: ${money(difference)}.`);

    closeModal();
    renderAll();
  }

  // ===== Init
  resetDemo(true); // skip confirmation on initial load

  // expose for inline handlers
  window.onRepPlanChange = onRepPlanChange;
  window.validateRepSelection = validateRepSelection;
  window.applyReportV4 = applyReportV4;

  window.onArrPlanChange = onArrPlanChange;
  window.validateArrSelection = validateArrSelection;
  window.applyArrearsResolve = applyArrearsResolve;

  window.openArrearsResolver = openArrearsResolver;
  window.openFirstArrears = openFirstArrears;
  window.toggleArrSelectAll = toggleArrSelectAll;
  window.updateArrPreview = updateArrPreview;
  window.onArrModeChange = onArrModeChange;

  window.toggleEntenteSelectAll = toggleEntenteSelectAll;
  window.updateEntentePreview = updateEntentePreview;
  window.onEntenteDiffModeChange = onEntenteDiffModeChange;
  window.updateDiffPreview = updateDiffPreview;
  window.applyEntente = applyEntente;

  window.toggleCapitalSelectAll = toggleCapitalSelectAll;
  window.updateCapitalPreview = updateCapitalPreview;
  window.applyCapital = applyCapital;

  window.editCell = editCell;
</script>
</body>
</html>
