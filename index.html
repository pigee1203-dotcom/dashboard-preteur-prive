<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard pr√™teur priv√© ‚Äî V2</title>
  <style>
    :root{
      --bg:#0b1220;
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r:16px;
      --r2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(900px 650px at 60% 120%, rgba(251,113,133,.10), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin:6px 0 12px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(96,165,250,.9), rgba(45,212,191,.75));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 12px 30px rgba(96,165,250,.18);
    }
    h1{font-size:16px;margin:0}
    .sub{color:var(--muted2);font-size:12px;margin-top:2px}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}

    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .ph{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .ph h2{margin:0;font-size:13px}
    .ph small{color:var(--muted2)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      color:var(--text);
      padding:9px 10px;border-radius:14px;font-size:12px;
      cursor:pointer;display:flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{border-color:rgba(96,165,250,.45); background:rgba(96,165,250,.16)}
    .btn.danger{border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.14)}
    .btn.ghost{background:transparent}
    .btn.disabled{opacity:.45; pointer-events:none;}

    .hint{color:var(--muted2);font-size:12px;padding:10px 14px 0}

    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px;}
    th, td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;white-space:nowrap;}
    th{
      position:sticky;top:0;z-index:2;
      background:rgba(10,18,32,.85);
      backdrop-filter: blur(12px);
      color:var(--muted);
      font-weight:600;
    }
    tr:hover td{background:rgba(255,255,255,.04)}
    .status{
      padding:5px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;
      display:inline-flex;align-items:center;gap:8px;
      color:var(--muted);
    }
    .mono{font-family:var(--mono)}
    .section{padding:14px}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .item{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .k{color:var(--muted2);font-size:11px}
    .v{margin-top:6px;font-weight:700}
    .box{
      margin-top:12px;padding:10px;border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      max-height:250px;overflow:auto;
    }
    .rowA{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      margin-bottom:8px;
    }
    .rowA:hover{background:rgba(255,255,255,.05)}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;color:var(--muted);
    }
    .calc{font-family:var(--mono);font-size:12px;color:var(--muted);margin-top:6px}
    .calc b{color:var(--text)}
    .events{display:flex;flex-direction:column;gap:8px;margin-top:12px;max-height:260px;overflow:auto}
    .note{
      padding:10px 12px;border-radius:12px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .note .meta{color:var(--muted2);font-size:11px;display:flex;justify-content:space-between;gap:8px}
    .note .txt{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.4}

    /* Modal */
    .modalOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:16px;
    }
    .modal{
      width:min(760px, 100%);
      background:rgba(16,31,59,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius:22px;
      box-shadow:0 30px 100px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .mh{
      padding:14px;border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .mh h3{margin:0;font-size:14px}
    .mb{padding:14px;max-height:65vh;overflow-y:auto}
    .mf{
      padding:12px 14px;border-top:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
    }
    .field{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      margin-bottom:10px;
    }
    .field label{display:block;color:var(--muted2);font-size:11px;margin-bottom:8px}
    .field input, .field select{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px;border-radius:12px;outline:none;font-size:13px
    }
    .field select option{background:#1a2332;color:#fff}
    .listBox{
      padding:8px;border-radius:14px;background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      max-height:220px;overflow:auto;
    }
    .chk{
      display:grid;grid-template-columns:20px 1fr auto;gap:8px;align-items:center;
      padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);margin-bottom:6px;
    }
    .chk:hover{background:rgba(255,255,255,.06)}
    .chk .t{font-size:12px;font-weight:500}
    .chk .m{color:var(--muted2);font-size:11px}
    .sum{
      padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--muted);font-size:12.5px;line-height:1.45
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Dashboard pr√™teur priv√© ‚Äî V2 (propre)</h1>
          <div class="sub">M√™me logique: calendrier + reporter + NSF‚Üísouffrance + traitement</div>
        </div>
      </div>
      <div class="pill"><span class="dot warn"></span> D√©mo</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="ph">
          <div>
            <h2>Calendrier des paiements</h2>
            <small id="subHeader">26 paiements ¬∑ 14 jours ¬∑ Adh√©sion 45,00$</small>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="openAction('report')">üìÖ Reporter</button>
            <button class="btn danger" onclick="openAction('nsf')">‚ùå NSF</button>
            <button class="btn ghost" onclick="resetDemo()">‚Ü©Ô∏è Reset</button>
          </div>
        </div>
        <div class="hint">Clique une ligne. Reporter = r√©partir 1‚Äì5 / tous / nouvelle ligne virement. NSF = souffrance (paiement + 48$) √† traiter.</div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Date</th><th>Type</th><th>Total</th><th>Int√©r√™t</th><th>Adh√©sion</th><th>Ajustement</th><th>Statut</th><th>Solde avant</th><th>Solde apr√®s</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="panel">
          <div class="ph">
            <div>
              <h2>Client + Souffrance</h2>
              <small>NSF est ici (pas une section s√©par√©e)</small>
            </div>
            <div class="pill"><span class="dot good"></span> Actif</div>
          </div>

          <div class="section">
            <div class="kv">
              <div class="item"><div class="k">Client</div><div class="v">Marc Savoie <span class="mono" style="color:var(--muted2)">#10023</span></div></div>
              <div class="item"><div class="k">Montant financ√©</div><div class="v mono">2 250,00 $</div></div>
              <div class="item"><div class="k">Souffrance actuelle</div><div class="v mono" id="rightArrears">0,00 $</div></div>
              <div class="item"><div class="k">Prochain pr√©l√®vement</div><div class="v" id="rightNext">15 nov 2024 ¬∑ <span class="mono">147,92 $</span></div></div>
            </div>

            <div class="box" id="arrearsList"></div>

            <div class="events" id="events"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mh">
        <h3 id="modalTitle">Action</h3>
        <button class="btn" onclick="closeModal()">‚úï Fermer</button>
      </div>
      <div class="mb" id="modalBody"></div>
      <div class="mf" id="modalFoot"></div>
    </div>
  </div>

<script>
  // ===== Utilities
  const money = (n) => (Number(n||0)).toLocaleString('fr-CA',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' $';
  const fmtDate = (iso) => new Date(iso+'T00:00:00').toLocaleDateString('fr-CA',{day:'2-digit',month:'short',year:'numeric'}).replace('.','');
  const clamp2 = (n) => Math.round((Number(n)||0)*100)/100;

  // ===== Original schedule (ton √©tat actuel)
  const originalSchedule = [
    {i:1,  date:'2024-11-15', total:147.92, interest:  9.62, adhesion:45.00, balance:2156.70},
    {i:2,  date:'2024-11-29', total:147.19, interest: 16.15, adhesion:45.00, balance:2070.66},
    {i:3,  date:'2024-12-13', total:146.56, interest: 15.51, adhesion:45.00, balance:1984.61},
    {i:4,  date:'2024-12-27', total:145.94, interest: 14.87, adhesion:45.00, balance:1898.54},
    {i:5,  date:'2025-01-10', total:145.31, interest: 14.22, adhesion:45.00, balance:1812.45},
    {i:6,  date:'2025-01-24', total:144.72, interest: 13.61, adhesion:45.00, balance:1726.34},
    {i:7,  date:'2025-02-07', total:144.09, interest: 12.97, adhesion:45.00, balance:1640.22},
    {i:8,  date:'2025-02-21', total:143.47, interest: 12.32, adhesion:45.00, balance:1554.07},
    {i:9,  date:'2025-03-07', total:142.84, interest: 11.67, adhesion:45.00, balance:1467.90},
    {i:10, date:'2025-03-21', total:142.21, interest: 11.03, adhesion:45.00, balance:1381.72},
    {i:11, date:'2025-04-04', total:141.58, interest: 10.38, adhesion:45.00, balance:1295.52},
    {i:12, date:'2025-04-18', total:140.95, interest:  9.73, adhesion:45.00, balance:1209.30},
    {i:13, date:'2025-05-02', total:140.33, interest:  9.08, adhesion:45.00, balance:1123.05},
    {i:14, date:'2025-05-16', total:139.70, interest:  8.44, adhesion:45.00, balance:1036.79},
    {i:15, date:'2025-05-30', total:139.07, interest:  7.79, adhesion:45.00, balance: 950.51},
    {i:16, date:'2025-06-13', total:138.44, interest:  7.14, adhesion:45.00, balance: 864.21},
    {i:17, date:'2025-06-27', total:137.82, interest:  6.49, adhesion:45.00, balance: 777.88},
    {i:18, date:'2025-07-11', total:137.19, interest:  5.84, adhesion:45.00, balance: 691.53},
    {i:19, date:'2025-07-25', total:136.56, interest:  5.19, adhesion:45.00, balance: 605.16},
    {i:20, date:'2025-08-08', total:135.93, interest:  4.55, adhesion:45.00, balance: 518.78},
    {i:21, date:'2025-08-22', total:135.31, interest:  3.90, adhesion:45.00, balance: 432.37},
    {i:22, date:'2025-09-05', total:134.68, interest:  3.25, adhesion:45.00, balance: 345.94},
    {i:23, date:'2025-09-19', total:134.05, interest:  2.60, adhesion:45.00, balance: 259.49},
    {i:24, date:'2025-10-03', total:133.42, interest:  1.95, adhesion:45.00, balance: 173.02},
    {i:25, date:'2025-10-17', total:132.80, interest:  1.30, adhesion:45.00, balance:  86.52},
    {i:26, date:'2025-10-26', total:132.17, interest:  0.42, adhesion:45.00, balance:   0.00},
  ];

  function getPaymentFrequency(){
    const dates = originalSchedule.map(r => new Date(r.date+'T00:00:00')).sort((a,b)=>a-b);
    const diff = Math.round((dates[1]-dates[0])/(1000*60*60*24));
    return diff <= 10 ? 7 : 14;
  }
  function getAdhesionFee(){ return getPaymentFrequency() === 7 ? 22.50 : 45.00; }

  const loanConfig = {
    initialBalance: 2250.00,
    originDate: '2024-11-07',
    nominalRate: 0.1899,
    effectiveRate: 0.1952
  };

  function daysBetween(date1, date2){
    const d1 = new Date(date1+'T00:00:00');
    const d2 = new Date(date2+'T00:00:00');
    return Math.round((d2 - d1) / (1000*60*60*24));
  }

  // ===== State
  let state = { schedule: [], selected: 1, arrearsItems: [], events: [] };

  function arrearsTotal(){
    return clamp2(state.arrearsItems.filter(a=>a.status==='OPEN').reduce((s,a)=>s+(a.total||0),0));
  }
  function logEvent(title, txt){ state.events.push({ts:new Date().toISOString(), title, txt}); }

  // ===== Recalc (copie du m√™me comportement que ton fichier)
  function recalculateBalancesAndInterest(){
    const dailyRate = loanConfig.effectiveRate / 365;
    const adhesionFee = getAdhesionFee();
    const ordered = [...state.schedule].sort((a,b)=> a.date.localeCompare(b.date));

    let hasModifications = false;
    for(const row of ordered){
      const orig = originalSchedule.find(o=>o.i===row.i);
      if((row.adjustment||0)!==0 || row.status==='NSF' || row.status==='Frais report' || !orig || row.ententeApplied){
        hasModifications = true; break;
      }
    }
    if(!hasModifications){
      let prevBal = loanConfig.initialBalance;
      ordered.forEach(row=>{
        const orig = originalSchedule.find(o=>o.i===row.i);
        row.balanceBefore = clamp2(prevBal);
        if(orig){
          row.interest = orig.interest;
          row.balance = orig.balance;
          row.total = orig.total;
          row.adhesion = orig.adhesion;
          prevBal = orig.balance;
        }
      });
      state.schedule = ordered; return;
    }

    const linesToRedistribute = [];
    for(let idx=0; idx<ordered.length; idx++){
      const row = ordered[idx];
      if(row.status==='NSF' || row.status==='Frais report') continue;
      if((row.adjustment||0)!==0 || row.ententeApplied) continue;
      linesToRedistribute.push({idx,row});
    }

    let tempBalance = loanConfig.initialBalance;
    let prevDate = loanConfig.originDate;

    for(const row of ordered){
      const orig = originalSchedule.find(o=>o.i===row.i);
      const days = Math.max(1, daysBetween(prevDate, row.date));

      if(row.status==='Frais report' || row.status==='NSF'){ prevDate=row.date; continue; }

      const interest = clamp2(tempBalance * dailyRate * days);

      let totalCollect;
      if(row.ententeApplied){
        totalCollect = row.total || 0;
      } else {
        const baseTotal = orig ? orig.total : (row.total || 0);
        totalCollect = clamp2(baseTotal + (row.adjustment||0));
      }

      const adhesion = row.adhesion || (orig ? orig.adhesion : adhesionFee);
      const loanPart = clamp2(totalCollect - adhesion);
      const capitalPaid = Math.max(0, clamp2(loanPart - interest));
      tempBalance = clamp2(tempBalance - capitalPaid);
      prevDate = row.date;
    }

    const deficit = tempBalance;
    const numLines = linesToRedistribute.length;
    const adjustmentPerLine = numLines>0 ? clamp2(deficit/numLines) : 0;

    let runningBalance = loanConfig.initialBalance;
    prevDate = loanConfig.originDate;

    for(const row of ordered){
      const orig = originalSchedule.find(o=>o.i===row.i);
      const days = Math.max(1, daysBetween(prevDate, row.date));
      row.balanceBefore = clamp2(runningBalance);

      if(row.status==='Frais report'){
        row.interest = 0; row.balance = clamp2(runningBalance);
        prevDate = row.date; continue;
      }
      if(row.status==='NSF'){
        row.interest = clamp2(runningBalance * dailyRate * days);
        row.balance = clamp2(runningBalance);
        prevDate = row.date; continue;
      }

      row.interest = clamp2(runningBalance * dailyRate * days);

      const baseTotal = orig ? orig.total : (row.total || 0);
      const adhesion = row.adhesion || (orig ? orig.adhesion : adhesionFee);
      row.adhesion = adhesion;

      const hasAdj = (row.adjustment||0)!==0;
      const hasEnt = row.ententeApplied===true;

      if(hasEnt){
        const totalCollect = row.total || 0;
        const loanPart = clamp2(totalCollect - adhesion);
        const capitalPaid = Math.max(0, clamp2(loanPart - row.interest));
        runningBalance = clamp2(runningBalance - capitalPaid);
      } else if(hasAdj){
        row.total = baseTotal;
        const totalCollect = clamp2(baseTotal + row.adjustment);
        const loanPart = clamp2(totalCollect - adhesion);
        const capitalPaid = Math.max(0, clamp2(loanPart - row.interest));
        runningBalance = clamp2(runningBalance - capitalPaid);
      } else {
        const newLoanPart = clamp2((baseTotal - adhesion) + adjustmentPerLine);
        row.total = clamp2(newLoanPart + adhesion);
        const capitalPaid = Math.max(0, clamp2(newLoanPart - row.interest));
        runningBalance = clamp2(runningBalance - capitalPaid);
      }

      row.balance = clamp2(runningBalance);
      prevDate = row.date;
    }

    let lastIdx = -1;
    for(let i=ordered.length-1;i>=0;i--){
      if(ordered[i].status!=='NSF' && ordered[i].status!=='Frais report'){ lastIdx=i; break; }
    }
    if(lastIdx>=0 && ordered[lastIdx].balance!==0){
      const lastRow = ordered[lastIdx];
      const rem = lastRow.balance;
      const currentLoanPart = clamp2(lastRow.total - lastRow.adhesion);
      const newLoanPart = clamp2(currentLoanPart + rem);
      lastRow.total = clamp2(newLoanPart + lastRow.adhesion);
      lastRow.balance = 0;
    }

    state.schedule = ordered;
  }

  // ===== Render
  function renderTable(){
    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
    const tbody = document.getElementById('rows');

    tbody.innerHTML = ordered.map(r=>{
      const sel = r.i===state.selected;
      const totalToCollect = clamp2((r.total||0)+(r.adjustment||0));
      const statusDot =
        r.status==='NSF' ? 'bad' :
        r.status==='Frais report' ? 'warn' :
        (r.paid ? 'good' : 'warn');

      const statusLabel =
        r.status==='NSF' ? 'NSF' :
        r.status==='Frais report' ? 'Frais report' :
        (r.paid ? 'Pay√©' : '√Ä venir');

      return `
        <tr onclick="selectRow(${r.i})" style="${sel?'background:rgba(96,165,250,.08)':''}">
          <td class="mono">${r.i}</td>
          <td>${fmtDate(r.date)}</td>
          <td>${r.method||'PAD'}</td>
          <td class="mono">${money(totalToCollect)}</td>
          <td class="mono">${money(r.interest||0)}</td>
          <td class="mono">${money(r.adhesion||0)}</td>
          <td class="mono">${money(r.adjustment||0)}</td>
          <td><span class="status"><span class="dot ${statusDot}"></span>${statusLabel}</span></td>
          <td class="mono">${money(r.balanceBefore||0)}</td>
          <td class="mono">${money(r.balance||0)}</td>
        </tr>
      `;
    }).join('');

    const next = ordered.find(x=>!x.paid) || ordered[0];
    document.getElementById('rightArrears').textContent = money(arrearsTotal());
    document.getElementById('rightNext').innerHTML = `${fmtDate(next.date)} ¬∑ <span class="mono">${money((next.total||0)+(next.adjustment||0))}</span>`;
  }

  function renderArrearsList(){
    const box = document.getElementById('arrearsList');
    if(!box) return;

    const open = state.arrearsItems
      .filter(a=>a.status==='OPEN')
      .sort((a,b)=> new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

    if(open.length===0){
      box.innerHTML = `<div style="color:var(--muted2); font-size:12px; padding:6px 4px;">Aucune souffrance ouverte.</div>`;
      return;
    }

    box.innerHTML = open.map(a=>{
      const dateStr = new Date(a.createdAt).toLocaleString('fr-CA',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
      return `
        <div class="rowA">
          <div style="min-width:0">
            <div style="display:flex;gap:8px;align-items:center">
              <span class="tag"><span class="dot bad"></span> NSF</span>
              <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Ligne #${a.sourceLine}</span>
            </div>
            <div class="calc">${money(a.amount)} + ${money(a.fee)} = <b>${money(a.total)}</b></div>
            <div style="color:var(--muted2);font-size:11px;margin-top:4px">${dateStr}</div>
          </div>
          <div class="actions">
            <button class="btn danger" onclick="openArrearsResolver('${a.id}')">Traiter</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderEvents(){
    const items = [...state.events].slice(-12).reverse();
    const el = document.getElementById('events');
    el.innerHTML = items.map(e=>{
      const d = new Date(e.ts);
      return `
        <div class="note">
          <div class="meta">
            <span>${e.title}</span>
            <span class="mono">${d.toLocaleDateString('fr-CA',{day:'2-digit',month:'short'})} ${d.toLocaleTimeString('fr-CA',{hour:'2-digit',minute:'2-digit'})}</span>
          </div>
          <div class="txt">${e.txt}</div>
        </div>
      `;
    }).join('');
  }

  function renderAll(){ renderTable(); renderArrearsList(); renderEvents(); }
  function selectRow(i){ state.selected=i; renderAll(); }

  // ===== Modal helpers
  function closeModal(ev){
    if(ev && ev.target && ev.target.id !== 'overlay') return;
    document.getElementById('overlay').style.display='none';
  }

  // ===== Actions (minimal mais identique dans l‚Äôesprit)
  function openAction(kind){
    const row = state.schedule.find(r=>r.i===state.selected) || state.schedule[0];
    const overlay = document.getElementById('overlay');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    const foot = document.getElementById('modalFoot');

    if(kind==='nsf'){
      title.textContent = '‚ùå NSF ‚Üí Souffrance automatique';
      const pay = clamp2((row.total||0)+(row.adjustment||0));
      body.innerHTML = `
        <div class="field">
          <label>Ligne NSF</label>
          <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ ${money(pay)}" />
        </div>
        <div class="field">
          <label>Frais NSF</label>
          <input id="nsfFee" type="number" step="0.01" value="48.00" />
        </div>
        <div class="sum">Souffrance = paiement + frais NSF. Elle sera visible √† droite.</div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn danger" onclick="applyNSF()">Confirmer NSF</button>
      `;
      overlay.style.display='flex';
      return;
    }

    if(kind==='report'){
      title.textContent = 'üìÖ Reporter un paiement';
      const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date)||a.i-b.i));
      const targets = ordered.filter(r=> r.i!==row.i && !r.paid && r.status!=='NSF' && r.status!=='Frais report' && (r.method||'PAD')==='PAD');

      body.innerHTML = `
        <div class="field">
          <label>Ligne source</label>
          <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)}" />
        </div>
        <div class="field">
          <label>Montant √† d√©placer</label>
          <input id="repAmt" type="number" step="0.01" value="${clamp2((row.total||0)+(row.adjustment||0))}" />
        </div>
        <div class="field">
          <label>R√©partir sur</label>
          <select id="repPlan">
            <option value="AUTO_1">1 paiement</option>
            <option value="AUTO_2">2 paiements</option>
            <option value="AUTO_3">3 paiements</option>
            <option value="AUTO_4">4 paiements</option>
            <option value="AUTO_5">5 paiements</option>
            <option value="ALL">TOUS les paiements √† venir</option>
          </select>
        </div>
        <div class="sum">R√®gle: la ligne source devient ‚ÄúFrais report‚Äù (25$), et le montant est r√©parti (+ ajustement) sur les lignes cibles.</div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="applyReportV4()">Confirmer</button>
      `;
      overlay.style.display='flex';
      return;
    }
  }

  function applyNSF(){
    const row = state.schedule.find(r=>r.i===state.selected);
    const fee = clamp2(Number(document.getElementById('nsfFee').value || 48));
    const pay = clamp2((row.total||0)+(row.adjustment||0));
    const total = clamp2(pay + fee);

    row.status='NSF';

    const id='A'+Date.now();
    state.arrearsItems.push({id,type:'NSF',sourceLine:row.i,amount:pay,fee,total,status:'OPEN',createdAt:new Date().toISOString()});
    logEvent('NSF', `NSF sur #${row.i}. Souffrance: ${money(pay)} + ${money(fee)} = ${money(total)}.`);

    recalculateBalancesAndInterest();
    closeModal();
    renderAll();
  }

  function applyReportV4(){
    const row = state.schedule.find(r=>r.i===state.selected);
    const fee = 25.00;
    const amt = clamp2(Number(document.getElementById('repAmt').value||0));
    const plan = document.getElementById('repPlan').value;

    row.status='Frais report';
    row.total=0; row.adjustment=0; row.interest=0; row.adhesion=0; row.method='PAD';
    row.nsfReportFee = fee;

    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date)||a.i-b.i))
      .filter(r=> !r.paid && r.status!=='NSF' && r.status!=='Frais report' && (r.method||'PAD')==='PAD');

    const n = plan==='ALL' ? ordered.length : Number(plan.replace('AUTO_',''));
    const targets = ordered.slice(0, n);

    const per = clamp2(amt / targets.length);
    targets.forEach(t=> t.adjustment = clamp2((t.adjustment||0) + per));

    logEvent('Report', `Source #${row.i} ‚Üí frais ${money(fee)}. Montant ${money(amt)} r√©parti sur ${targets.length} ligne(s): +${money(per)}.`);

    recalculateBalancesAndInterest();
    closeModal();
    renderAll();
  }

  function openArrearsResolver(id){
    const item = state.arrearsItems.find(a=>a.id===id && a.status==='OPEN');
    if(!item) return;

    const overlay = document.getElementById('overlay');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    const foot = document.getElementById('modalFoot');

    title.textContent='‚ö†Ô∏è Traiter la souffrance';

    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date)||a.i-b.i))
      .filter(r=> !r.paid && r.status!=='NSF' && r.status!=='Frais report' && (r.method||'PAD')==='PAD');

    body.innerHTML = `
      <div class="field">
        <label>Souffrance</label>
        <input disabled value="${money(item.total)} (ligne #${item.sourceLine})" />
      </div>
      <div class="field">
        <label>R√©partir sur</label>
        <select id="arrPlan">
          <option value="AUTO_1">1 paiement</option>
          <option value="AUTO_2">2 paiements</option>
          <option value="AUTO_3">3 paiements</option>
          <option value="AUTO_4">4 paiements</option>
          <option value="AUTO_5">5 paiements</option>
          <option value="ALL">TOUS les paiements √† venir</option>
        </select>
      </div>
      <div class="sum">√áa ajoute un ajustement sur les prochains paiements, puis ferme l‚Äôitem OPEN.</div>
    `;

    foot.innerHTML = `
      <button class="btn" onclick="closeModal()">Annuler</button>
      <button class="btn primary" onclick="applyArrearsResolve('${id}')">Confirmer</button>
    `;
    overlay.style.display='flex';
  }

  function applyArrearsResolve(id){
    const item = state.arrearsItems.find(a=>a.id===id && a.status==='OPEN');
    if(!item) return;

    const plan = document.getElementById('arrPlan').value;

    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date)||a.i-b.i))
      .filter(r=> !r.paid && r.status!=='NSF' && r.status!=='Frais report' && (r.method||'PAD')==='PAD');

    const n = plan==='ALL' ? ordered.length : Number(plan.replace('AUTO_',''));
    const targets = ordered.slice(0, n);

    const per = clamp2(item.total / targets.length);
    targets.forEach(t=> t.adjustment = clamp2((t.adjustment||0) + per));

    item.status='RESOLVED';
    logEvent('Souffrance trait√©e', `${money(item.total)} r√©parti sur ${targets.length} paiement(s): +${money(per)}.`);

    recalculateBalancesAndInterest();
    closeModal();
    renderAll();
  }

  function resetDemo(){
    state.schedule = originalSchedule.map(r=>({ ...r, status:'√Ä venir', adjustment:0, paid:false, method:'PAD' }));
    state.selected = 1;
    state.arrearsItems = [];
    state.events = [{
      ts:new Date().toISOString(),
      title:'Dossier charg√© (V2)',
      txt:'V2 = page all√©g√©e. M√™me logique que ton index: Reporter + NSF‚ÜíSouffrance + traitement.'
    }];
    renderAll();
  }

  // init
  resetDemo();

  // expose
  window.openAction=openAction;
  window.applyNSF=applyNSF;
  window.applyReportV4=applyReportV4;
  window.openArrearsResolver=openArrearsResolver;
  window.applyArrearsResolve=applyArrearsResolve;
  window.closeModal=closeModal;
  window.selectRow=selectRow;
  window.resetDemo=resetDemo;
</script>
</body>
</html>
