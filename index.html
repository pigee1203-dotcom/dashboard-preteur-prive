<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard pr√™teur priv√© ‚Äî Margill-like (Sans backend)</title>
  <style>
    :root{
      --bg:#0b1220;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r:16px;
      --r2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(45,212,191,.18), transparent 55%),
        radial-gradient(900px 650px at 60% 120%, rgba(251,113,133,.14), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1250px;margin:0 auto;padding:20px}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;margin:8px 0 16px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(96,165,250,.9), rgba(45,212,191,.75));
      box-shadow:0 12px 30px rgba(96,165,250,.20);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:18px;margin:0;line-height:1.2}
    .brand p{margin:0;color:var(--muted2);font-size:12px}

    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}

    .grid{display:grid;grid-template-columns: 1.25fr 0.75fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .cards{display:grid;grid-template-columns: repeat(6, 1fr);gap:12px;margin-bottom:14px;}
    @media (max-width: 1200px){ .cards{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 700px){ .cards{grid-template-columns: repeat(2, 1fr)} }

    .card{
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      padding:12px 12px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .card .label{color:var(--muted2);font-size:12px;display:flex;justify-content:space-between;gap:10px}
    .card .value{font-size:18px;margin-top:8px;font-weight:700;letter-spacing:.2px}
    .card .sub{margin-top:8px;color:var(--muted);font-size:12px}

    .panel{
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .panelHeader h2{margin:0;font-size:14px}
    .panelHeader small{color:var(--muted2)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      color:var(--text);
      padding:9px 10px;
      border-radius:14px;
      font-size:12px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, opacity .12s ease;
      display:flex;align-items:center;gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color:rgba(96,165,250,.45); background:rgba(96,165,250,.16)}
    .btn.danger{border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.14)}
    .btn.good{border-color:rgba(45,212,191,.45); background:rgba(45,212,191,.12)}
    .btn.warn{border-color:rgba(251,191,36,.45); background:rgba(251,191,36,.12)}
    .btn.ghost{background:transparent}

    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px;}
    th, td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;white-space:nowrap;}
    th{
      position:sticky;top:0;z-index:2;
      background:rgba(10,18,32,.85);
      backdrop-filter: blur(12px);
      color:var(--muted);
      font-weight:600;
    }
    tr:hover td{background:rgba(255,255,255,.04)}
    .status{
      padding:5px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;
      display:inline-flex;align-items:center;gap:8px;
      color:var(--muted);
    }
    .rightCol{display:flex;flex-direction:column;gap:14px;}
    .section{padding:14px;}
    .kv{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:10px;}
    .kv .item{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .kv .k{color:var(--muted2);font-size:11px}
    .kv .v{margin-top:6px;font-weight:700}
    .mono{font-family:var(--mono)}

    .hint{color:var(--muted2); font-size:12px; padding:10px 14px 0;}

    .arrearsBox,.ledgerBox{
      margin-top:12px;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      max-height:240px;
      overflow:auto;
    }
    .arrearsRow,.ledgerRow{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;padding:10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      margin-bottom:8px;
    }
    .arrearsRow:hover,.ledgerRow:hover{background:rgba(255,255,255,.05)}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;color:var(--muted);
    }
    .notes{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .note{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .note .meta{color:var(--muted2);font-size:11px;display:flex;justify-content:space-between}
    .note .txt{margin-top:6px;color:var(--text);font-size:12.5px}

    .footerBar{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      color:var(--muted2);
      font-size:12px;
    }

    /* Modal */
    .modalOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(900px, 100%);
      background:rgba(16,31,59,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius:22px;
      box-shadow:0 30px 100px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .modalHead h3{margin:0;font-size:14px}
    .modalBody{padding:14px}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width: 640px){ .row{grid-template-columns:1fr} }
    .field{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .field label{display:block;color:var(--muted2);font-size:11px;margin-bottom:8px}
    .field input, .field select{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    .summary{
      margin-top:12px;
      padding:12px;border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12.5px;
      line-height:1.45;
    }
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Dashboard pr√™teur priv√©</h1>
          <p>Margill-like ¬∑ Sans backend ¬∑ Encaissement r√©el ¬∑ Allocation ¬∑ Ledger</p>
        </div>
      </div>
      <div class="pill"><span class="dot good"></span> Mode: GitHub Pages OK</div>
    </div>

    <div class="cards" id="kpi"></div>

    <div class="grid">
      <div>
        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Calendrier des paiements</h2>
              <small>Solde bouge seulement sur PAY√â / PARTIEL (encaiss√© r√©el)</small>
            </div>
            <div class="actions">
              <button class="btn danger" onclick="openAction('nsf')">‚ùå NSF</button>
              <button class="btn good" onclick="openAction('post')">‚úÖ PAY√â</button>
              <button class="btn warn" onclick="openAction('partial')">üü® PARTIEL</button>
              <button class="btn" onclick="openAction('retry')">üîÅ Reprise NSF</button>
              <button class="btn ghost" onclick="resetDemo()">‚Ü©Ô∏è Reset</button>
            </div>
          </div>

          <div class="hint">
            R√®gle (Margill-like): <b>Souffrance ‚Üí Adh√©sion ‚Üí Int√©r√™t ‚Üí Capital</b>.<br/>
            <b>Total d√ª</b> = <b>Solde pr√™t</b> + <b>Souffrance OPEN</b>.
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Date pr√©vue</th>
                  <th>Date encaiss√©e</th>
                  <th>Statut banque</th>
                  <th>Planifi√©</th>
                  <th>Encaiss√©</th>
                  <th>Int√©r√™t</th>
                  <th>Capital</th>
                  <th>Adh√©sion</th>
                  <th>Ajust.</th>
                  <th>Solde avant</th>
                  <th>Solde apr√®s</th>
                  <th>Jours</th>
                  <th>Statut ligne</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div class="footerBar">
            <div class="mono" id="ruleLine"></div>
            <div class="mono" id="selectedInfo"></div>
          </div>
        </div>
      </div>

      <div class="rightCol">
        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>R√©sum√© contrat</h2>
              <small>Solde / Souffrance / Total d√ª</small>
            </div>
            <div class="pill"><span class="dot warn"></span> Audit</div>
          </div>
          <div class="section">
            <div class="kv" id="contractBox"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Souffrance & Ledger</h2>
              <small>OPEN = d√ª maintenant</small>
            </div>
            <div class="pill"><span class="dot bad"></span> Preuve</div>
          </div>
          <div class="section">
            <div class="kv">
              <div class="item"><div class="k">Souffrance OPEN</div><div class="v mono" id="rightArrears"></div></div>
              <div class="item"><div class="k">Total d√ª</div><div class="v mono" id="rightTotalDue"></div></div>
            </div>

            <div class="arrearsBox" id="arrearsList"></div>
            <div class="ledgerBox" id="ledgerList"></div>

            <div class="notes" id="events"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <h3 id="modalTitle">Action</h3>
        <button class="btn" onclick="closeModal()">‚úï Fermer</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

<script>
  // ========================= Utils =========================
  const clamp2 = (n) => Math.round(Number(n || 0) * 100) / 100;
  const nowIso = () => new Date().toISOString();
  const money = (n) => (Number(n||0)).toLocaleString('fr-CA',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' $';
  const fmtDate = (iso) => {
    if(!iso) return "‚Äî";
    return new Date(iso+'T00:00:00').toLocaleDateString('fr-CA',{day:'2-digit',month:'short',year:'numeric'}).replace('.','');
  };
  function toDateOnly(iso){
    const [y,m,d] = String(iso).split("-").map(Number);
    return new Date(Date.UTC(y,(m||1)-1,d||1));
  }
  function daysBetween(d1Iso, d2Iso){
    const a = toDateOnly(d1Iso);
    const b = toDateOnly(d2Iso);
    const ms = b.getTime() - a.getTime();
    return Math.max(0, Math.round(ms/(1000*60*60*24)));
  }
  function sortSchedule(s){ return [...s].sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.i||0)-(b.i||0)); }

  // ========================= Config (√† toi de changer) =========================
  const config = {
    contractStartDate: "2024-10-31",
    startBalance: 2250.00,
    annualRate: 0.1899,
    dayBase: 365,
    defaultNSFFee: 48.00,

    // Margill-like:
    payArrearsFirst: true,

    // Margill++:
    // sur PARTIEL: cr√©e automatiquement une souffrance du manquant (planifi√© - encaiss√©) ?
    autoArrearsOnPartialMissing: true,
  };

  // ========================= Seed schedule =========================
  const seedSchedule = [
    {i:1,  date:"2024-11-15", plannedBase:147.92, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:2,  date:"2024-11-29", plannedBase:147.19, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:3,  date:"2024-12-13", plannedBase:146.56, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:4,  date:"2024-12-27", plannedBase:145.94, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:5,  date:"2025-01-10", plannedBase:145.31, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:6,  date:"2025-01-24", plannedBase:144.72, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:7,  date:"2025-02-07", plannedBase:144.09, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:8,  date:"2025-02-21", plannedBase:143.47, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:9,  date:"2025-03-07", plannedBase:142.84, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:10, date:"2025-03-21", plannedBase:142.21, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:11, date:"2025-04-04", plannedBase:141.58, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:12, date:"2025-04-18", plannedBase:140.95, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:13, date:"2025-05-02", plannedBase:140.33, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:14, date:"2025-05-16", plannedBase:139.70, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:15, date:"2025-05-30", plannedBase:139.07, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:16, date:"2025-06-13", plannedBase:138.44, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:17, date:"2025-06-27", plannedBase:137.82, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:18, date:"2025-07-11", plannedBase:137.19, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:19, date:"2025-07-25", plannedBase:136.56, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:20, date:"2025-08-08", plannedBase:135.93, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:21, date:"2025-08-22", plannedBase:135.31, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:22, date:"2025-09-05", plannedBase:134.68, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:23, date:"2025-09-19", plannedBase:134.05, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:24, date:"2025-10-03", plannedBase:133.42, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:25, date:"2025-10-17", plannedBase:132.80, adhesion:45.00, adjustment:0, method:"PAD"},
    {i:26, date:"2025-10-26", plannedBase:132.17, adhesion:45.00, adjustment:0, method:"PAD"},
  ];

  // ========================= State =========================
  let state = {
    selected: 1,
    schedule: [],
    arrearsItems: [], // {id,type,sourceLine,amount,fee,total,status,createdAt}
    ledger: [],       // {ts,line,type,postedDate,amount,split}
    events: []        // {ts,title,txt}
  };

  function resetDemo(){
    state.schedule = seedSchedule.map(r => ({
      i: r.i,
      date: r.date,
      method: r.method || "PAD",
      adhesion: clamp2(r.adhesion || 0),
      adjustment: clamp2(r.adjustment || 0),
      plannedBase: clamp2(r.plannedBase || 0),

      // banque
      postedStatus: "NONE", // NONE|POSTED|PARTIAL|NSF
      postedAmount: 0,
      postedDate: null,

      // affichage calcul√©
      planned: 0,
      collected: 0,
      interest: 0,
      capital: 0,
      balanceBefore: 0,
      balance: 0,
      days: 0,
      allocation: {toArrears:0,toAdhesion:0,toInterest:0,toPrincipal:0},
      status: "√Ä venir",
      paid: false,
    }));

    state.selected = 1;
    state.arrearsItems = [];
    state.ledger = [];
    state.events = [{ts: nowIso(), title:"Dossier charg√©", txt:"Mode sans backend. Margill-like actif (encaissement r√©el + ledger)."}];

    recomputeAll();
    renderAll();
  }

  function openArrearsTotal(){
    return clamp2(state.arrearsItems
      .filter(a => a.status === "OPEN")
      .reduce((s,a)=> s + (a.total || 0), 0));
  }

  function closeArrearsFIFO(amount){
    let remaining = clamp2(amount);
    let closed = 0;

    const items = state.arrearsItems
      .filter(a => a.status === "OPEN")
      .sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));

    for(const a of items){
      if(remaining <= 0) break;
      const t = clamp2(a.total || 0);
      if(remaining >= t){
        remaining = clamp2(remaining - t);
        a.total = 0;
        a.status = "RESOLVED";
        closed++;
      }else{
        a.total = clamp2(t - remaining);
        remaining = 0;
      }
    }
    return {closed, leftover: remaining};
  }

  // Allocation: souffrance -> adhesion -> int√©r√™t -> capital
  function allocatePayment({amount, adhesionDue, interestDue, arrearsDue}){
    let remaining = clamp2(amount);
    const out = {toArrears:0,toAdhesion:0,toInterest:0,toPrincipal:0, surplus:0};

    if(config.payArrearsFirst && arrearsDue > 0){
      const x = clamp2(Math.min(remaining, arrearsDue));
      out.toArrears = x;
      remaining = clamp2(remaining - x);
    }

    if(adhesionDue > 0){
      const x = clamp2(Math.min(remaining, adhesionDue));
      out.toAdhesion = x;
      remaining = clamp2(remaining - x);
    }

    if(interestDue > 0){
      const x = clamp2(Math.min(remaining, interestDue));
      out.toInterest = x;
      remaining = clamp2(remaining - x);
    }

    if(remaining > 0){
      out.toPrincipal = remaining;
      remaining = 0;
    }

    out.surplus = clamp2(remaining);
    return out;
  }

  function recomputeAll(){
    const ordered = sortSchedule(state.schedule);

    let prevPostedDate = config.contractStartDate;
    let prevBalance = clamp2(config.startBalance);

    for(const row of ordered){
      row.planned = clamp2((row.plannedBase || 0) + (row.adjustment || 0));

      const postedStatus = row.postedStatus || "NONE";
      const collected = (postedStatus === "POSTED" || postedStatus === "PARTIAL") ? clamp2(row.postedAmount || 0) : 0;

      const effectiveDate = row.postedDate || row.date; // pour calcul de jours si encaiss√©
      const days = daysBetween(prevPostedDate, effectiveDate);
      row.days = days;

      const interestDue = clamp2(prevBalance * Number(config.annualRate) * (days / Number(config.dayBase)));

      const arrearsDueSnapshot = openArrearsTotal();
      const alloc = allocatePayment({
        amount: collected,
        adhesionDue: clamp2(row.adhesion || 0),
        interestDue,
        arrearsDue: arrearsDueSnapshot
      });

      const capital = clamp2(alloc.toPrincipal);
      const balanceAfter = clamp2(prevBalance - capital);

      row.collected = collected;
      row.interest = clamp2(alloc.toInterest);
      row.capital = capital;
      row.balanceBefore = clamp2(prevBalance);
      row.balance = balanceAfter;
      row.allocation = alloc;

      prevBalance = balanceAfter;

      if(postedStatus === "POSTED" || postedStatus === "PARTIAL"){
        prevPostedDate = effectiveDate;
      }
    }
  }

  function nextRow(){
    const ordered = sortSchedule(state.schedule);
    return ordered.find(r => !r.paid && (r.postedStatus||"NONE")==="NONE") || ordered[0];
  }

  // ========================= Actions =========================
  function addEvent(title, txt){
    state.events.push({ts: nowIso(), title, txt});
  }

  function actionNSF(lineId, fee){
    const row = state.schedule.find(r => r.i === Number(lineId));
    if(!row) return;

    const nsfFee = clamp2(fee ?? config.defaultNSFFee);
    const rejected = clamp2(row.planned);
    const total = clamp2(rejected + nsfFee);

    row.postedStatus = "NSF";
    row.postedAmount = 0;
    row.postedDate = null;
    row.status = "NSF";
    row.paid = false;

    const id = "A" + Date.now();
    state.arrearsItems.push({
      id,
      type: "NSF",
      sourceLine: row.i,
      amount: rejected,
      fee: nsfFee,
      total,
      status: "OPEN",
      createdAt: nowIso()
    });

    addEvent("NSF", `Paiement #${row.i} NSF. Souffrance OPEN: rejet ${money(rejected)} + frais ${money(nsfFee)} = ${money(total)}.`);

    recomputeAll();
    renderAll();
  }

  function actionRetry(lineId, newDate){
    const row = state.schedule.find(r => r.i === Number(lineId));
    if(!row) return;

    if(row.postedStatus !== "NSF" && row.status !== "NSF"){
      addEvent("Reprise refus√©e", `Ligne #${row.i} n'est pas NSF.`);
      recomputeAll(); renderAll();
      return;
    }

    row.date = newDate || row.date;
    row.postedStatus = "NONE";
    row.postedAmount = 0;
    row.postedDate = null;
    row.status = "√Ä venir";
    row.paid = false;

    addEvent("Reprise bancaire", `Paiement #${row.i} replanifi√© au ${row.date}.`);
    recomputeAll();
    renderAll();
  }

  function actionPost(lineId, amount, postedDate){
    const row = state.schedule.find(r => r.i === Number(lineId));
    if(!row) return;

    const amt = clamp2(amount);
    if(amt <= 0) return;

    // posted
    row.postedAmount = amt;
    row.postedDate = postedDate || row.date;
    row.postedStatus = (amt < row.planned) ? "PARTIAL" : "POSTED";
    row.status = (row.postedStatus === "PARTIAL") ? "Partiel" : "Pay√©";
    row.paid = true;

    // recalcul allocation (avec snapshot souffrance)
    recomputeAll();

    const alloc = row.allocation || {toArrears:0,toAdhesion:0,toInterest:0,toPrincipal:0};

    // fermer souffrance FIFO si payArrearsFirst
    let closeInfo = {closed:0, leftover:0};
    if(config.payArrearsFirst && alloc.toArrears > 0){
      closeInfo = closeArrearsFIFO(alloc.toArrears);
    }

    // Margill++: si partiel, cr√©er souffrance "manquant"
    if(config.autoArrearsOnPartialMissing && row.postedStatus === "PARTIAL"){
      const missing = clamp2(row.planned - amt);
      if(missing > 0){
        const id = "A" + Date.now();
        state.arrearsItems.push({
          id,
          type: "MANQUANT",
          sourceLine: row.i,
          amount: missing,
          fee: 0,
          total: missing,
          status: "OPEN",
          createdAt: nowIso()
        });
        addEvent("Partiel ‚Üí souffrance", `Paiement #${row.i} partiel. Manquant ${money(missing)} cr√©√© en souffrance OPEN.`);
      }
    }

    state.ledger.push({
      ts: nowIso(),
      line: row.i,
      type: "POST",
      postedDate: row.postedDate,
      amount: amt,
      split: {
        arrears: alloc.toArrears,
        adhesion: alloc.toAdhesion,
        interest: alloc.toInterest,
        principal: alloc.toPrincipal
      }
    });

    addEvent("Encaissement", `#${row.i} encaiss√© ${money(amt)} (${row.postedStatus}). Split: souffrance ${money(alloc.toArrears)}, adh√©sion ${money(alloc.toAdhesion)}, int√©r√™t ${money(alloc.toInterest)}, capital ${money(alloc.toPrincipal)}. Souffrances ferm√©es: ${closeInfo.closed}.`);

    recomputeAll();
    renderAll();
  }

  // ========================= Render =========================
  function renderKPI(){
    const ordered = sortSchedule(state.schedule);
    const next = nextRow();

    const arrears = openArrearsTotal();
    const balance = Number(next?.balance ?? 0);
    const totalDue = clamp2(balance + arrears);

    const interestCum = clamp2(ordered.reduce((s,r)=> s + (r.interest||0), 0));
    const capitalCum  = clamp2(ordered.reduce((s,r)=> s + (r.capital||0), 0));
    const collectedCum = clamp2(ordered.reduce((s,r)=> s + (r.collected||0), 0));

    const kpis = [
      {label:'Solde pr√™t', dot:'good', value: money(balance), sub:'Bouge sur PAY√â/PARTIEL'},
      {label:'Souffrance', dot: arrears>0?'bad':'good', value: money(arrears), sub:'OPEN (NSF, manquant, etc.)'},
      {label:'Total d√ª', dot: arrears>0?'bad':'good', value: money(totalDue), sub:'Solde pr√™t + souffrance'},
      {label:'Financ√©', dot:'warn', value: money(config.startBalance), sub:`Origine: ${config.contractStartDate}`},
      {label:'Int√©r√™t cumul√©', dot:'warn', value: money(interestCum), sub:`Capital cumul√©: ${money(capitalCum)}`},
      {label:'Encaiss√© cumul√©', dot:'good', value: money(collectedCum), sub:`Margill++ manquant: ${config.autoArrearsOnPartialMissing?'Oui':'Non'}`},
    ];

    document.getElementById('kpi').innerHTML = kpis.map(k=>`
      <div class="card">
        <div class="label"><span>${k.label}</span><span class="dot ${k.dot}"></span></div>
        <div class="value">${k.value}</div>
        <div class="sub">${k.sub}</div>
      </div>
    `).join('');

    document.getElementById('rightArrears').textContent = money(arrears);
    document.getElementById('rightTotalDue').textContent = money(totalDue);

    document.getElementById('ruleLine').textContent =
      `ACT/${config.dayBase} ¬∑ taux ${(config.annualRate*100).toFixed(2)}% ¬∑ souffrance prioritaire ${config.payArrearsFirst?'ON':'OFF'}`;
  }

  function renderContractBox(){
    const next = nextRow();
    const arrears = openArrearsTotal();
    const totalDue = clamp2(Number(next?.balance||0) + arrears);

    document.getElementById('contractBox').innerHTML = `
      <div class="item"><div class="k">Date d‚Äôorigine</div><div class="v mono">${config.contractStartDate}</div></div>
      <div class="item"><div class="k">Montant financ√©</div><div class="v mono">${money(config.startBalance)}</div></div>
      <div class="item"><div class="k">Taux</div><div class="v mono">${(config.annualRate*100).toFixed(2)}% ¬∑ ACT/${config.dayBase}</div></div>
      <div class="item"><div class="k">Souffrance prioritaire</div><div class="v">${config.payArrearsFirst?'Oui':'Non'}</div></div>
      <div class="item"><div class="k">Margill++ manquant</div><div class="v">${config.autoArrearsOnPartialMissing?'Oui':'Non'}</div></div>
      <div class="item"><div class="k">Total d√ª</div><div class="v mono">${money(totalDue)}</div></div>
    `;
  }

  function renderTable(){
    const ordered = sortSchedule(state.schedule);
    const tbody = document.getElementById('rows');

    tbody.innerHTML = ordered.map(r=>{
      const sel = r.i===state.selected;

      const bank = (r.postedStatus || "NONE");
      const bankDot = bank==="NSF" ? "bad" : bank==="POSTED" ? "good" : bank==="PARTIAL" ? "warn" : "warn";

      const line = r.status || "√Ä venir";
      const lineDot = line==="NSF" ? "bad" : line==="Pay√©" ? "good" : line==="Partiel" ? "warn" : "warn";

      return `
        <tr onclick="selectRow(${r.i})" style="${sel?'background:rgba(96,165,250,.08)':''}">
          <td class="mono">${r.i}</td>
          <td>${fmtDate(r.date)}</td>
          <td>${fmtDate(r.postedDate)}</td>
          <td><span class="status"><span class="dot ${bankDot}"></span>${bank}</span></td>
          <td class="mono">${money(r.planned||0)}</td>
          <td class="mono">${money(r.collected||0)}</td>
          <td class="mono">${money(r.interest||0)}</td>
          <td class="mono">${money(r.capital||0)}</td>
          <td class="mono">${money(r.adhesion||0)}</td>
          <td class="mono">${money(r.adjustment||0)}</td>
          <td class="mono">${money(r.balanceBefore||0)}</td>
          <td class="mono">${money(r.balance||0)}</td>
          <td class="mono">${r.days ?? 0}</td>
          <td><span class="status"><span class="dot ${lineDot}"></span>${line}</span></td>
        </tr>
      `;
    }).join('');

    const row = state.schedule.find(r=>r.i===state.selected) || ordered[0];
    if(row){
      document.getElementById('selectedInfo').textContent =
        `S√©lection #${row.i} ¬∑ Planifi√© ${money(row.planned)} ¬∑ Banque ${row.postedStatus} ¬∑ Encaiss√© ${money(row.collected)} ¬∑ Solde ${money(row.balance)}`;
    }
  }

  function renderArrearsList(){
    const box = document.getElementById('arrearsList');
    const open = state.arrearsItems
      .filter(a => a.status === "OPEN")
      .sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));

    if(!open.length){
      box.innerHTML = `<div style="color:var(--muted2); font-size:12px; padding:6px 4px;">Aucune souffrance OPEN.</div>`;
      return;
    }

    box.innerHTML = open.map(a=>`
      <div class="arrearsRow">
        <div style="min-width:0">
          <div style="font-size:12.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
            <span class="tag"><span class="dot bad"></span> ${a.type}</span>
            &nbsp; Source #${a.sourceLine} ¬∑ <span class="mono">${money(a.total)}</span>
          </div>
          <div style="font-size:11px;color:var(--muted2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
            D√©tail: montant ${money(a.amount)} ${a.fee?`+ frais ${money(a.fee)}`:''} ¬∑ Cr√©√© ${new Date(a.createdAt).toLocaleString('fr-CA',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderLedger(){
    const box = document.getElementById('ledgerList');
    const rows = [...state.ledger].slice(-10).reverse();

    if(!rows.length){
      box.innerHTML = `<div style="color:var(--muted2); font-size:12px; padding:6px 4px;">Ledger vide (aucun encaissement post√©).</div>`;
      return;
    }

    box.innerHTML = rows.map(l=>{
      const s = l.split || {};
      return `
        <div class="ledgerRow">
          <div style="min-width:0">
            <div style="font-size:12.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
              <span class="tag"><span class="dot good"></span> POST</span>
              &nbsp; Ligne #${l.line} ¬∑ ${money(l.amount)} ¬∑ <span class="mono">${l.postedDate}</span>
            </div>
            <div style="font-size:11px;color:var(--muted2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
              Split: souffrance ${money(s.arrears||0)} ¬∑ adh√©sion ${money(s.adhesion||0)} ¬∑ int√©r√™t ${money(s.interest||0)} ¬∑ capital ${money(s.principal||0)}
            </div>
          </div>
          <div class="mono" style="align-self:center;color:var(--muted2)">
            ${new Date(l.ts).toLocaleString('fr-CA',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}
          </div>
        </div>
      `;
    }).join('');
  }

  function renderEvents(){
    const items = [...state.events].slice(-8).reverse();
    document.getElementById('events').innerHTML = items.map(e=>`
      <div class="note">
        <div class="meta">
          <span>${e.title}</span>
          <span class="mono">${new Date(e.ts).toLocaleString('fr-CA',{hour:'2-digit',minute:'2-digit',year:'numeric',month:'2-digit',day:'2-digit'})}</span>
        </div>
        <div class="txt">${e.txt}</div>
      </div>
    `).join('');
  }

  function renderAll(){
    renderKPI();
    renderContractBox();
    renderTable();
    renderArrearsList();
    renderLedger();
    renderEvents();
  }

  function selectRow(i){ state.selected = i; renderAll(); }

  // ========================= Modal =========================
  function closeModal(ev){
    if(ev && ev.target && ev.target.id !== 'overlay') return;
    document.getElementById('overlay').style.display = 'none';
  }

  function openAction(kind){
    const row = state.schedule.find(r=>r.i===state.selected) || state.schedule[0];
    const overlay = document.getElementById('overlay');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    const foot = document.getElementById('modalFoot');

    if(kind === "nsf"){
      title.textContent = "‚ùå NSF ‚Üí Souffrance OPEN";
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne</label>
            <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Planifi√© ${money(row.planned)}" />
          </div>
          <div class="field">
            <label>Frais NSF</label>
            <input id="nsfFee" type="number" step="0.01" value="${Number(config.defaultNSFFee).toFixed(2)}" />
          </div>
        </div>
        <div class="summary">
          NSF = encaiss√© 0, solde pr√™t ne baisse pas. Souffrance OPEN = rejet + frais NSF.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn danger" onclick="doNSF()">Confirmer NSF</button>
      `;
      overlay.style.display = "flex";
      return;
    }

    if(kind === "post" || kind === "partial"){
      const isPartial = (kind === "partial");
      title.textContent = isPartial ? "üü® PARTIEL (encaiss√© r√©el)" : "‚úÖ PAY√â (encaiss√© r√©el)";
      const suggested = isPartial ? Math.max(0, row.planned - 40) : row.planned;

      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne</label>
            <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Planifi√© ${money(row.planned)} ¬∑ Banque ${row.postedStatus}" />
          </div>
          <div class="field">
            <label>Montant encaiss√©</label>
            <input id="postAmt" type="number" step="0.01" value="${Number(suggested).toFixed(2)}" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Date encaiss√©e (r√©elle)</label>
            <input id="postDate" type="date" value="${(row.date||"").slice(0,10)}" />
          </div>
          <div class="field">
            <label>Margill++: souffrance du manquant (planifi√© - encaiss√©)</label>
            <select id="autoMissing">
              <option value="true" ${config.autoArrearsOnPartialMissing ? "selected":""}>Oui</option>
              <option value="false" ${!config.autoArrearsOnPartialMissing ? "selected":""}>Non</option>
            </select>
          </div>
        </div>

        <div class="summary">
          Allocation: souffrance ‚Üí adh√©sion ‚Üí int√©r√™t ‚Üí capital. Ledger = preuve du split.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn ${isPartial?'warn':'good'}" onclick="doPost()">Confirmer</button>
      `;
      overlay.style.display = "flex";
      return;
    }

    if(kind === "retry"){
      title.textContent = "üîÅ Reprise NSF (replanifier)";
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne</label>
            <input disabled value="#${row.i} ¬∑ Banque ${row.postedStatus} ¬∑ Statut ${row.status}" />
          </div>
          <div class="field">
            <label>Nouvelle date pr√©vue</label>
            <input id="retryDate" type="date" value="${(row.date||"").slice(0,10)}" />
          </div>
        </div>
        <div class="summary">
          Reprise = remet banque √† NONE et la ligne √† ‚Äú√Ä venir‚Äù.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="doRetry()">Confirmer reprise</button>
      `;
      overlay.style.display = "flex";
      return;
    }
  }

  function doNSF(){
    const fee = clamp2(Number(document.getElementById("nsfFee").value || config.defaultNSFFee));
    closeModal();
    actionNSF(state.selected, fee);
  }

  function doPost(){
    const amt = clamp2(Number(document.getElementById("postAmt").value || 0));
    const d = document.getElementById("postDate").value;
    const autoMissing = (document.getElementById("autoMissing").value === "true");
    config.autoArrearsOnPartialMissing = autoMissing;

    closeModal();
    actionPost(state.selected, amt, d);
  }

  function doRetry(){
    const d = document.getElementById("retryDate").value;
    closeModal();
    actionRetry(state.selected, d);
  }

  // expose
  window.openAction = openAction;
  window.closeModal = closeModal;
  window.resetDemo = resetDemo;
  window.selectRow = selectRow;

  // init
  resetDemo();
</script>
</body>
</html>
