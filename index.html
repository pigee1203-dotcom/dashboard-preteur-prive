<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard pr√™teur priv√©</title>
  <style>
    :root{
      --bg:#0f0f12;
      --bg2:#18181c;
      --glass:rgba(255,255,255,.03);
      --glass2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --text:#f5f5f7;
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#f87171;
      --accent:#60a5fa;
      --purple:#a78bfa;
      --shadow:0 4px 24px rgba(0,0,0,.4);
      --shadow2:0 8px 40px rgba(0,0,0,.5);
      --r:20px;
      --r2:24px;
      --r3:32px;
      --mono:'SF Mono', ui-monospace, Consolas, monospace;
      --sans:-apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:var(--sans);
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
      line-height:1.4;
      -webkit-font-smoothing:antialiased;
    }
    .app{max-width:1400px;margin:0 auto;padding:16px;display:grid;gap:16px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 20px;
      background:linear-gradient(180deg, rgba(255,255,255,.08) 0%, rgba(255,255,255,.04) 100%);
      border:1px solid var(--stroke2);
      border-radius:var(--r2);
      backdrop-filter:blur(20px);
      box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,.1);
    }
    .brand{display:flex;align-items:center;gap:14px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, var(--accent), var(--good));
      display:flex;align-items:center;justify-content:center;
      font-size:22px;
      box-shadow:0 4px 16px rgba(96,165,250,.3), inset 0 1px 0 rgba(255,255,255,.3);
    }
    .brand-text h1{font-size:17px;font-weight:600;letter-spacing:-.02em}
    .brand-text p{font-size:12px;color:var(--muted2);margin-top:2px}
    .status-pill{
      display:flex;align-items:center;gap:8px;
      padding:8px 14px;background:var(--glass2);
      border:1px solid var(--stroke2);
      border-radius:999px;font-size:12px;font-weight:500;
    }
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--good);box-shadow:0 0 8px var(--good)}
    .status-pill.demo .status-dot{background:var(--warn);box-shadow:0 0 8px var(--warn)}

    .kpi-row{display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;}
    @media(max-width:900px){.kpi-row{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:500px){.kpi-row{grid-template-columns:1fr}}
    .kpi-card{
      position:relative;padding:16px 18px;
      background:linear-gradient(180deg, rgba(255,255,255,.07) 0%, rgba(255,255,255,.03) 100%);
      border:1px solid var(--stroke2);
      border-radius:var(--r2);
      backdrop-filter:blur(12px);
      box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,.08);
      overflow:hidden;
    }
    .kpi-card .kpi-label{
      display:flex;align-items:center;justify-content:space-between;
      font-size:12px;color:var(--muted2);font-weight:500;
      text-transform:uppercase;letter-spacing:.04em;
    }
    .kpi-card .kpi-dot{width:8px;height:8px;border-radius:50%}
    .kpi-card .kpi-dot.good{background:var(--good);box-shadow:0 0 10px var(--good)}
    .kpi-card .kpi-dot.warn{background:var(--warn);box-shadow:0 0 10px var(--warn)}
    .kpi-card .kpi-dot.bad{background:var(--bad);box-shadow:0 0 10px var(--bad)}
    .kpi-card .kpi-value{
      margin-top:10px;font-size:26px;font-weight:700;
      font-family:var(--mono);letter-spacing:-.02em;
    }
    .kpi-card .kpi-sub{margin-top:6px;font-size:11px;color:var(--muted2)}

    .main-grid{display:grid;grid-template-columns:1fr 380px;gap:16px;}
    @media(max-width:1100px){.main-grid{grid-template-columns:1fr}}

    .panel{
      background:linear-gradient(180deg, var(--glass2) 0%, var(--glass) 100%);
      border:1px solid var(--stroke);
      border-radius:var(--r2);
      backdrop-filter:blur(16px);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .panel-head{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:16px 20px;
      background:linear-gradient(180deg, rgba(255,255,255,.05) 0%, transparent 100%);
      border-bottom:1px solid var(--stroke);
    }
    .panel-head h2{font-size:15px;font-weight:600}
    .panel-head small{color:var(--muted2);font-size:11px;margin-top:2px}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;gap:6px;
      padding:10px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,.1) 0%, rgba(255,255,255,.05) 100%);
      border:1px solid var(--stroke2);
      border-radius:14px;color:var(--text);
      font-size:12px;font-weight:500;cursor:pointer;
      transition:all .15s ease;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.1);
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.18)}
    .btn:active{transform:scale(.98)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(96,165,250,.4) 0%, rgba(96,165,250,.25) 100%);
      border-color:rgba(96,165,250,.5);
      box-shadow:0 2px 12px rgba(96,165,250,.2), inset 0 1px 0 rgba(255,255,255,.15);
    }
    .btn.good{
      background:linear-gradient(180deg, rgba(52,211,153,.35) 0%, rgba(52,211,153,.2) 100%);
      border-color:rgba(52,211,153,.5);
    }
    .btn.warn{
      background:linear-gradient(180deg, rgba(251,191,36,.35) 0%, rgba(251,191,36,.2) 100%);
      border-color:rgba(251,191,36,.5);
    }

    .hint{padding:12px 20px;font-size:11px;color:var(--muted2);border-bottom:1px solid var(--stroke)}
    .table-wrap{overflow-y:auto;overflow-x:hidden;padding:0;max-height:420px}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:11px;table-layout:fixed}
    th,td{padding:6px 4px;text-align:left;overflow:hidden;text-overflow:ellipsis}
    th{
      position:sticky;top:0;z-index:5;
      background:rgba(15,15,18,.95);
      backdrop-filter:blur(8px);
      color:var(--muted2);
      font-weight:600;font-size:11px;
      text-transform:uppercase;letter-spacing:.04em;
      border-bottom:1px solid var(--stroke);
    }
    td{border-bottom:1px solid rgba(255,255,255,.04)}
    tr:hover td{background:rgba(255,255,255,.03)}
    .mono{font-family:var(--mono)}
    .table-footer{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 20px;background:var(--glass);
      border-top:1px solid var(--stroke);
      font-size:11px;color:var(--muted2);
    }

    .right-col{display:flex;flex-direction:column;gap:16px}
    .client-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:16px;}
    .client-item{
      padding:12px;background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:14px;
    }
    .client-item .k{font-size:10px;color:var(--muted2);text-transform:uppercase;letter-spacing:.04em}
    .client-item .v{margin-top:6px;font-size:13px;font-weight:600}
    .flip-container{perspective:1000px;cursor:pointer;}
    .flip-card{position:relative;width:100%;transition:transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);transform-style:preserve-3d;}
    .flip-container.flipped .flip-card{transform:rotateY(180deg);}
    .flip-front, .flip-back{backface-visibility:hidden;-webkit-backface-visibility:hidden;}
    .flip-back{
      position:absolute;top:0;left:0;right:0;
      transform:rotateY(180deg);
      background:linear-gradient(180deg, var(--glass2) 0%, var(--glass) 100%);
      border-radius:var(--r2);
      min-height:100%;
    }
    .flip-hint{
      position:absolute;bottom:8px;right:12px;
      font-size:10px;color:var(--muted2);
      opacity:0.7;
    }

    .notes{display:flex;flex-direction:column;gap:8px;margin-top:12px;max-height:250px;overflow-y:auto}
    .note{
      padding:12px;background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:12px;
      border-left:3px solid var(--muted);
    }
    .note .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .note .title{font-size:12px;font-weight:500}
    .note .time{font-size:10px;color:var(--muted2);font-family:var(--mono)}
    .note .txt{margin-top:6px;font-size:11px;color:var(--muted);line-height:1.5}
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">üíº</div>
      <div class="brand-text">
        <h1>Dashboard Pr√™teur</h1>
        <p>Gestion simplifi√©e</p>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <div class="status-pill"><span class="status-dot"></span> Connect√©</div>
      <div class="status-pill demo"><span class="status-dot"></span> Mode D√©mo</div>
    </div>
  </div>

  <div class="kpi-row" id="kpi"></div>

  <div class="main-grid">
    <!-- LEFT -->
    <div class="panel">
      <div class="panel-head">
        <div>
          <h2>Calendrier des paiements</h2>
          <small id="subHeader">‚Äî</small>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="recalculateFromUI()">üßÆ Recalculer</button>
          <button class="btn good" onclick="saveLoanSettings()">üíæ Sauvegarder</button>
          <button class="btn" onclick="loadLoanSettings(true)">‚Ü©Ô∏è Charger</button>
        </div>
      </div>

      <div class="hint">Le tableau se reg√©n√®re √† partir des valeurs de ‚ÄúPr√™t & Banque‚Äù.</div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:30px">#</th>
              <th style="width:95px">Date</th>
              <th style="width:80px">Total</th>
              <th style="width:80px">Int√©r√™t</th>
              <th style="width:80px">Capital</th>
              <th style="width:80px">Adh.</th>
              <th style="width:90px">Solde avant</th>
              <th style="width:90px">Solde apr√®s</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="table-footer">
        <div id="footerInfo">‚Äî</div>
        <div class="mono" id="selectedInfo">Plan</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right-col">
      <div class="panel flip-container" onclick="this.classList.toggle('flipped')">
        <div class="flip-card">
          <!-- FRONT -->
          <div class="flip-front">
            <div class="panel-head">
              <div>
                <h2>Fiche client</h2>
                <small>#10023</small>
              </div>
              <div class="status-pill"><span class="status-dot"></span> Actif</div>
            </div>
            <div class="client-grid">
              <div class="client-item"><div class="k">Pr√©nom</div><div class="v">Marc</div></div>
              <div class="client-item"><div class="k">Nom</div><div class="v">Savoie</div></div>
              <div class="client-item"><div class="k">Ville</div><div class="v">Montr√©al</div></div>
              <div class="client-item"><div class="k">Courriel</div><div class="v">marc.savoie@email.com</div></div>
            </div>
            <div class="flip-hint">üîÑ Infos pr√™t & banque</div>
          </div>

          <!-- BACK -->
          <div class="flip-back">
            <div class="panel-head">
              <div>
                <h2>Pr√™t & Banque</h2>
                <small>Marc Savoie #10023</small>
              </div>
              <div class="status-pill"><span class="status-dot"></span> PAD Actif</div>
            </div>

            <div class="client-grid">
              <div class="client-item">
                <div class="k">Montant pr√™t</div>
                <div class="v mono">
                  <input type="number" id="loanAmount" value="2000" step="0.01"
                    style="width:110px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:13px;font-family:var(--mono);text-align:right"
                    oninput="updateTotalFinanced()" onclick="event.stopPropagation()"/> $
                </div>
              </div>

              <div class="client-item">
                <div class="k">Frais ouverture</div>
                <div class="v mono">
                  <input type="number" id="openingFees" value="250" step="0.01"
                    style="width:110px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:13px;font-family:var(--mono);text-align:right"
                    oninput="updateTotalFinanced()" onclick="event.stopPropagation()"/> $
                </div>
              </div>

              <div class="client-item">
                <div class="k">Montant financ√©</div>
                <div class="v mono" id="totalFinanced">2 250,00 $</div>
              </div>

              <div class="client-item">
                <div class="k">Date origine</div>
                <div class="v mono">
                  <input type="date" id="originDate" value="2024-11-07"
                    style="width:140px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:12px"
                    onclick="event.stopPropagation()"/>
                </div>
              </div>

              <div class="client-item">
                <div class="k">1er paiement</div>
                <div class="v mono">
                  <input type="date" id="firstPaymentDate" value="2024-11-15"
                    style="width:140px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:12px"
                    onclick="event.stopPropagation()"/>
                </div>
              </div>

              <div class="client-item">
                <div class="k">Nb paiements</div>
                <div class="v mono">
                  <input type="number" id="numPayments" value="26" min="1" max="104"
                    style="width:80px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:13px;font-family:var(--mono);text-align:right"
                    onclick="event.stopPropagation()"/>
                </div>
              </div>

              <div class="client-item">
                <div class="k">Taux int√©r√™t</div>
                <div class="v mono">
                  <input type="number" id="interestRate" value="18.99" step="0.01" min="0" max="100"
                    style="width:90px;background:rgba(255,255,255,.08);border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:4px 8px;font-size:13px;font-family:var(--mono);text-align:right"
                    onclick="event.stopPropagation()"/> %
                </div>
              </div>

              <div class="client-item">
                <div class="k">Type taux</div>
                <div class="v">
                  <select id="rateType"
                    style="width:100%;background:#1a1a2e;border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:6px 8px;font-size:12px"
                    onclick="event.stopPropagation()">
                    <option value="annual" selected>Annuel</option>
                    <option value="monthly">Mensuel</option>
                    <option value="periodic">Par p√©riode</option>
                  </select>
                </div>
              </div>

              <div class="client-item">
                <div class="k">Fr√©quence</div>
                <div class="v">
                  <select id="paymentFrequency"
                    style="width:100%;background:#1a1a2e;border:1px solid var(--stroke2);border-radius:6px;color:var(--text);padding:6px 8px;font-size:12px"
                    onclick="event.stopPropagation()">
                    <option value="7">7 jours</option>
                    <option value="14" selected>14 jours</option>
                  </select>
                </div>
              </div>

              <!-- ‚úÖ BOUTONS: SAUVEGARDER / RECALCULER -->
              <div class="client-item" style="grid-column:span 2;display:grid;gap:10px">
                <button class="btn primary" onclick="recalculateFromUI();event.stopPropagation()" style="width:100%;justify-content:center">
                  üßÆ Recalculer le plan avec ces valeurs
                </button>
                <button class="btn good" onclick="saveLoanSettings();event.stopPropagation()" style="width:100%;justify-content:center">
                  üíæ Sauvegarder Pr√™t & Banque
                </button>
                <button class="btn warn" onclick="saveAndRecalculate();event.stopPropagation()" style="width:100%;justify-content:center">
                  üíæüßÆ Sauvegarder + Recalculer
                </button>
                <button class="btn" onclick="loadLoanSettings(true);event.stopPropagation()" style="width:100%;justify-content:center">
                  ‚Ü©Ô∏è Charger sauvegarde (et recalculer)
                </button>
              </div>

              <div class="client-item"><div class="k">Institution</div><div class="v">Desjardins</div></div>
              <div class="client-item"><div class="k">Transit</div><div class="v mono">81520</div></div>
              <div class="client-item"><div class="k">Folio</div><div class="v mono">0648291</div></div>
              <div class="client-item"><div class="k">Compte</div><div class="v mono">7234851</div></div>
            </div>

            <div class="flip-hint">üîÑ Retour fiche client</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div><h2>Notes</h2><small>Historique</small></div>
        </div>
        <div style="padding:16px">
          <div class="notes" id="events"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===================== UTILITAIRES
  const STORAGE_KEY = 'loan_settings_v1';

  const money = (n) => (Number(n||0)).toLocaleString('fr-CA',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' $';
  const clamp2 = (n) => Math.round((Number(n)||0)*100)/100;
  const fmtDate = (iso) => new Date(iso+'T00:00:00').toLocaleDateString('fr-CA',{day:'2-digit',month:'short',year:'numeric'}).replace('.','');

  function daysBetween(date1, date2){
    const d1 = new Date(date1 + 'T00:00:00');
    const d2 = new Date(date2 + 'T00:00:00');
    return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
  }

  // ===================== STATE
  let state = {
    schedule: [],
    events: []
  };

  function logEvent(title, txt){
    state.events.push({
      ts: new Date().toISOString(),
      title, txt
    });
    renderEvents();
  }

  // ===================== UI HELPERS
  function updateTotalFinanced(){
    const loanAmt = Number(document.getElementById('loanAmount').value) || 0;
    const fees = Number(document.getElementById('openingFees').value) || 0;
    document.getElementById('totalFinanced').textContent = money(loanAmt + fees);
  }

  function getLoanSettingsFromUI(){
    const loanAmt = clamp2(Number(document.getElementById('loanAmount').value) || 0);
    const fees = clamp2(Number(document.getElementById('openingFees').value) || 0);
    const totalFinanced = clamp2(loanAmt + fees);

    return {
      loanAmount: loanAmt,
      openingFees: fees,
      totalFinanced,
      originDate: document.getElementById('originDate').value || '2024-11-07',
      firstPaymentDate: document.getElementById('firstPaymentDate').value || '2024-11-15',
      numPayments: Math.max(1, parseInt(document.getElementById('numPayments').value) || 26),
      interestRatePct: clamp2(Number(document.getElementById('interestRate').value) || 18.99),
      rateType: document.getElementById('rateType').value || 'annual',
      frequencyDays: parseInt(document.getElementById('paymentFrequency').value) || 14
    };
  }

  function applyLoanSettingsToUI(s){
    if(!s) return;
    document.getElementById('loanAmount').value = s.loanAmount ?? 2000;
    document.getElementById('openingFees').value = s.openingFees ?? 250;
    document.getElementById('originDate').value = s.originDate ?? '2024-11-07';
    document.getElementById('firstPaymentDate').value = s.firstPaymentDate ?? '2024-11-15';
    document.getElementById('numPayments').value = s.numPayments ?? 26;
    document.getElementById('interestRate').value = s.interestRatePct ?? 18.99;
    document.getElementById('rateType').value = s.rateType ?? 'annual';
    document.getElementById('paymentFrequency').value = s.frequencyDays ?? 14;
    updateTotalFinanced();
  }

  // ===================== SAUVEGARDE / CHARGEMENT
  function saveLoanSettings(){
    const s = getLoanSettingsFromUI();
    if(s.totalFinanced <= 0){
      alert('Montant financ√© doit √™tre > 0');
      return;
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    logEvent('üíæ Sauvegarde', `Param√®tres sauvegard√©s: financ√© ${money(s.totalFinanced)}, ${s.numPayments} paiements, taux ${s.interestRatePct}%, freq ${s.frequencyDays}j.`);
  }

  function loadLoanSettings(andRecalc = false){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      alert('Aucune sauvegarde trouv√©e.');
      return;
    }
    const s = JSON.parse(raw);
    applyLoanSettingsToUI(s);
    logEvent('‚Ü©Ô∏è Chargement', `Sauvegarde charg√©e: financ√© ${money(s.totalFinanced)}.`);
    if(andRecalc) recalculateFromUI();
  }

  function saveAndRecalculate(){
    saveLoanSettings();
    recalculateFromUI();
  }

  // ===================== CALCUL / G√âN√âRATION DU PLAN
  // R√®gle adh√©sion: 7j => 22.50 / 14j => 45.00
  function getAdhesionFee(freqDays){
    return (freqDays === 7) ? 22.50 : 45.00;
  }

  // Daily rate selon type de taux (inclut l'ajustement "Margill" 2.8% sur annuel)
  function computeDailyRate(nominalRate, rateType, frequencyDays){
    if(rateType === 'periodic'){
      // nominalRate = taux par p√©riode (ex: 0.02 par 14j) -> quotidien
      return nominalRate / frequencyDays;
    }
    if(rateType === 'monthly'){
      return nominalRate / 30;
    }
    // annual
    const effectiveRate = nominalRate * 1.028; // Margill
    return effectiveRate / 365;
  }

  function generateScheduleFromSettings(s){
    const adhesionFee = getAdhesionFee(s.frequencyDays);
    const nominalRate = (s.interestRatePct/100);
    const dailyRate = computeDailyRate(nominalRate, s.rateType, s.frequencyDays);

    const originD = new Date(s.originDate + 'T00:00:00');
    const firstD = new Date(s.firstPaymentDate + 'T00:00:00');
    const daysToFirst = Math.max(1, Math.round((firstD - originD) / (1000 * 60 * 60 * 24)));

    let principal = s.totalFinanced;
    let currentDate = new Date(s.firstPaymentDate + 'T00:00:00');
    const schedule = [];

    // Capital fixe par paiement (sauf dernier ajust√©)
    const baseCapital = clamp2(s.totalFinanced / s.numPayments);

    for(let i=1;i<=s.numPayments;i++){
      let dateStr, daysForInterest;

      if(i === 1){
        dateStr = s.firstPaymentDate;
        daysForInterest = daysToFirst;
      } else {
        currentDate.setDate(currentDate.getDate() + s.frequencyDays);
        dateStr = currentDate.toISOString().split('T')[0];
        daysForInterest = s.frequencyDays;
      }

      const interest = clamp2(principal * dailyRate * daysForInterest);

      let capital = (i === s.numPayments) ? principal : baseCapital;
      capital = clamp2(capital);

      const loanPart = clamp2(capital + interest);
      const total = clamp2(loanPart + adhesionFee);

      const before = principal;
      const after = clamp2(Math.max(0, principal - capital));
      principal = after;

      schedule.push({
        i,
        date: dateStr,
        total,
        interest,
        capital,
        adhesion: adhesionFee,
        balanceBefore: before,
        balanceAfter: after
      });
    }

    return {schedule, adhesionFee, dailyRate};
  }

  function recalculateFromUI(){
    const s = getLoanSettingsFromUI();
    if(s.totalFinanced <= 0){
      alert('Montant financ√© doit √™tre > 0');
      return;
    }

    // s√©curit√© dates
    if(!s.originDate || !s.firstPaymentDate){
      alert('Dates origine et 1er paiement sont obligatoires');
      return;
    }

    const {schedule, adhesionFee} = generateScheduleFromSettings(s);
    state.schedule = schedule;

    // Header info
    const totalInterest = clamp2(schedule.reduce((sum,r)=>sum + (r.interest||0),0));
    document.getElementById('subHeader').textContent =
      `${s.numPayments} paiements ¬∑ ${s.frequencyDays}j ¬∑ Adh ${money(adhesionFee)} ¬∑ Int. total: ${money(totalInterest)}`;

    document.getElementById('footerInfo').textContent =
      `Financ√© ${money(s.totalFinanced)} ¬∑ Taux ${s.interestRatePct}% (${s.rateType})`;

    renderAll();

    logEvent('üßÆ Recalcul', `Nouveau plan g√©n√©r√© sur ${s.numPayments} paiements. Financ√© ${money(s.totalFinanced)}.`);
  }

  // ===================== RENDER
  function renderKPI(){
    const s = getLoanSettingsFromUI();
    const totalInterest = clamp2(state.schedule.reduce((sum,r)=>sum + (r.interest||0),0));
    const last = state.schedule[state.schedule.length-1];
    const remaining = last ? last.balanceAfter : 0;

    const kpis = [
      {label:'Montant financ√©', dot:'good', value: money(s.totalFinanced), sub:'Pr√™t + frais ouverture'},
      {label:'Nb paiements', dot:'good', value: String(s.numPayments), sub:`Fr√©quence: ${s.frequencyDays} jours`},
      {label:'Int√©r√™t total', dot:'warn', value: money(totalInterest), sub:'Somme des int√©r√™ts'},
      {label:'Solde fin', dot:(remaining===0?'good':'bad'), value: money(remaining), sub:'Apr√®s dernier paiement'}
    ];

    document.getElementById('kpi').innerHTML = kpis.map(k=>`
      <div class="kpi-card">
        <div class="kpi-label"><span>${k.label}</span><span class="kpi-dot ${k.dot}"></span></div>
        <div class="kpi-value">${k.value}</div>
        <div class="kpi-sub">${k.sub}</div>
      </div>
    `).join('');
  }

  function renderTable(){
    const tbody = document.getElementById('rows');
    tbody.innerHTML = (state.schedule || []).map(r=>`
      <tr>
        <td class="mono">${r.i}</td>
        <td>${fmtDate(r.date)}</td>
        <td class="mono">${money(r.total)}</td>
        <td class="mono">${money(r.interest)}</td>
        <td class="mono">${money(r.capital)}</td>
        <td class="mono">${money(r.adhesion)}</td>
        <td class="mono">${money(r.balanceBefore)}</td>
        <td class="mono">${money(r.balanceAfter)}</td>
      </tr>
    `).join('');

    document.getElementById('selectedInfo').textContent =
      state.schedule?.length ? `Lignes: ${state.schedule.length}` : 'Aucun plan';
  }

  function renderEvents(){
    const box = document.getElementById('events');
    const items = [...state.events].slice(-12).reverse();
    box.innerHTML = items.map(e=>{
      const d = new Date(e.ts);
      return `
        <div class="note">
          <div class="meta">
            <div class="title">${e.title}</div>
            <div class="time">${d.toLocaleDateString('fr-CA',{day:'2-digit',month:'short'})} ¬∑ ${d.toLocaleTimeString('fr-CA',{hour:'2-digit',minute:'2-digit'})}</div>
          </div>
          <div class="txt">${e.txt}</div>
        </div>
      `;
    }).join('') || `<div style="color:var(--muted2);font-size:12px">Aucune note.</div>`;
  }

  function renderAll(){
    updateTotalFinanced();
    renderKPI();
    renderTable();
    renderEvents();
  }

  // ===================== INIT
  function init(){
    updateTotalFinanced();

    // ‚úÖ Auto-charger la sauvegarde si elle existe
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{
        const s = JSON.parse(raw);
        applyLoanSettingsToUI(s);
        logEvent('‚Ü©Ô∏è Auto-chargement', 'Sauvegarde d√©tect√©e et charg√©e.');
      } catch(e){}
    }

    // G√©n√®re un plan au d√©marrage
    recalculateFromUI();
  }

  init();

  // Expose
  window.updateTotalFinanced = updateTotalFinanced;
  window.saveLoanSettings = saveLoanSettings;
  window.loadLoanSettings = loadLoanSettings;
  window.recalculateFromUI = recalculateFromUI;
  window.saveAndRecalculate = saveAndRecalculate;
</script>
</body>
</html>
