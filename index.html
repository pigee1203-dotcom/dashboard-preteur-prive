<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Pr√™teur ‚Äî Margill</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#121a2b;
      --panel2:#0f1626;
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --accent2:#34d399;
      --shadow: 0 18px 48px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1200px 600px at 15% 5%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(1000px 600px at 85% 0%, rgba(45,212,191,.14), transparent 55%),
        radial-gradient(900px 600px at 70% 90%, rgba(251,113,133,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      padding:22px;
    }
    .wrap{max-width:1280px;margin:0 auto}
    .topbar{
      display:flex;align-items:center;gap:14px;
      padding:16px 16px;border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    .brand{
      display:flex;align-items:center;gap:12px;min-width:250px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(96,165,250,.95), rgba(45,212,191,.70));
      border:1px solid rgba(255,255,255,.18);
      display:grid;place-items:center;
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .logo span{filter:drop-shadow(0 8px 14px rgba(0,0,0,.45))}
    .brand h1{font-size:16px;margin:0;letter-spacing:.2px}
    .brand p{margin:2px 0 0 0;font-size:12px;color:var(--muted2)}
    .search{
      flex:1;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--stroke);
    }
    .search input{
      width:100%;
      background:transparent;border:0;outline:0;
      color:var(--text);font-size:14px;
    }
    .pillrow{display:flex;align-items:center;gap:10px}
    .pill{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background:rgba(0,0,0,.26);
      border:1px solid var(--stroke);
      color:var(--text);font-size:13px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.good{background:var(--good);box-shadow:0 0 0 4px rgba(45,212,191,.15)}
    .dot.warn{background:var(--warn);box-shadow:0 0 0 4px rgba(251,191,36,.14)}
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.6fr 1fr 1fr 1fr;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: 0 16px 44px rgba(0,0,0,.45);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card::after{
      content:"";
      position:absolute;inset:-2px;
      background: radial-gradient(900px 260px at 20% 0%, rgba(96,165,250,.10), transparent 55%);
      pointer-events:none;
    }
    .kpi-title{font-size:12px;letter-spacing:.6px;text-transform:uppercase;color:var(--muted2);margin:0 0 10px 0}
    .kpi-value{font-size:30px;font-weight:800;margin:0}
    .kpi-sub{margin:8px 0 0 0;color:var(--muted2);font-size:12px}
    .kpi-dot{position:absolute;top:14px;right:14px}
    .kpi-dot .dot{width:9px;height:9px}
    .main{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.9fr 1fr;
      gap:14px;
      align-items:start;
    }
    .big{
      padding:0;
    }
    .bighead{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--stroke);
    }
    .bighead h2{margin:0;font-size:16px}
    .bighead .meta{margin:4px 0 0 0;font-size:12px;color:var(--muted2)}
    .toolbar{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke2);
      background:rgba(0,0,0,.22);
      color:var(--text);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.15s transform,.15s background,.15s border;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(0,0,0,.30);border-color:rgba(255,255,255,.22)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:rgba(96,165,250,.20);border-color:rgba(96,165,250,.35)}
    .btn.good{background:rgba(45,212,191,.16);border-color:rgba(45,212,191,.35)}
    .btn.warn{background:rgba(251,191,36,.14);border-color:rgba(251,191,36,.34)}
    .btn.bad{background:rgba(251,113,133,.14);border-color:rgba(251,113,133,.34)}
    .btn.icon{padding:10px 11px}
    .noteLine{
      padding:12px 16px;color:var(--muted2);font-size:12px;
      border-bottom:1px solid var(--stroke);
    }

    .tableWrap{padding:0 0 8px 0}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12.5px;
    }
    thead th{
      text-align:left;
      color:var(--muted2);
      font-weight:700;
      letter-spacing:.3px;
      padding:10px 10px;
      position:sticky;top:0;
      background:linear-gradient(180deg, rgba(18,26,43,.95), rgba(15,22,38,.95));
      border-bottom:1px solid var(--stroke);
      z-index:2;
    }
    tbody td{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
    }
    tbody tr{
      background:transparent;
      cursor:pointer;
    }
    tbody tr:hover{
      background:rgba(255,255,255,.03);
    }
    tbody tr.selected{
      background:rgba(96,165,250,.12);
      outline:1px solid rgba(96,165,250,.25);
    }
    .right{
      display:grid;
      gap:14px;
    }
    .panelTitle{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 16px;border-bottom:1px solid var(--stroke);
    }
    .panelTitle h3{margin:0;font-size:15px}
    .panelTitle .sub{margin:4px 0 0 0;font-size:12px;color:var(--muted2)}
    .panelBody{padding:14px 16px}
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{
      background:rgba(0,0,0,.22);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 10px;
    }
    .field label{
      display:block;
      font-size:11px;
      color:var(--muted2);
      margin:0 0 8px 0;
      text-transform:uppercase;
      letter-spacing:.55px;
    }
    .field input,.field select{
      width:100%;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      outline:0;
      padding:9px 10px;
      border-radius:12px;
      font-size:13px;
    }
    .field input[type="date"]{padding:8px 10px}
    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .smallPill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      font-size:13px;
      user-select:none;
      white-space:nowrap;
    }
    .statusPill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      font-size:12px;
      white-space:nowrap;
    }
    .statusDot{width:8px;height:8px;border-radius:50%}
    .statusDot.good{background:var(--good)}
    .statusDot.warn{background:var(--warn)}
    .statusDot.bad{background:var(--bad)}
    .mono{font-variant-numeric: tabular-nums}
    .muted{color:var(--muted2)}
    .right .card{padding:0}
    .pad{padding:14px 16px}

    .footerActions{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
      padding:12px 16px;border-top:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.18));
      border-bottom-left-radius: var(--r);
      border-bottom-right-radius: var(--r);
    }

    /* mini icons */
    .i{width:14px;height:14px;display:inline-block}
    .i svg{width:14px;height:14px;display:block}

    @media (max-width: 1100px){
      .grid{grid-template-columns:1fr 1fr}
      .main{grid-template-columns:1fr}
      .brand{min-width:auto}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logo" title="Dashboard Pr√™teur"><span>üíº</span></div>
      <div>
        <h1>Dashboard Pr√™teur</h1>
        <p>Gestion simplifi√©e ‚Äî Margill</p>
      </div>
    </div>

    <div class="search" title="Recherche (d√©mo)">
      <span class="muted">üîé</span>
      <input id="searchInput" placeholder="Rechercher un client (nom, #, t√©l√©phone, courriel‚Ä¶)" />
      <span class="muted" style="font-size:12px;border:1px solid var(--stroke);padding:4px 8px;border-radius:10px;">ESC</span>
    </div>

    <div class="pillrow">
      <div class="pill"><span class="dot good"></span> Connect√©</div>
      <div class="pill"><span class="dot warn"></span> Mode D√©mo</div>
    </div>
  </div>

  <!-- KPIs (comme ton √©cran) -->
  <div class="grid">
    <div class="card">
      <div class="kpi-dot"><span class="dot good"></span></div>
      <p class="kpi-title">Solde contrat</p>
      <p class="kpi-value mono" id="kpiSolde">0,00 $</p>
      <p class="kpi-sub">Solde apr√®s la ligne s√©lectionn√©e</p>
    </div>
    <div class="card">
      <div class="kpi-dot"><span class="dot good"></span></div>
      <p class="kpi-title">Souffrance</p>
      <p class="kpi-value mono" id="kpiSouffrance">0,00 $</p>
      <p class="kpi-sub">NSF = paiement + 48$</p>
    </div>
    <div class="card">
      <div class="kpi-dot"><span class="dot good"></span></div>
      <p class="kpi-title">Montant financ√©</p>
      <p class="kpi-value mono" id="kpiFinance">0,00 $</p>
      <p class="kpi-sub">Pr√™t + frais ouverture</p>
    </div>
    <div class="card">
      <div class="kpi-dot"><span class="dot warn"></span></div>
      <p class="kpi-title">Int√©r√™t total</p>
      <p class="kpi-value mono" id="kpiInteret">0,00 $</p>
      <p class="kpi-sub">Somme des int√©r√™ts (plan)</p>
    </div>
  </div>

  <div class="main">
    <!-- CALENDRIER -->
    <div class="card big">
      <div class="bighead">
        <div>
          <h2>Calendrier des paiements</h2>
          <div class="meta" id="calendarMeta">‚Äî</div>
        </div>

        <!-- BARRE D'ACTIONS (comme ton 1er √©cran) -->
        <div class="toolbar">
          <button class="btn primary" id="btnReporter" title="Reporter la date de la ligne s√©lectionn√©e (+ fr√©quence)">
            <span>üóìÔ∏è</span><span>Reporter</span>
          </button>
          <button class="btn" id="btnCapital" title="Marquer comme paiement CAPITAL (encaiss√©, 0 int√©r√™t)">
            <span>ü™ô</span><span>Capital</span>
          </button>
          <button class="btn" id="btnManuel" title="Paiement manuel (tu entres le montant encaiss√©)">
            <span>üíµ</span><span>Manuel</span>
          </button>
          <button class="btn" id="btnEntente" title="Mettre ligne en ENTENTE (ne touche pas au solde)">
            <span>üßæ</span><span>Entente</span>
          </button>
          <button class="btn bad" id="btnNSF" title="Marquer NSF (encaiss√© 0 + souffrance paiement+48)">
            <span>‚ùå</span><span>NSF</span>
          </button>

          <!-- DISQUETTE (sauvegarde) -->
          <button class="btn good icon" id="btnSave" title="Sauvegarder (disquette)">
            üíæ
          </button>
          <button class="btn icon" id="btnLoad" title="Charger la sauvegarde">
            ‚Ü©Ô∏è
          </button>
        </div>
      </div>

      <div class="noteLine">S√©lectionne une ligne pour agir dessus. (Le solde bouge seulement quand encaiss√©.)</div>

      <div class="tableWrap" style="max-height:520px;overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:42px;">#</th>
              <th style="width:120px;">Date</th>
              <th style="width:150px;">Type</th>
              <th style="width:110px;">Total</th>
              <th style="width:95px;">Pr√™t</th>
              <th style="width:85px;">Int.</th>
              <th style="width:85px;">Cap.</th>
              <th style="width:80px;">Adh.</th>
              <th style="width:80px;">NSF</th>
              <th style="width:90px;">Ajust</th>
              <th style="width:120px;">Statut</th>
              <th style="width:105px;">Avant</th>
              <th style="width:105px;">Apr√®s</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footerActions">
        <button class="btn primary" id="btnRecalc" title="Reg√©n√©rer le plan √† partir des valeurs de 'Pr√™t & Banque'">
          üßÆ Recalculer plan
        </button>
        <button class="btn" id="btnResetDemo" title="Remettre un exemple complet (d√©mo)">
          ‚ôªÔ∏è Remettre D√©mo
        </button>
      </div>
    </div>

    <!-- PANNEAUX DROITE -->
    <div class="right">

      <!-- FICHE CLIENT -->
      <div class="card">
        <div class="panelTitle">
          <div>
            <h3>Fiche client</h3>
            <p class="sub muted">#<span id="clientId">10023</span></p>
          </div>
          <div class="smallPill"><span class="dot good"></span> Actif</div>
        </div>

        <div class="panelBody">
          <div class="formGrid">
            <div class="field">
              <label>Pr√©nom</label>
              <input id="clientPrenom" value="Marc" />
            </div>
            <div class="field">
              <label>Nom</label>
              <input id="clientNom" value="Savoie" />
            </div>

            <div class="field">
              <label>Adresse</label>
              <input id="clientAdresse" value="123 Rue Principale" />
            </div>
            <div class="field">
              <label>App</label>
              <input id="clientApp" value="4B" />
            </div>

            <div class="field">
              <label>Ville</label>
              <input id="clientVille" value="Montr√©al" />
            </div>
            <div class="field">
              <label>Prov/√âtat</label>
              <input id="clientProv" value="QC" />
            </div>

            <div class="field">
              <label>Code postal</label>
              <input id="clientCP" value="H2X 1Y4" />
            </div>
            <div class="field">
              <label>Date naissance</label>
              <input id="clientNaissance" type="date" value="1985-03-22" />
            </div>

            <div class="field">
              <label>Num√©ro 1</label>
              <input id="clientTel1" value="514-555-1234" />
            </div>
            <div class="field">
              <label>Num√©ro 2</label>
              <input id="clientTel2" value="438-555-9876" />
            </div>

            <div class="field" style="grid-column: 1 / -1;">
              <label>Courriel</label>
              <input id="clientEmail" value="marc.savoie@email.com" />
            </div>
          </div>
        </div>
      </div>

      <!-- PR√äT & BANQUE (c‚Äôest ici que tu changes financement et tu recalcules) -->
      <div class="card">
        <div class="panelTitle">
          <div>
            <h3>Pr√™t & Banque</h3>
            <p class="sub muted"><span id="pbClientName">Marc Savoie</span> ‚Ä¢ #<span id="pbClientId">10023</span></p>
          </div>
          <div class="smallPill"><span class="dot good"></span> PAD Actif</div>
        </div>

        <div class="panelBody">
          <div class="formGrid">
            <div class="field">
              <label>Montant pr√™t</label>
              <input id="loanPrincipal" type="number" step="0.01" value="2000" />
            </div>
            <div class="field">
              <label>Frais ouverture</label>
              <input id="loanFee" type="number" step="0.01" value="250" />
            </div>

            <div class="field">
              <label>Taux annuel (%)</label>
              <input id="loanRate" type="number" step="0.001" value="18.990" />
            </div>
            <div class="field">
              <label>Nb paiements</label>
              <input id="loanN" type="number" step="1" value="26" />
            </div>

            <div class="field">
              <label>Fr√©quence</label>
              <select id="loanFreq">
                <option value="7">7 jours (semaine)</option>
                <option value="14" selected>14 jours (2 semaines)</option>
                <option value="30">30 jours (mensuel)</option>
              </select>
            </div>
            <div class="field">
              <label>Adh√©sion / paiement</label>
              <input id="loanMembership" type="number" step="0.01" value="45.00" />
            </div>

            <div class="field">
              <label>Date origine</label>
              <input id="loanStart" type="date" value="2024-11-07" />
            </div>
            <div class="field">
              <label>Montant financ√©</label>
              <input id="loanFinanced" type="text" readonly value="2 250,00 $" />
            </div>
          </div>

          <div style="margin-top:12px;color:var(--muted2);font-size:12px;line-height:1.35">
            * Le plan est un amortissement standard : int√©r√™t par p√©riode = solde √ó taux/p√©riodes. <br/>
            * Le solde change seulement quand tu marques encaiss√© (PAY√â/PARTIEL/MANUEL/CAPITAL). NSF = encaiss√© 0 + souffrance.
          </div>
        </div>

        <div class="footerActions">
          <button class="btn primary" id="btnApplyLoan">‚úÖ Appliquer & Recalculer</button>
          <button class="btn good" id="btnQuickSave">üíæ Sauvegarder</button>
          <button class="btn" id="btnQuickLoad">‚Ü©Ô∏è Charger</button>
        </div>
      </div>

      <!-- NOTES -->
      <div class="card">
        <div class="panelTitle">
          <div>
            <h3>Notes</h3>
            <p class="sub muted">Historique</p>
          </div>
        </div>
        <div class="panelBody" id="notes" style="display:grid;gap:10px;">
          <!-- notes inject√©es -->
        </div>
      </div>

    </div>
  </div>

</div>

<script>
/* =========================
   UTILITAIRES
========================= */
const fmt = new Intl.NumberFormat('fr-CA', { style:'currency', currency:'CAD' });
const fmt2 = new Intl.NumberFormat('fr-CA', { minimumFractionDigits:2, maximumFractionDigits:2 });

function money(n){ return fmt.format(Number(n||0)); }
function num(n){ n = Number(n||0); return Math.round(n*100)/100; }
function clampInt(n,min,max){ n = Math.floor(Number(n||0)); return Math.max(min, Math.min(max, n)); }

function addDays(isoDate, days){
  const d = new Date(isoDate + "T12:00:00");
  d.setDate(d.getDate()+Number(days));
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

function periodsPerYear(freqDays){
  // approximation: 365 / freqDays
  return 365 / Number(freqDays);
}

function amortPayment(P, r, n){
  // r = taux par p√©riode
  if(n<=0) return 0;
  if(Math.abs(r) < 1e-10) return P / n;
  return P * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
}

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

/* =========================
   √âTAT
========================= */
const STORAGE_KEY = "margill_dashboard_v1";

let state = {
  client: {
    id: "10023",
    prenom: "Marc",
    nom: "Savoie",
    adresse: "123 Rue Principale",
    app: "4B",
    ville: "Montr√©al",
    prov: "QC",
    cp: "H2X 1Y4",
    naissance: "1985-03-22",
    tel1: "514-555-1234",
    tel2: "438-555-9876",
    email: "marc.savoie@email.com",
  },
  loan: {
    principal: 2000,
    fee: 250,
    rateAnnualPct: 18.990,
    n: 26,
    freqDays: 14,
    membership: 45.00,
    startDate: "2024-11-07",
  },
  // ledger lines (plan + actions)
  lines: [],
  selectedIndex: 0,
  notes: []
};

function pushNote(title, text){
  state.notes.unshift({ id: uid(), title, text, ts: new Date().toISOString() });
  state.notes = state.notes.slice(0, 25);
  renderNotes();
}

/* =========================
   G√âN√âRATION PLAN
========================= */
function generatePlanFromLoan(){
  const L = state.loan;
  const financed = num(L.principal) + num(L.fee);

  const perYear = periodsPerYear(L.freqDays);
  const r = (num(L.rateAnnualPct)/100) / perYear;      // taux par p√©riode
  const n = clampInt(L.n, 1, 500);

  const pay = amortPayment(financed, r, n);            // paiement (sans adh√©sion)
  let balance = financed;

  const lines = [];
  let totalInterest = 0;

  for(let i=1;i<=n;i++){
    const interest = num(balance * r);
    let principalPay = num(pay - interest);
    if(principalPay < 0) principalPay = 0;

    // Derni√®re ligne: ajuste pour finir √† 0 pile (arrondis)
    if(i === n){
      principalPay = num(balance);
    }

    const before = num(balance);
    const after = num(balance - principalPay);

    totalInterest += interest;

    lines.push({
      id: uid(),
      idx: i,
      date: addDays(L.startDate, L.freqDays*(i)), // 1√®re √©ch√©ance = start + freq
      type: "PMNT A VENIR",
      // plan (pr√©vision)
      plan_prt: principalPay,
      plan_int: interest,
      plan_cap: principalPay, // m√™me valeur, on garde les colonnes compl√®tes
      plan_adh: num(L.membership),
      plan_total: num(principalPay + interest + num(L.membership)),
      // action fields
      nsfFee: 0,
      adjust: 0,
      status: "√Ä venir",
      // computed balances shown
      soldeAvant: before,
      soldeApres: after,
      // encaiss√© r√©el
      encaisse: 0,
      // flags
      isLocked: false
    });

    balance = after;
  }

  state.lines = lines;
  state.selectedIndex = 0;

  // KPIs
  updateKpis();
  renderTable();
  updateMeta(totalInterest, financed);
}

function updateMeta(totalInterest, financed){
  const L = state.loan;
  const meta = `${L.n} paiements ‚Ä¢ ${L.freqDays} jours ‚Ä¢ Adh√©sion ${money(L.membership)} ‚Ä¢ Int. plan: ${money(totalInterest)}`;
  document.getElementById("calendarMeta").textContent = meta;
  document.getElementById("kpiFinance").textContent = money(financed);
  document.getElementById("kpiInteret").textContent = money(totalInterest);
  document.getElementById("loanFinanced").value = fmt2.format(financed).replace('.',',') + " $";
}

function recalcBalancesFromActions(){
  // R√àGLE MARGILL: solde bouge seulement quand encaiss√©.
  // On repart du solde initial (financ√©) et on applique lignes encaiss√©es dans l'ordre.
  const financed = num(state.loan.principal) + num(state.loan.fee);
  let balance = financed;

  for(const line of state.lines){
    line.soldeAvant = num(balance);

    let delta = 0; // montant √† retirer du solde (capital encaiss√©)
    let addSouffrance = 0;

    const type = line.type;

    if(type === "PAY√â"){
      // encaiss√© total plan -> retire capital plan
      delta = num(line.plan_prt);
      line.encaisse = num(line.plan_total);
      line.status = "Pay√©";
      line.isLocked = true;
    } else if(type === "PARTIEL"){
      // encaisse partiel: on retire du capital la portion capital r√©elle (simplifi√©: tout ce qui d√©passe int√©r√™t+adh√©sion va au capital)
      // Ici on utilise encaisse comme valeur entr√©e dans 'adjust' (on s'en sert pour stocker l'encaisse partiel).
      const enc = num(line.encaisse);
      const minNonCap = num(line.plan_int + line.plan_adh);
      const cap = Math.max(0, num(enc - minNonCap));
      delta = num(cap);
      line.status = "Partiel";
      line.isLocked = true;
    } else if(type === "MANUEL"){
      // m√™me logique que partiel, encaisse = valeur entr√©e
      const enc = num(line.encaisse);
      const minNonCap = num(line.plan_int + line.plan_adh);
      const cap = Math.max(0, num(enc - minNonCap));
      delta = num(cap);
      line.status = "Manuel";
      line.isLocked = true;
    } else if(type === "CAPITAL"){
      // tout ce qui est encaiss√© va au capital (encaisse = valeur entr√©e ou plan total si vide)
      const enc = num(line.encaisse || line.plan_total);
      delta = num(enc); // tout au capital
      line.status = "Capital";
      line.isLocked = true;
    } else if(type === "ENTENTE"){
      delta = 0;
      line.encaisse = 0;
      line.status = "Entente";
      line.isLocked = true;
    } else if(type === "NSF"){
      // encaiss√© 0 + souffrance (paiement plan + 48)
      delta = 0;
      line.encaisse = 0;
      line.nsfFee = num(line.plan_total + 48);
      addSouffrance = line.nsfFee;
      line.status = "NSF";
      line.isLocked = true;
    } else {
      // PMNT A VENIR
      line.encaisse = 0;
      line.nsfFee = 0;
      line.status = "√Ä venir";
      line.isLocked = false;
    }

    // Ajustement manuel (peut √™tre + ou -)
    const adj = num(line.adjust);
    balance = num(balance - delta + adj);

    line.soldeApres = num(balance);
    line._souffranceAdd = addSouffrance;
  }

  updateKpis();
  renderTable();
}

function totalSouffrance(){
  return num(state.lines.reduce((s,l)=> s + num(l.nsfFee||0), 0));
}

function totalInteretPlan(){
  return num(state.lines.reduce((s,l)=> s + num(l.plan_int||0), 0));
}

function updateKpis(){
  const financed = num(state.loan.principal) + num(state.loan.fee);
  const interestTotal = totalInteretPlan();
  const souff = totalSouffrance();

  const sel = state.lines[state.selectedIndex] || state.lines[state.lines.length-1];
  const soldeAffiche = sel ? sel.soldeApres : financed;

  document.getElementById("kpiSolde").textContent = money(soldeAffiche);
  document.getElementById("kpiSouffrance").textContent = money(souff);
  document.getElementById("kpiFinance").textContent = money(financed);
  document.getElementById("kpiInteret").textContent = money(interestTotal);
}

/* =========================
   RENDER TABLE
========================= */
const tbody = document.getElementById("tbody");

function statusPill(status){
  let cls = "warn";
  if(status === "Pay√©" || status === "Manuel" || status === "Partiel" || status === "Capital") cls = "good";
  if(status === "NSF") cls = "bad";
  return `<span class="statusPill"><span class="statusDot ${cls}"></span>${status}</span>`;
}

function renderTable(){
  tbody.innerHTML = "";
  state.lines.forEach((l, i)=>{
    const tr = document.createElement("tr");
    if(i === state.selectedIndex) tr.classList.add("selected");

    const typeSelect = `
      <select data-i="${i}" class="typeSel" style="width:140px">
        <option ${l.type==="PMNT A VENIR"?"selected":""}>PMNT A VENIR</option>
        <option ${l.type==="PAY√â"?"selected":""}>PAY√â</option>
        <option ${l.type==="PARTIEL"?"selected":""}>PARTIEL</option>
        <option ${l.type==="MANUEL"?"selected":""}>MANUEL</option>
        <option ${l.type==="ENTENTE"?"selected":""}>ENTENTE</option>
        <option ${l.type==="CAPITAL"?"selected":""}>CAPITAL</option>
        <option ${l.type==="NSF"?"selected":""}>NSF</option>
      </select>
    `;

    tr.innerHTML = `
      <td class="mono">${l.idx}</td>
      <td class="mono"><input data-i="${i}" class="dateInp" type="date" value="${l.date}" style="width:130px"/></td>
      <td>${typeSelect}</td>
      <td class="mono">${money(l.plan_total)}</td>
      <td class="mono">${money(l.plan_prt)}</td>
      <td class="mono">${money(l.plan_int)}</td>
      <td class="mono">${money(l.plan_cap)}</td>
      <td class="mono">${money(l.plan_adh)}</td>
      <td class="mono">${money(l.nsfFee||0)}</td>
      <td class="mono"><input data-i="${i}" class="adjInp" type="number" step="0.01" value="${num(l.adjust)}" style="width:90px"/></td>
      <td>${statusPill(l.status)}</td>
      <td class="mono">${money(l.soldeAvant)}</td>
      <td class="mono">${money(l.soldeApres)}</td>
    `;

    tr.addEventListener("click",(e)=>{
      // √©viter de changer s√©lection quand on clique dans input/select
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      if(tag === "input" || tag === "select" || tag === "option") return;
      state.selectedIndex = i;
      updateKpis();
      renderTable();
    });

    tbody.appendChild(tr);
  });

  // events
  document.querySelectorAll(".typeSel").forEach(sel=>{
    sel.addEventListener("change", (e)=>{
      const i = Number(e.target.getAttribute("data-i"));
      const v = e.target.value;
      const l = state.lines[i];

      // si on passe √† PARTIEL/MANUEL/CAPITAL, on demande un montant encaiss√© (une fois)
      if(v === "PARTIEL" || v === "MANUEL" || v === "CAPITAL"){
        const def = (v==="CAPITAL") ? l.plan_total : l.plan_total;
        const msg = (v==="CAPITAL")
          ? "Montant encaiss√© (tout va au capital) :"
          : "Montant encaiss√© (PARTIEL/MANUEL) :";
        const ans = prompt(msg, String(def));
        if(ans === null){ e.target.value = l.type; return; }
        l.encaisse = num(ans);
      } else {
        l.encaisse = 0;
      }

      l.type = v;
      // reset nsfFee si pas NSF
      if(v !== "NSF") l.nsfFee = 0;
      recalcBalancesFromActions();
    });
  });

  document.querySelectorAll(".dateInp").forEach(inp=>{
    inp.addEventListener("change",(e)=>{
      const i = Number(e.target.getAttribute("data-i"));
      state.lines[i].date = e.target.value;
      // pas besoin recalcul solde
      saveAuto();
    });
  });

  document.querySelectorAll(".adjInp").forEach(inp=>{
    inp.addEventListener("change",(e)=>{
      const i = Number(e.target.getAttribute("data-i"));
      state.lines[i].adjust = num(e.target.value);
      recalcBalancesFromActions();
    });
  });
}

function renderNotes(){
  const box = document.getElementById("notes");
  box.innerHTML = "";
  state.notes.forEach(n=>{
    const d = new Date(n.ts);
    const h = document.createElement("div");
    h.className = "field";
    h.style.padding = "12px 12px";
    h.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:800">${n.title}</div>
        <div class="muted" style="font-size:11px">${d.toLocaleString('fr-CA')}</div>
      </div>
      <div class="muted" style="margin-top:6px;font-size:12px;line-height:1.35">${n.text}</div>
    `;
    box.appendChild(h);
  });
}

/* =========================
   ACTIONS BOUTONS (comme ton 1er √©cran)
========================= */
function requireSelected(){
  if(!state.lines.length) return null;
  return state.lines[state.selectedIndex] || null;
}

document.getElementById("btnReporter").addEventListener("click", ()=>{
  const l = requireSelected(); if(!l) return;
  const days = num(state.loan.freqDays);
  l.date = addDays(l.date, days);
  pushNote("Reporter", `Ligne #${l.idx} report√©e de +${days} jours.`);
  renderTable();
  saveAuto();
});

document.getElementById("btnEntente").addEventListener("click", ()=>{
  const l = requireSelected(); if(!l) return;
  l.type = "ENTENTE";
  l.encaisse = 0;
  pushNote("Entente", `Ligne #${l.idx} mise en ENTENTE (solde inchang√©).`);
  recalcBalancesFromActions();
});

document.getElementById("btnNSF").addEventListener("click", ()=>{
  const l = requireSelected(); if(!l) return;
  l.type = "NSF";
  l.encaisse = 0;
  pushNote("NSF", `Ligne #${l.idx} NSF: encaiss√© 0, souffrance = paiement + 48$.`);
  recalcBalancesFromActions();
});

document.getElementById("btnCapital").addEventListener("click", ()=>{
  const l = requireSelected(); if(!l) return;
  const ans = prompt("Montant encaiss√© (tout au capital) :", String(l.plan_total));
  if(ans === null) return;
  l.type = "CAPITAL";
  l.encaisse = num(ans);
  pushNote("Capital", `Ligne #${l.idx} CAPITAL encaiss√© ${money(l.encaisse)}.`);
  recalcBalancesFromActions();
});

document.getElementById("btnManuel").addEventListener("click", ()=>{
  const l = requireSelected(); if(!l) return;
  const ans = prompt("Montant encaiss√© (MANUEL) :", String(l.plan_total));
  if(ans === null) return;
  l.type = "MANUEL";
  l.encaisse = num(ans);
  pushNote("Manuel", `Ligne #${l.idx} MANUEL encaiss√© ${money(l.encaisse)}.`);
  recalcBalancesFromActions();
});

/* =========================
   SAUVEGARDE / CHARGER (DISQUETTE)
========================= */
function serialize(){
  // copie valeurs client depuis inputs (fiche)
  state.client.prenom = document.getElementById("clientPrenom").value.trim();
  state.client.nom = document.getElementById("clientNom").value.trim();
  state.client.adresse = document.getElementById("clientAdresse").value.trim();
  state.client.app = document.getElementById("clientApp").value.trim();
  state.client.ville = document.getElementById("clientVille").value.trim();
  state.client.prov = document.getElementById("clientProv").value.trim();
  state.client.cp = document.getElementById("clientCP").value.trim();
  state.client.naissance = document.getElementById("clientNaissance").value;
  state.client.tel1 = document.getElementById("clientTel1").value.trim();
  state.client.tel2 = document.getElementById("clientTel2").value.trim();
  state.client.email = document.getElementById("clientEmail").value.trim();
  return JSON.stringify(state);
}

function save(){
  localStorage.setItem(STORAGE_KEY, serialize());
  pushNote("Sauvegarde", "Donn√©es sauvegard√©es (localStorage).");
}

function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ alert("Aucune sauvegarde trouv√©e."); return; }
  try{
    const s = JSON.parse(raw);
    state = s;
    hydrateUI();
    recalcBalancesFromActions();
    pushNote("Chargement", "Sauvegarde charg√©e.");
  }catch(e){
    alert("Sauvegarde corrompue.");
  }
}

function saveAuto(){
  // sauvegarde silencieuse (utile quand tu modifies date/ajust)
  try{ localStorage.setItem(STORAGE_KEY, serialize()); }catch(e){}
}

document.getElementById("btnSave").addEventListener("click", save);
document.getElementById("btnLoad").addEventListener("click", load);
document.getElementById("btnQuickSave").addEventListener("click", save);
document.getElementById("btnQuickLoad").addEventListener("click", load);

/* =========================
   PR√äT & BANQUE ‚Äî appliquer & recalculer
========================= */
function readLoanFromInputs(){
  state.loan.principal = num(document.getElementById("loanPrincipal").value);
  state.loan.fee = num(document.getElementById("loanFee").value);
  state.loan.rateAnnualPct = num(document.getElementById("loanRate").value);
  state.loan.n = clampInt(document.getElementById("loanN").value, 1, 500);
  state.loan.freqDays = clampInt(document.getElementById("loanFreq").value, 1, 60);
  state.loan.membership = num(document.getElementById("loanMembership").value);
  state.loan.startDate = document.getElementById("loanStart").value || state.loan.startDate;

  const financed = num(state.loan.principal) + num(state.loan.fee);
  document.getElementById("loanFinanced").value = fmt2.format(financed).replace('.',',') + " $";
}

document.getElementById("btnApplyLoan").addEventListener("click", ()=>{
  readLoanFromInputs();
  generatePlanFromLoan();
  pushNote("Recalcul", `Nouveau plan g√©n√©r√© sur ${state.loan.n} paiements. Financ√© ${money(num(state.loan.principal)+num(state.loan.fee))}.`);
  saveAuto();
});

document.getElementById("btnRecalc").addEventListener("click", ()=>{
  readLoanFromInputs();
  generatePlanFromLoan();
  pushNote("Recalcul", `Plan reg√©n√©r√© √† partir de Pr√™t & Banque.`);
  saveAuto();
});

document.getElementById("btnResetDemo").addEventListener("click", ()=>{
  resetDemo();
  pushNote("D√©mo", "Exemple remis (structure compl√®te).");
  saveAuto();
});

/* =========================
   HYDRATE UI
========================= */
function hydrateUI(){
  // client
  document.getElementById("clientId").textContent = state.client.id;
  document.getElementById("pbClientId").textContent = state.client.id;

  document.getElementById("clientPrenom").value = state.client.prenom;
  document.getElementById("clientNom").value = state.client.nom;
  document.getElementById("clientAdresse").value = state.client.adresse;
  document.getElementById("clientApp").value = state.client.app;
  document.getElementById("clientVille").value = state.client.ville;
  document.getElementById("clientProv").value = state.client.prov;
  document.getElementById("clientCP").value = state.client.cp;
  document.getElementById("clientNaissance").value = state.client.naissance;
  document.getElementById("clientTel1").value = state.client.tel1;
  document.getElementById("clientTel2").value = state.client.tel2;
  document.getElementById("clientEmail").value = state.client.email;

  const full = `${state.client.prenom} ${state.client.nom}`.trim();
  document.getElementById("pbClientName").textContent = full;

  // loan
  document.getElementById("loanPrincipal").value = state.loan.principal;
  document.getElementById("loanFee").value = state.loan.fee;
  document.getElementById("loanRate").value = state.loan.rateAnnualPct;
  document.getElementById("loanN").value = state.loan.n;
  document.getElementById("loanFreq").value = state.loan.freqDays;
  document.getElementById("loanMembership").value = state.loan.membership;
  document.getElementById("loanStart").value = state.loan.startDate;

  const financed = num(state.loan.principal) + num(state.loan.fee);
  document.getElementById("loanFinanced").value = fmt2.format(financed).replace('.',',') + " $";

  renderNotes();
}

/* =========================
   D√âMO PAR D√âFAUT
========================= */
function resetDemo(){
  state = {
    client: {
      id: "10023",
      prenom: "Marc",
      nom: "Savoie",
      adresse: "123 Rue Principale",
      app: "4B",
      ville: "Montr√©al",
      prov: "QC",
      cp: "H2X 1Y4",
      naissance: "1985-03-22",
      tel1: "514-555-1234",
      tel2: "438-555-9876",
      email: "marc.savoie@email.com",
    },
    loan: {
      principal: 2000,
      fee: 250,
      rateAnnualPct: 18.990,
      n: 26,
      freqDays: 14,
      membership: 45.00,
      startDate: "2024-11-07",
    },
    lines: [],
    selectedIndex: 0,
    notes: [
      { id: uid(), title:"Recalcul", text:"Nouveau plan g√©n√©r√© sur 26 paiements. Financ√© 2 250,00 $.", ts: new Date().toISOString() }
    ]
  };
  hydrateUI();
  generatePlanFromLoan();
}

(function boot(){
  // ESC clear search
  document.addEventListener("keydown",(e)=>{
    if(e.key === "Escape"){
      const s = document.getElementById("searchInput");
      s.value = "";
      s.blur();
    }
  });

  // auto charger sauvegarde si existe
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{
      state = JSON.parse(raw);
      hydrateUI();
      if(!state.lines || !state.lines.length){
        generatePlanFromLoan();
      }else{
        recalcBalancesFromActions();
        renderNotes();
      }
    }catch(e){
      resetDemo();
    }
  }else{
    resetDemo();
  }
})();
</script>
</body>
</html>
