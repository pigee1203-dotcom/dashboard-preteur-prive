<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard pr√™teur priv√©</title>
  <style>
    :root{
      --bg:#0b1220;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r:16px;
      --r2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(45,212,191,.18), transparent 55%),
        radial-gradient(900px 650px at 60% 120%, rgba(251,113,133,.14), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;margin:8px 0 16px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(96,165,250,.9), rgba(45,212,191,.75));
      box-shadow:0 12px 30px rgba(96,165,250,.20);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:18px;margin:0;line-height:1.2}
    .brand p{margin:0;color:var(--muted2);font-size:12px}
    .search{
      flex:1;max-width:520px;margin:0 14px;
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
    }
    .search input{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-size:14px}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
    .grid{display:grid;grid-template-columns: 1.2fr 0.8fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .search{display:none} }
    .cards{display:grid;grid-template-columns: repeat(4, 1fr);gap:12px;margin-bottom:14px;}
    @media (max-width: 980px){ .cards{grid-template-columns: repeat(2, 1fr)} }

    .card{
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      padding:12px 12px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .card .label{color:var(--muted2);font-size:12px;display:flex;justify-content:space-between;gap:10px}
    .card .value{font-size:18px;margin-top:8px;font-weight:700;letter-spacing:.2px}
    .card .sub{margin-top:8px;color:var(--muted);font-size:12px}

    .panel{
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .panelHeader h2{margin:0;font-size:14px}
    .panelHeader small{color:var(--muted2)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      color:var(--text);
      padding:9px 10px;
      border-radius:14px;
      font-size:12px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, opacity .12s ease;
      display:flex;align-items:center;gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color:rgba(96,165,250,.45); background:rgba(96,165,250,.16)}
    .btn.danger{border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.14)}
    .btn.good{border-color:rgba(45,212,191,.45); background:rgba(45,212,191,.12)}
    .btn.ghost{background:transparent}
    .btn.disabled{opacity:.45; pointer-events:none;}

    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px;}
    th, td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;white-space:nowrap;}
    th{
      position:sticky;top:0;z-index:2;
      background:rgba(10,18,32,.85);
      backdrop-filter: blur(12px);
      color:var(--muted);
      font-weight:600;
    }
    tr:hover td{background:rgba(255,255,255,.04)}
    .status{
      padding:5px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;
      display:inline-flex;align-items:center;gap:8px;
      color:var(--muted);
    }
    .rightCol{display:flex;flex-direction:column;gap:14px;}
    .section{padding:14px;}
    .kv{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:10px;}
    .kv .item{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .kv .k{color:var(--muted2);font-size:11px}
    .kv .v{margin-top:6px;font-weight:700}
    .mono{font-family:var(--mono)}

    .notes{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .note{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .note .meta{color:var(--muted2);font-size:11px;display:flex;justify-content:space-between}
    .note .txt{margin-top:6px;color:var(--text);font-size:12.5px}

    .footerBar{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      color:var(--muted2);
      font-size:12px;
    }
    .hint{color:var(--muted2); font-size:12px; padding:10px 14px 0;}

    /* Souffrance list */
    .arrearsBox{
      margin-top:12px;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      max-height:260px;
      overflow:auto;
    }
    .arrearsRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      margin-bottom:8px;
    }
    .arrearsRow:hover{background:rgba(255,255,255,.05)}
    .arrearsLeft{display:flex;flex-direction:column;gap:4px;min-width:0}
    .arrearsTitle{font-size:12.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .arrearsMeta{font-size:11px;color:var(--muted2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;color:var(--muted);
    }

    /* Modal */
    .modalOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(760px, 100%);
      background:rgba(16,31,59,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius:22px;
      box-shadow:0 30px 100px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .modalHead h3{margin:0;font-size:14px}
    .modalBody{padding:14px}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width: 640px){ .row{grid-template-columns:1fr} }
    .field{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .field label{display:block;color:var(--muted2);font-size:11px;margin-bottom:8px}
    .field input, .field select{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    .summary{
      margin-top:12px;
      padding:12px;border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12.5px;
      line-height:1.45;
    }
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
    }
    .listBox{
      margin-top:10px;
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      max-height:260px;
      overflow:auto;
    }
    .chk{
      display:flex;gap:10px;align-items:flex-start;
      padding:8px;border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      margin-bottom:8px;
    }
    .chk:hover{background:rgba(255,255,255,.05)}
    .chk input{margin-top:2px}
    .chk .t{font-size:12.5px}
    .chk .m{color:var(--muted2);font-size:11px;margin-top:4px}
    .inlineInfo{
      margin-top:10px;
      color:var(--muted2);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Dashboard pr√™teur priv√©</h1>
          <p>Client ¬∑ Contrat ¬∑ Calendrier ¬∑ Souffrance ‚Äî simple et clair</p>
        </div>
      </div>

      <div class="search" title="Recherche (mock)">
        üîé <input placeholder="Rechercher un client, un contrat, une date‚Ä¶" />
        <span class="pill"><span class="dot good"></span> Live: mock</span>
      </div>

      <div class="pill" title="Mode"><span class="dot warn"></span> Mode: D√©mo</div>
    </div>

    <div class="cards" id="kpi"></div>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Calendrier des paiements</h2>
              <small id="subHeader">26 paiements ¬∑ 14 jours ¬∑ Adh√©sion 45,00$</small>
            </div>
            <div class="actions">
              <button class="btn primary" onclick="openAction('report')">üìÖ Reporter</button>
              <button class="btn" onclick="openAction('manual')">üíµ Paiement manuel</button>
              <button class="btn ghost" onclick="resetDemo()">‚Ü©Ô∏è Reset</button>
            </div>
          </div>

          <div class="hint">Clique une ligne pour la s√©lectionner. NSF se g√®re dans ‚ÄúSouffrance & √©v√©nements‚Äù.</div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Total</th>
                  <th>Pr√™t</th>
                  <th>Int√©r√™t</th>
                  <th>Capital</th>
                  <th>Adh√©sion</th>
                  <th>Ajustement</th>
                  <th>Statut</th>
                  <th>Solde apr√®s</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div class="footerBar">
            <div>R√®gles: seulement <b>7</b> ou <b>14</b> jours ¬∑ Taux nominal <span class="mono">18.99%</span></div>
            <div class="mono" id="selectedInfo">S√©lection: #1</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="rightCol">
        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Fiche client</h2>
              <small>Tout en 1 page</small>
            </div>
            <div class="pill"><span class="dot good"></span> Actif</div>
          </div>
          <div class="section">
            <div class="kv">
              <div class="item">
                <div class="k">Client</div>
                <div class="v">Marc Savoie <span class="mono" style="font-weight:600;color:var(--muted2)">#10023</span></div>
              </div>
              <div class="item">
                <div class="k">Produit</div>
                <div class="v">Marge de cr√©dit</div>
              </div>
              <div class="item">
                <div class="k">Montant pr√™t</div>
                <div class="v mono">2 000,00 $</div>
              </div>
              <div class="item">
                <div class="k">Frais ouverture</div>
                <div class="v mono">250,00 $</div>
              </div>
              <div class="item">
                <div class="k">Montant financ√©</div>
                <div class="v mono">2 250,00 $</div>
              </div>
              <div class="item">
                <div class="k">Fr√©quence</div>
                <div class="v">14 jours</div>
              </div>
            </div>

            <div class="kv" style="margin-top:12px">
              <div class="item"><div class="k">Banque (mode)</div><div class="v">PAD / PPA</div></div>
              <div class="item"><div class="k">Statut PAD</div><div class="v"><span class="dot good"></span> Actif</div></div>
              <div class="item"><div class="k">Pr√©f√©rence</div><div class="v">Vendredi</div></div>
              <div class="item"><div class="k">Notes rapides</div><div class="v">‚úÖ Visible ici</div></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Souffrance & √©v√©nements</h2>
              <small>NSF = paiement + 48$ (auto)</small>
            </div>
            <div class="actions">
              <button class="btn danger" onclick="openAction('nsf')">‚ùå NSF</button>
              <button class="btn" onclick="openAction('note')">üìù Ajouter note</button>
            </div>
          </div>

          <div class="section">
            <div class="kv">
              <div class="item">
                <div class="k">Souffrance actuelle</div>
                <div class="v mono" id="rightArrears">0,00 $</div>
              </div>
              <div class="item">
                <div class="k">Prochain pr√©l√®vement</div>
                <div class="v" id="rightNext">15 nov 2024 ¬∑ <span class="mono">147,92 $</span></div>
              </div>
            </div>

            <div class="arrearsBox" id="arrearsList"></div>

            <div class="notes" id="events"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <h3 id="modalTitle">Action</h3>
        <button class="btn" onclick="closeModal()">‚úï Fermer</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

  <script>
    // ===== Utilities
    const money = (n) => (Number(n||0)).toLocaleString('fr-CA',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' $';
    const fmtDate = (iso) => new Date(iso+'T00:00:00').toLocaleDateString('fr-CA',{day:'2-digit',month:'short',year:'numeric'}).replace('.','');
    const clamp2 = (n) => Math.round((Number(n)||0)*100)/100;

    // ===== API (Option A: backend calcule, front affiche)
    const API_BASE = "http://localhost:8080/api";
    const LOAN_ID = "demo";

    async function apiGetLoan(){
      const r = await fetch(`${API_BASE}/loans/${LOAN_ID}`);
      if(!r.ok) throw new Error("GET loan failed");
      return await r.json();
    }
    async function apiReset(){
      const r = await fetch(`${API_BASE}/loans/${LOAN_ID}/reset`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" }
      });
      if(!r.ok) throw new Error("RESET failed");
      return await r.json();
    }
    async function apiNSF(selectedLine, fee){
      const r = await fetch(`${API_BASE}/loans/${LOAN_ID}/actions/nsf`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ selectedLine, fee })
      });
      if(!r.ok) throw new Error("NSF failed");
      return await r.json();
    }
    async function apiResolveArrears(payload){
      const r = await fetch(`${API_BASE}/loans/${LOAN_ID}/actions/arrears/resolve`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(!r.ok) throw new Error("Resolve arrears failed");
      return await r.json();
    }

    // ===== State (vient du backend)
    let state = {
      schedule: [],
      selected: 1,
      arrearsItems: [],
      events: [],
      config: {}
    };

    async function loadLoan(){
      const loan = await apiGetLoan();
      state.schedule = (loan.schedule || []).map(r => ({
        ...r,
        adjustment: Number(r.adjustment||0),
        status: r.status || "√Ä venir",
        paid: Boolean(r.paid),
        method: r.method || "PAD"
      }));
      state.arrearsItems = loan.arrearsItems || [];
      state.events = loan.events || [];
      state.config = loan.config || {};

      // Ajuste s√©lection si elle n‚Äôexiste plus
      if(!state.schedule.find(r=>r.i===state.selected)){
        state.selected = state.schedule?.[0]?.i || 1;
      }
      renderAll();
    }

    async function resetDemo(){
      await apiReset();
      await loadLoan();
    }

    // ===== Helpers UI
    function calcDerived(row){
      const collected = clamp2((row.total||0) + (row.adjustment||0));
      const loanPart = clamp2(Math.max(0, collected - (row.adhesion||0)));
      const capital  = clamp2(row.capital ?? (loanPart - (row.interest||0))); // backend peut fournir row.capital
      return { loanPart, capital, collected };
    }

    function arrearsTotal(){
      return clamp2((state.arrearsItems||[])
        .filter(a => a.status === 'OPEN')
        .reduce((s,a)=> s + (a.total || 0), 0));
    }

    function renderKPI(){
      const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
      const next = ordered.find(r => !r.paid) || ordered[0];
      const aTotal = arrearsTotal();

      const financed = Number(state.config?.startBalance || 0);
      const interestTotal = clamp2(ordered.reduce((s,r)=> s + (r.interest||0), 0));

      const kpis = [
        {label:'Solde contrat', dot:'good', value: money(next?.balance ?? 0), sub:'Solde apr√®s la ligne'},
        {label:'Souffrance', dot: aTotal>0?'bad':'good', value: money(aTotal), sub:'NSF = paiement + 48$'},
        {label:'Montant financ√©', dot:'warn', value: money(financed), sub:'Solde de d√©part (config)'},
        {label:'Int√©r√™t cumulatif', dot:'warn', value: money(interestTotal), sub:'Somme int√©r√™ts (calcul√©)'}
      ];

      document.getElementById('kpi').innerHTML = kpis.map(k=>`
        <div class="card">
          <div class="label"><span>${k.label}</span><span class="dot ${k.dot}"></span></div>
          <div class="value">${k.value}</div>
          <div class="sub">${k.sub}</div>
        </div>
      `).join('');

      document.getElementById('rightArrears').textContent = money(aTotal);
      if(next){
        document.getElementById('rightNext').innerHTML =
          `${fmtDate(next.date)} ¬∑ <span class="mono">${money((next.total||0)+(next.adjustment||0))}</span>`;
      }
    }

    function renderTable(){
      const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
      const tbody = document.getElementById('rows');

      tbody.innerHTML = ordered.map(r=>{
        const sel = r.i===state.selected;
        const {loanPart, capital, collected} = calcDerived(r);

        const statusDot =
          r.status === 'NSF' ? 'bad' :
          r.status === 'Frais report' ? 'warn' :
          (r.paid ? 'good' : 'warn');

        const statusLabel =
          r.status === 'NSF' ? 'NSF' :
          r.status === 'Frais report' ? 'Frais report' :
          (r.paid ? 'Pay√©' : '√Ä venir');

        return `
          <tr onclick="selectRow(${r.i})" style="${sel?'background:rgba(96,165,250,.08)':''}">
            <td class="mono">${r.i}</td>
            <td>${fmtDate(r.date)}</td>
            <td>${r.method||'PAD'}</td>
            <td class="mono">${money(collected)}</td>
            <td class="mono">${money(loanPart)}</td>
            <td class="mono">${money(r.interest||0)}</td>
            <td class="mono">${money(capital)}</td>
            <td class="mono">${money(r.adhesion||0)}</td>
            <td class="mono">${money(r.adjustment||0)}</td>
            <td><span class="status"><span class="dot ${statusDot}"></span>${statusLabel}</span></td>
            <td class="mono">${money(r.balance||0)}</td>
          </tr>
        `;
      }).join('');

      const row = state.schedule.find(r=>r.i===state.selected) || ordered[0];
      if(row){
        document.getElementById('selectedInfo').textContent =
          `S√©lection: #${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Total ${money((row.total||0)+(row.adjustment||0))}`;
      }
    }

    function renderEvents(){
      const items = [...(state.events||[])].slice(-7).reverse();
      document.getElementById('events').innerHTML = items.map(e=>`
        <div class="note">
          <div class="meta">
            <span>${e.title}</span>
            <span class="mono">${new Date(e.ts).toLocaleString('fr-CA',{hour:'2-digit',minute:'2-digit',year:'numeric',month:'2-digit',day:'2-digit'})}</span>
          </div>
          <div class="txt">${e.txt}</div>
        </div>
      `).join('');
    }

    function renderArrearsList(){
      const box = document.getElementById('arrearsList');
      const open = (state.arrearsItems||[])
        .filter(a => a.status === 'OPEN')
        .sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));

      if(!open.length){
        box.innerHTML = `<div style="color:var(--muted2); font-size:12px; padding:6px 4px;">Aucune souffrance ouverte.</div>`;
        return;
      }

      box.innerHTML = open.map(a=>`
        <div class="arrearsRow">
          <div class="arrearsLeft">
            <div class="arrearsTitle">
              <span class="tag"><span class="dot bad"></span> NSF</span>
              &nbsp; Paiement #${a.sourceLine} ¬∑ <span class="mono">${money(a.total)}</span>
            </div>
            <div class="arrearsMeta">
              D√©tail: paiement ${money(a.amount)} + frais ${money(a.fee)} ¬∑ Cr√©√© ${new Date(a.createdAt).toLocaleString('fr-CA',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="openArrearsResolver('${a.id}')">‚ö†Ô∏è Traiter</button>
          </div>
        </div>
      `).join('');
    }

    function renderAll(){
      renderKPI();
      renderTable();
      renderArrearsList();
      renderEvents();
    }

    function selectRow(i){ state.selected=i; renderAll(); }

    function closeModal(ev){
      if(ev && ev.target && ev.target.id !== 'overlay') return;
      document.getElementById('overlay').style.display = 'none';
    }

    // ===== MODAL (report/manual/note/nsf)
    function openAction(kind){
      const row = state.schedule.find(r=>r.i===state.selected) || state.schedule[0];
      const overlay = document.getElementById('overlay');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('modalBody');
      const foot = document.getElementById('modalFoot');

      title.textContent = ({
        report:'üìÖ Reporter un paiement',
        nsf:'‚ùå NSF (banque) ‚Üí Souffrance automatique',
        manual:'üíµ Paiement manuel',
        note:'üìù Ajouter une note'
      })[kind] || 'Action';

      // ===== REPORT (placeholder ‚Äì si tu veux je le branche au backend apr√®s)
      if(kind === 'report'){
        body.innerHTML = `<div class="summary">Reporter est encore en mode d√©mo/placeholder ici. Dis-moi et je le branche au backend comme NSF/Souffrance.</div>`;
        foot.innerHTML = `<button class="btn" onclick="closeModal()">Fermer</button>`;
        overlay.style.display = 'flex';
        return;
      }

      // ===== NSF
      if(kind === 'nsf'){
        body.innerHTML = `
          <div class="row">
            <div class="field">
              <label>Paiement NSF (ligne s√©lectionn√©e dans calendrier)</label>
              <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Total ${money((row.total||0)+(row.adjustment||0))}" />
            </div>
            <div class="field">
              <label>Frais NSF (banque)</label>
              <input id="nsfFee" type="number" step="0.01" value="48.00" />
            </div>
          </div>
          <div class="summary">
            ‚úÖ Auto: Souffrance = paiement + frais NSF.<br/>
            Ensuite tu la traites dans Souffrance avec les m√™mes options que Reporter.
          </div>
        `;
        foot.innerHTML = `
          <button class="btn" onclick="closeModal()">Annuler</button>
          <button class="btn danger" onclick="applyNSF()">Confirmer NSF</button>
        `;
        overlay.style.display = 'flex';
        return;
      }

      // ===== Paiement manuel (local uniquement)
      if(kind === 'manual'){
        body.innerHTML = `
          <div class="row">
            <div class="field">
              <label>Montant re√ßu</label>
              <input id="manualAmt" type="number" step="0.01" value="148.00" />
            </div>
            <div class="field">
              <label>Appliquer √†</label>
              <select id="manualTo">
                <option value="arrears" selected>Souffrance (r√©duire)</option>
                <option value="note">Note seulement</option>
              </select>
            </div>
          </div>
          <div class="summary">
            D√©mo : ‚ÄúSouffrance‚Äù = ferme des items OPEN (FIFO) jusqu‚Äô√† √©puisement du montant.
          </div>
        `;
        foot.innerHTML = `
          <button class="btn" onclick="closeModal()">Annuler</button>
          <button class="btn primary" onclick="applyManual()">Enregistrer</button>
        `;
        overlay.style.display = 'flex';
        return;
      }

      // ===== Note (local uniquement)
      if(kind === 'note'){
        body.innerHTML = `
          <div class="field">
            <label>Note</label>
            <input id="noteTxt" placeholder="Ex: client reporte au prochain vendredi‚Ä¶" />
          </div>
          <div class="summary">Les notes restent dans l‚Äôhistorique (local). Si tu veux, je le branche au backend apr√®s.</div>
        `;
        foot.innerHTML = `
          <button class="btn" onclick="closeModal()">Annuler</button>
          <button class="btn primary" onclick="applyNote()">Ajouter</button>
        `;
        overlay.style.display = 'flex';
        return;
      }
    }

    // ===== NSF (API)
    async function applyNSF(){
      const fee = clamp2(Number(document.getElementById('nsfFee').value || 48));
      const line = state.selected;
      closeModal();
      await apiNSF(line, fee);
      await loadLoan();
    }

    // ===== Resolver Souffrance (API)
    function openArrearsResolver(arrearsId){
      const item = (state.arrearsItems||[]).find(a => a.id === arrearsId && a.status === 'OPEN');
      if(!item) return;

      const overlay = document.getElementById('overlay');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('modalBody');
      const foot = document.getElementById('modalFoot');

      title.textContent = '‚ö†Ô∏è Traiter la souffrance (NSF)';

      const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
      const targets = ordered.filter(r => !r.paid && r.status !== 'NSF' && (r.method||'PAD') === 'PAD');

      const dateOptions = ordered
        .filter(r => !r.paid && r.status !== 'NSF')
        .map(r => `<option value="${r.date}">${fmtDate(r.date)}</option>`)
        .join('');

      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Souffrance NSF (auto)</label>
            <input disabled value="Paiement #${item.sourceLine} : ${money(item.amount)} + ${money(item.fee)} = ${money(item.total)}" />
          </div>
          <div class="field">
            <label>Montant √† r√©partir</label>
            <input id="arrAmt" type="number" step="0.01" value="${clamp2(item.total)}" oninput="validateArrSelection()" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Mode</label>
            <select id="arrPlan" onchange="onArrPlanChange()">
              <option value="SEL" selected>R√©partir sur les lignes coch√©es</option>
              <option value="AUTO_1">Auto: 1 prochain paiement</option>
              <option value="AUTO_2">Auto: 2 prochains paiements</option>
              <option value="AUTO_3">Auto: 3 prochains paiements</option>
              <option value="AUTO_4">Auto: 4 prochains paiements</option>
              <option value="AUTO_5">Auto: 5 prochains paiements</option>
              <option value="ALL">Auto: tous les paiements √† venir</option>
              <option value="NEW">+ Ajouter une ligne (VIREMENT)</option>
            </select>
          </div>
          <div class="field">
            <label>R√®gle</label>
            <input disabled value="Souffrance = paiement NSF + 48$" />
          </div>
        </div>

        <div id="arrPickTargets" style="margin-top:10px">
          <div class="field">
            <label>S√©lectionne les lignes o√π tu ajoutes la souffrance</label>

            <div class="inlineInfo">
              <div id="arrNeed">S√©lection: 0 ligne(s)</div>
              <div class="mono" id="arrPreview">Ajout par ligne: ‚Äî</div>
            </div>

            <div class="listBox">
              ${targets.map(t=>{
                const totalLine = clamp2((t.total||0)+(t.adjustment||0));
                return `
                  <div class="chk">
                    <input type="checkbox" class="arrchk" value="${t.i}" onchange="validateArrSelection()"/>
                    <div>
                      <div class="t"><b>#${t.i}</b> ¬∑ ${fmtDate(t.date)} ¬∑ Total ${money(totalLine)}</div>
                      <div class="m">PAD ¬∑ Ajustement actuel: ${money(t.adjustment||0)}</div>
                    </div>
                  </div>
                `;
              }).join('') || `<div class="m">Aucune ligne PAD disponible.</div>`}
            </div>
          </div>
        </div>

        <div id="arrNewLine" style="margin-top:10px; display:none">
          <div class="row">
            <div class="field">
              <label>Date du virement</label>
              <select id="arrNewDate">${dateOptions}</select>
            </div>
            <div class="field">
              <label>Type</label>
              <input disabled value="VIREMENT (cash √† venir)" />
            </div>
          </div>
        </div>

        <div class="summary">
          Souffrance NSF √† traiter : <b>${money(item.total)}</b>.
        </div>
      `;

      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary disabled" id="arrConfirm" onclick="applyArrearsResolve('${item.id}')">Confirmer</button>
      `;

      overlay.style.display = 'flex';
      setTimeout(()=> onArrPlanChange(), 0);
    }

    function onArrPlanChange(){
      const plan = document.getElementById('arrPlan').value;
      const pick = document.getElementById('arrPickTargets');
      const nl = document.getElementById('arrNewLine');
      const confirm = document.getElementById('arrConfirm');

      document.querySelectorAll('.arrchk').forEach(c => c.checked = false);

      if(plan === 'NEW'){
        pick.style.display = 'none';
        nl.style.display = 'block';
        document.getElementById('arrNeed').textContent = 'Mode: ajout d‚Äôune ligne VIREMENT';
        document.getElementById('arrPreview').textContent = 'Ajout par ligne: ‚Äî';
        confirm.classList.remove('disabled');
        return;
      }

      pick.style.display = 'block';
      nl.style.display = 'none';

      if(plan === 'ALL' || plan.startsWith('AUTO_')){
        const n = plan === 'ALL' ? 9999 : Number(plan.replace('AUTO_',''));
        const boxes = Array.from(document.querySelectorAll('.arrchk')).slice(0, n);
        boxes.forEach(b => b.checked = true);
      }

      validateArrSelection();
    }

    function validateArrSelection(){
      const plan = document.getElementById('arrPlan').value;
      const confirm = document.getElementById('arrConfirm');
      const amt = clamp2(Number(document.getElementById('arrAmt').value || 0));

      if(plan === 'NEW'){
        if(amt > 0) confirm.classList.remove('disabled');
        else confirm.classList.add('disabled');
        return;
      }

      const checked = Array.from(document.querySelectorAll('.arrchk')).filter(x=>x.checked);
      const count = checked.length;

      document.getElementById('arrNeed').textContent = `S√©lection: ${count} ligne(s)`;

      if(count > 0 && amt > 0){
        const per = clamp2(amt / count);
        document.getElementById('arrPreview').textContent = `Ajout par ligne: ${money(per)}`;
        confirm.classList.remove('disabled');
      } else {
        document.getElementById('arrPreview').textContent = 'Ajout par ligne: ‚Äî';
        confirm.classList.add('disabled');
      }
    }

    async function applyArrearsResolve(id){
      const item = (state.arrearsItems||[]).find(a => a.id === id && a.status === 'OPEN');
      if(!item) return;

      const plan = document.getElementById('arrPlan').value;
      const amt = clamp2(Number(document.getElementById('arrAmt').value || item.total));
      if(amt <= 0) return;

      if(plan === 'NEW'){
        const d = document.getElementById('arrNewDate').value;
        closeModal();
        await apiResolveArrears({ arrearsId: id, amount: amt, newDate: d });
        await loadLoan();
        return;
      }

      const ids = Array.from(document.querySelectorAll('.arrchk')).filter(x=>x.checked).map(x=>Number(x.value));
      if(!ids.length) return;

      closeModal();
      await apiResolveArrears({ arrearsId: id, amount: amt, targetIds: ids });
      await loadLoan();
    }

    // ===== Notes / manual (local)
    function logEvent(title, txt){
      state.events = state.events || [];
      state.events.push({ ts:new Date().toISOString(), title, txt });
    }
    function applyNote(){
      const txt = (document.getElementById('noteTxt').value || '').trim();
      if(!txt){ closeModal(); return; }
      logEvent('Note', txt);
      closeModal();
      renderAll();
    }
    function applyManual(){
      const amt = clamp2(Number(document.getElementById('manualAmt').value || 0));
      const to = document.getElementById('manualTo').value;
      if(amt<=0){ closeModal(); return; }

      if(to === 'arrears'){
        let remaining = amt;
        let closed = 0;

        for(const a of state.arrearsItems){
          if(a.status !== 'OPEN') continue;
          if(remaining >= a.total){
            remaining = clamp2(remaining - a.total);
            a.status = 'RESOLVED';
            closed++;
          } else {
            a.total = clamp2(a.total - remaining);
            remaining = 0;
            break;
          }
        }

        logEvent('Paiement manuel', `Paiement ${money(amt)} appliqu√© √† la souffrance. Items ferm√©s: ${closed}. Reste: ${money(remaining)}.`);
      } else {
        logEvent('Paiement manuel', `Paiement re√ßu ${money(amt)} (note seulement).`);
      }

      closeModal();
      renderAll();
    }

    // expose for inline handlers
    window.openAction = openAction;
    window.resetDemo = resetDemo;
    window.closeModal = closeModal;
    window.selectRow = selectRow;

    window.openArrearsResolver = openArrearsResolver;
    window.onArrPlanChange = onArrPlanChange;
    window.validateArrSelection = validateArrSelection;
    window.applyArrearsResolve = applyArrearsResolve;

    // ===== Init
    loadLoan().catch(err => {
      console.error(err);
      alert("Impossible de joindre le backend. D√©marre server/index.js sur le port 8080.");
    });
  </script>
</body>
</html>
