<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard pr√™teur priv√© ‚Äî MAX Margill-like</title>
  <style>
    :root{
      --bg:#0b1220;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r:16px;
      --r2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(45,212,191,.18), transparent 55%),
        radial-gradient(900px 650px at 60% 120%, rgba(251,113,133,.14), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1250px;margin:0 auto;padding:20px}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;margin:8px 0 16px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(96,165,250,.9), rgba(45,212,191,.75));
      box-shadow:0 12px 30px rgba(96,165,250,.20);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:18px;margin:0;line-height:1.2}
    .brand p{margin:0;color:var(--muted2);font-size:12px}

    .search{
      flex:1;max-width:560px;margin:0 14px;
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
    }
    .search input{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-size:14px}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}

    .grid{display:grid;grid-template-columns: 1.25fr 0.75fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .search{display:none} }

    /* KPIs */
    .cards{display:grid;grid-template-columns: repeat(6, 1fr);gap:12px;margin-bottom:14px;}
    @media (max-width: 1200px){ .cards{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 700px){ .cards{grid-template-columns: repeat(2, 1fr)} }

    .card{
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      padding:12px 12px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .card .label{color:var(--muted2);font-size:12px;display:flex;justify-content:space-between;gap:10px}
    .card .value{font-size:18px;margin-top:8px;font-weight:700;letter-spacing:.2px}
    .card .sub{margin-top:8px;color:var(--muted);font-size:12px}

    .panel{
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .panelHeader h2{margin:0;font-size:14px}
    .panelHeader small{color:var(--muted2)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      color:var(--text);
      padding:9px 10px;
      border-radius:14px;
      font-size:12px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, opacity .12s ease;
      display:flex;align-items:center;gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color:rgba(96,165,250,.45); background:rgba(96,165,250,.16)}
    .btn.danger{border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.14)}
    .btn.good{border-color:rgba(45,212,191,.45); background:rgba(45,212,191,.12)}
    .btn.warn{border-color:rgba(251,191,36,.45); background:rgba(251,191,36,.12)}
    .btn.ghost{background:transparent}
    .btn.disabled{opacity:.45; pointer-events:none;}

    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px;}
    th, td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;white-space:nowrap;}
    th{
      position:sticky;top:0;z-index:2;
      background:rgba(10,18,32,.85);
      backdrop-filter: blur(12px);
      color:var(--muted);
      font-weight:600;
    }
    tr:hover td{background:rgba(255,255,255,.04)}
    .status{
      padding:5px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;
      display:inline-flex;align-items:center;gap:8px;
      color:var(--muted);
    }
    .rightCol{display:flex;flex-direction:column;gap:14px;}
    .section{padding:14px;}
    .kv{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:10px;}
    .kv .item{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .kv .k{color:var(--muted2);font-size:11px}
    .kv .v{margin-top:6px;font-weight:700}
    .mono{font-family:var(--mono)}

    .notes{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .note{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .note .meta{color:var(--muted2);font-size:11px;display:flex;justify-content:space-between}
    .note .txt{margin-top:6px;color:var(--text);font-size:12.5px}

    .footerBar{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      color:var(--muted2);
      font-size:12px;
    }
    .hint{color:var(--muted2); font-size:12px; padding:10px 14px 0;}

    /* Souffrance list */
    .arrearsBox{
      margin-top:12px;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      max-height:240px;
      overflow:auto;
    }
    .arrearsRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      margin-bottom:8px;
    }
    .arrearsRow:hover{background:rgba(255,255,255,.05)}
    .arrearsLeft{display:flex;flex-direction:column;gap:4px;min-width:0}
    .arrearsTitle{font-size:12.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .arrearsMeta{font-size:11px;color:var(--muted2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;color:var(--muted);
    }

    /* Ledger */
    .ledgerBox{
      margin-top:12px;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      max-height:260px;
      overflow:auto;
    }
    .ledgerRow{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      margin-bottom:8px;
    }
    .ledgerRow:hover{background:rgba(255,255,255,.05)}
    .ledgerLeft{min-width:0;display:flex;flex-direction:column;gap:4px}
    .ledgerTitle{font-size:12.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ledgerMeta{font-size:11px;color:var(--muted2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Modal */
    .modalOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(900px, 100%);
      background:rgba(16,31,59,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius:22px;
      box-shadow:0 30px 100px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .modalHead h3{margin:0;font-size:14px}
    .modalBody{padding:14px}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width: 640px){ .row{grid-template-columns:1fr} }
    .field{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .field label{display:block;color:var(--muted2);font-size:11px;margin-bottom:8px}
    .field input, .field select{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    .summary{
      margin-top:12px;
      padding:12px;border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12.5px;
      line-height:1.45;
    }
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
    }

    .inlineInfo{
      margin-top:10px;
      color:var(--muted2);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Dashboard pr√™teur priv√©</h1>
          <p>MAX Margill-like ¬∑ Encaissement r√©el ¬∑ Allocation ¬∑ Ledger</p>
        </div>
      </div>

      <div class="search" title="Recherche (mock)">
        üîé <input placeholder="Rechercher un client, un contrat, une date‚Ä¶" />
        <span class="pill"><span class="dot good"></span> Live: API</span>
      </div>

      <div class="pill" title="Mode"><span class="dot warn"></span> Mode: D√©mo</div>
    </div>

    <div class="cards" id="kpi"></div>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Calendrier des paiements</h2>
              <small id="subHeader">Planifi√© vs Encaiss√© ¬∑ Banque ¬∑ Solde avant/apr√®s ¬∑ ACT/365</small>
            </div>
            <div class="actions">
              <button class="btn danger" onclick="openAction('nsf')">‚ùå NSF</button>
              <button class="btn good" onclick="openAction('post')">‚úÖ Pay√©</button>
              <button class="btn warn" onclick="openAction('partial')">üü® Partiel</button>
              <button class="btn" onclick="openAction('retry')">üîÅ Reprise NSF</button>
              <button class="btn ghost" onclick="resetDemo()">‚Ü©Ô∏è Reset</button>
            </div>
          </div>

          <div class="hint">
            üí° Margill-like : le paiement encaiss√© est appliqu√© <b>Souffrance ‚Üí Adh√©sion ‚Üí Int√©r√™t ‚Üí Capital</b>.
            Le <b>Total d√ª</b> = <b>Solde pr√™t</b> + <b>Souffrance ouverte</b>.
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Date pr√©vue</th>
                  <th>Date encaiss√©e</th>
                  <th>Statut banque</th>
                  <th>Type</th>
                  <th>Planifi√©</th>
                  <th>Encaiss√©</th>
                  <th>Int√©r√™t</th>
                  <th>Capital</th>
                  <th>Adh√©sion</th>
                  <th>Ajust.</th>
                  <th>Solde avant</th>
                  <th>Solde apr√®s</th>
                  <th>Jours</th>
                  <th>Statut ligne</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div class="footerBar">
            <div id="ruleLine">ACT/365 ¬∑ int√©r√™t sur solde avant ¬∑ encaissement r√©el (POSTED/PARTIAL/NSF)</div>
            <div class="mono" id="selectedInfo">S√©lection: #1</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="rightCol">
        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>R√©sum√© contrat</h2>
              <small>Solde / Souffrance / Total d√ª</small>
            </div>
            <div class="pill"><span class="dot good"></span> Actif</div>
          </div>
          <div class="section">
            <div class="kv" id="contractBox"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Souffrance & √©v√©nements</h2>
              <small>OPEN = d√ª maintenant</small>
            </div>
            <div class="pill"><span class="dot warn"></span> Audit</div>
          </div>

          <div class="section">
            <div class="kv">
              <div class="item">
                <div class="k">Souffrance ouverte</div>
                <div class="v mono" id="rightArrears">0,00 $</div>
              </div>
              <div class="item">
                <div class="k">Total d√ª</div>
                <div class="v mono" id="rightTotalDue">0,00 $</div>
              </div>
            </div>

            <div class="arrearsBox" id="arrearsList"></div>

            <div class="ledgerBox" id="ledgerList"></div>

            <div class="notes" id="events"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <h3 id="modalTitle">Action</h3>
        <button class="btn" onclick="closeModal()">‚úï Fermer</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

<script>
  // ===== Utilities
  const money = (n) => (Number(n||0)).toLocaleString('fr-CA',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' $';
  const fmtDate = (iso) => {
    if(!iso) return "‚Äî";
    return new Date(iso+'T00:00:00').toLocaleDateString('fr-CA',{day:'2-digit',month:'short',year:'numeric'}).replace('.','');
  };
  const clamp2 = (n) => Math.round((Number(n)||0)*100)/100;

  // ===== API
  const API_BASE = "http://localhost:8080/api";
  const LOAN_ID = "demo";

  async function apiGetLoan(){
    const r = await fetch(`${API_BASE}/loans/${LOAN_ID}`);
    if(!r.ok) throw new Error("GET loan failed");
    return await r.json();
  }
  async function apiReset(){
    const r = await fetch(`${API_BASE}/loans/${LOAN_ID}/reset`, {
      method:"POST", headers:{ "Content-Type":"application/json" }
    });
    if(!r.ok) throw new Error("RESET failed");
    return await r.json();
  }
  async function apiNSF(selectedLine, fee){
    const r = await fetch(`${API_BASE}/loans/${LOAN_ID}/actions/nsf`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ selectedLine, fee })
    });
    if(!r.ok) throw new Error("NSF failed");
    return await r.json();
  }
  async function apiPost(payload){
    const r = await fetch(`${API_BASE}/loans/${LOAN_ID}/actions/post`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error("POST failed");
    return await r.json();
  }
  async function apiRetry(payload){
    const r = await fetch(`${API_BASE}/loans/${LOAN_ID}/actions/retry`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error("RETRY failed");
    return await r.json();
  }

  // ===== State
  let state = {
    schedule: [],
    selected: 1,
    arrearsItems: [],
    events: [],
    config: {},
    ledger: []
  };

  function openArrearsTotal(){
    return clamp2((state.arrearsItems||[])
      .filter(a => a.status === "OPEN")
      .reduce((s,a)=> s + (a.total||0), 0));
  }

  function nextRow(){
    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
    // prochain "non pay√©"
    return ordered.find(r => !r.paid && (r.postedStatus||"NONE")==="NONE") || ordered[0];
  }

  async function loadLoan(){
    const loan = await apiGetLoan();
    state.schedule = (loan.schedule || []).map(r => ({ ...r }));
    state.arrearsItems = loan.arrearsItems || [];
    state.events = loan.events || [];
    state.config = loan.config || {};
    state.ledger = loan.ledger || [];

    if(!state.schedule.find(r=>r.i===state.selected)){
      state.selected = state.schedule?.[0]?.i || 1;
    }
    renderAll();
  }

  async function resetDemo(){
    await apiReset();
    await loadLoan();
  }

  // ===== Render
  function renderKPI(){
    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
    const next = nextRow();
    const arrears = openArrearsTotal();

    const balance = Number(next?.balance ?? 0);
    const totalDue = clamp2(balance + arrears);

    const financed = Number(state.config?.startBalance || 0);
    const interestCum = clamp2(ordered.reduce((s,r)=> s + (r.interest||0), 0));
    const capitalCum  = clamp2(ordered.reduce((s,r)=> s + (r.capital||0), 0));
    const collectedCum = clamp2(ordered.reduce((s,r)=> s + (r.collected||0), 0));

    const payArFirst = Boolean(state.config?.payArrearsFirst ?? true);

    const kpis = [
      {label:'Solde pr√™t', dot:'good', value: money(balance), sub:'Capital restant (sans souffrance)'},
      {label:'Souffrance', dot: arrears>0?'bad':'good', value: money(arrears), sub:'OPEN (NSF, frais, etc.)'},
      {label:'Total d√ª', dot: arrears>0?'bad':'good', value: money(totalDue), sub:'Solde pr√™t + souffrance'},
      {label:'Montant financ√©', dot:'warn', value: money(financed), sub:'Config startBalance'},
      {label:'Int√©r√™t cumul√©', dot:'warn', value: money(interestCum), sub:`Capital cumul√©: ${money(capitalCum)}`},
      {label:'Encaiss√© cumul√©', dot:'good', value: money(collectedCum), sub:`Souffrance prioritaire: ${payArFirst?'Oui':'Non'}`},
    ];

    document.getElementById('kpi').innerHTML = kpis.map(k=>`
      <div class="card">
        <div class="label"><span>${k.label}</span><span class="dot ${k.dot}"></span></div>
        <div class="value">${k.value}</div>
        <div class="sub">${k.sub}</div>
      </div>
    `).join('');

    document.getElementById('rightArrears').textContent = money(arrears);
    document.getElementById('rightTotalDue').textContent = money(totalDue);
  }

  function renderContractBox(){
    const cfg = state.config || {};
    const next = nextRow();
    const arrears = openArrearsTotal();
    const totalDue = clamp2(Number(next?.balance||0) + arrears);

    const html = `
      <div class="item">
        <div class="k">Client</div>
        <div class="v">Marc Savoie <span class="mono" style="font-weight:600;color:var(--muted2)">#10023</span></div>
      </div>
      <div class="item">
        <div class="k">Taux nominal</div>
        <div class="v mono">${((Number(cfg.annualRate||0)*100).toFixed(2))}% ¬∑ ACT/${cfg.dayBase||365}</div>
      </div>
      <div class="item">
        <div class="k">Date d'origine</div>
        <div class="v mono">${cfg.contractStartDate || "‚Äî"}</div>
      </div>
      <div class="item">
        <div class="k">Souffrance prioritaire</div>
        <div class="v">${(cfg.payArrearsFirst ?? true) ? "Oui" : "Non"}</div>
      </div>
      <div class="item">
        <div class="k">Montant financ√©</div>
        <div class="v mono">${money(cfg.startBalance||0)}</div>
      </div>
      <div class="item">
        <div class="k">Total d√ª</div>
        <div class="v mono">${money(totalDue)}</div>
      </div>
    `;
    document.getElementById('contractBox').innerHTML = html;
  }

  function renderTable(){
    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i-b.i));
    const tbody = document.getElementById('rows');

    tbody.innerHTML = ordered.map(r=>{
      const sel = r.i===state.selected;

      const bank = (r.postedStatus || "NONE");
      const bankDot =
        bank === "NSF" ? "bad" :
        bank === "POSTED" ? "good" :
        bank === "PARTIAL" ? "warn" : "warn";

      const lineStatus =
        r.status === "NSF" ? "NSF" :
        r.status === "Pay√©" ? "Pay√©" :
        r.status === "Partiel" ? "Partiel" :
        (r.status || "√Ä venir");

      const lineDot =
        r.status === "NSF" ? "bad" :
        r.status === "Pay√©" ? "good" :
        r.status === "Partiel" ? "warn" : "warn";

      return `
        <tr onclick="selectRow(${r.i})" style="${sel?'background:rgba(96,165,250,.08)':''}">
          <td class="mono">${r.i}</td>
          <td>${fmtDate(r.date)}</td>
          <td>${fmtDate(r.postedDate)}</td>
          <td><span class="status"><span class="dot ${bankDot}"></span>${bank}</span></td>
          <td>${r.method||'PAD'}</td>
          <td class="mono">${money(r.planned||0)}</td>
          <td class="mono">${money(r.collected||0)}</td>
          <td class="mono">${money(r.interest||0)}</td>
          <td class="mono">${money(r.capital||0)}</td>
          <td class="mono">${money(r.adhesion||0)}</td>
          <td class="mono">${money(r.adjustment||0)}</td>
          <td class="mono">${money(r.balanceBefore||0)}</td>
          <td class="mono">${money(r.balance||0)}</td>
          <td class="mono">${r.days ?? 0}</td>
          <td><span class="status"><span class="dot ${lineDot}"></span>${lineStatus}</span></td>
        </tr>
      `;
    }).join('');

    const row = state.schedule.find(r=>r.i===state.selected) || ordered[0];
    if(row){
      document.getElementById('selectedInfo').textContent =
        `S√©lection: #${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Planifi√© ${money(row.planned||0)} ¬∑ Banque ${row.postedStatus||"NONE"} ¬∑ Encaiss√© ${money(row.collected||0)}`;
    }
  }

  function renderArrearsList(){
    const box = document.getElementById('arrearsList');
    const open = (state.arrearsItems||[])
      .filter(a => a.status === 'OPEN')
      .sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));

    if(!open.length){
      box.innerHTML = `<div style="color:var(--muted2); font-size:12px; padding:6px 4px;">Aucune souffrance ouverte.</div>`;
      return;
    }

    box.innerHTML = open.map(a=>`
      <div class="arrearsRow">
        <div class="arrearsLeft">
          <div class="arrearsTitle">
            <span class="tag"><span class="dot bad"></span> ${a.type || "NSF"}</span>
            &nbsp; Source #${a.sourceLine} ¬∑ <span class="mono">${money(a.total)}</span>
          </div>
          <div class="arrearsMeta">
            D√©tail: rejet ${money(a.amount)} + frais ${money(a.fee)} ¬∑ Cr√©√© ${new Date(a.createdAt).toLocaleString('fr-CA',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderLedger(){
    const box = document.getElementById('ledgerList');
    const rows = [...(state.ledger||[])].slice(-10).reverse();

    if(!rows.length){
      box.innerHTML = `<div style="color:var(--muted2); font-size:12px; padding:6px 4px;">Ledger vide (aucun encaissement post√©).</div>`;
      return;
    }

    box.innerHTML = rows.map(l=>{
      const s = l.split || {};
      return `
        <div class="ledgerRow">
          <div class="ledgerLeft">
            <div class="ledgerTitle">
              <span class="tag"><span class="dot good"></span> POST</span>
              &nbsp; Ligne #${l.line} ¬∑ ${money(l.amount)} ¬∑ <span class="mono">${l.postedDate || "‚Äî"}</span>
            </div>
            <div class="ledgerMeta">
              Split: souffrance ${money(s.arrears||0)} ¬∑ adh√©sion ${money(s.adhesion||0)} ¬∑ int√©r√™t ${money(s.interest||0)} ¬∑ capital ${money(s.principal||0)}
            </div>
          </div>
          <div class="mono" style="align-self:center;color:var(--muted2)">
            ${new Date(l.ts).toLocaleString('fr-CA',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}
          </div>
        </div>
      `;
    }).join('');
  }

  function renderEvents(){
    const items = [...(state.events||[])].slice(-8).reverse();
    document.getElementById('events').innerHTML = items.map(e=>`
      <div class="note">
        <div class="meta">
          <span>${e.title}</span>
          <span class="mono">${new Date(e.ts).toLocaleString('fr-CA',{hour:'2-digit',minute:'2-digit',year:'numeric',month:'2-digit',day:'2-digit'})}</span>
        </div>
        <div class="txt">${e.txt}</div>
      </div>
    `).join('');
  }

  function renderAll(){
    renderKPI();
    renderContractBox();
    renderTable();
    renderArrearsList();
    renderLedger();
    renderEvents();
  }

  function selectRow(i){ state.selected=i; renderAll(); }

  // ===== Modal
  function closeModal(ev){
    if(ev && ev.target && ev.target.id !== 'overlay') return;
    document.getElementById('overlay').style.display = 'none';
  }

  function openAction(kind){
    const row = state.schedule.find(r=>r.i===state.selected) || state.schedule[0];
    const overlay = document.getElementById('overlay');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    const foot = document.getElementById('modalFoot');

    // ===== NSF
    if(kind === "nsf"){
      title.textContent = "‚ùå NSF (banque) ‚Üí Souffrance OPEN";
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne</label>
            <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Planifi√© ${money(row.planned||0)}" />
          </div>
          <div class="field">
            <label>Frais NSF</label>
            <input id="nsfFee" type="number" step="0.01" value="${Number(state.config?.defaultNSFFee||48).toFixed(2)}" />
          </div>
        </div>
        <div class="summary">
          NSF = encaissement r√©el = 0, et cr√©ation d‚Äôune souffrance OPEN = (montant rejet√© + frais NSF).
          Le solde pr√™t ne baisse pas tant que non encaiss√©.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn danger" onclick="applyNSF()">Confirmer NSF</button>
      `;
      overlay.style.display = "flex";
      return;
    }

    // ===== PAY√â
    if(kind === "post"){
      title.textContent = "‚úÖ Encaiss√© (PAY√â) ‚Äî posted r√©el";
      const suggested = clamp2(row.planned || ((row.total||0)+(row.adjustment||0)));
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne</label>
            <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Planifi√© ${money(row.planned||0)} ¬∑ Banque ${row.postedStatus||"NONE"}" />
          </div>
          <div class="field">
            <label>Montant encaiss√© (r√©el)</label>
            <input id="postAmt" type="number" step="0.01" value="${Number(suggested).toFixed(2)}" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Date encaiss√©e (r√©elle)</label>
            <input id="postDate" type="date" value="${(row.date||"").slice(0,10)}" />
          </div>
          <div class="field">
            <label>Souffrance prioritaire ? (Margill-like)</label>
            <select id="payArFirst">
              <option value="true" ${(state.config?.payArrearsFirst ?? true) ? "selected" : ""}>Oui (souffrance ‚Üí adh√©sion ‚Üí int√©r√™t ‚Üí capital)</option>
              <option value="false" ${!(state.config?.payArrearsFirst ?? true) ? "selected" : ""}>Non (souffrance s√©par√©e)</option>
            </select>
          </div>
        </div>

        <div class="summary">
          Ce bouton enregistre l‚Äôencaissement r√©el et √©crit dans le Ledger (audit).
          L‚Äôallocation se fait automatiquement.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn good" onclick="applyPost(false)">Confirmer PAY√â</button>
      `;
      overlay.style.display = "flex";
      return;
    }

    // ===== PARTIEL
    if(kind === "partial"){
      title.textContent = "üü® Encaiss√© partiel ‚Äî posted r√©el";
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne</label>
            <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Planifi√© ${money(row.planned||0)}" />
          </div>
          <div class="field">
            <label>Montant encaiss√© (partiel)</label>
            <input id="postAmt" type="number" step="0.01" value="${Number(Math.max(0, (row.planned||0) - 40)).toFixed(2)}" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Date encaiss√©e (r√©elle)</label>
            <input id="postDate" type="date" value="${(row.date||"").slice(0,10)}" />
          </div>
          <div class="field">
            <label>Souffrance prioritaire ?</label>
            <select id="payArFirst">
              <option value="true" ${(state.config?.payArrearsFirst ?? true) ? "selected" : ""}>Oui</option>
              <option value="false" ${!(state.config?.payArrearsFirst ?? true) ? "selected" : ""}>Non</option>
            </select>
          </div>
        </div>

        <div class="summary">
          Un paiement partiel peut laisser de l‚Äôint√©r√™t impay√© et r√©duire le capital plus lentement.
          Tout est visible dans les colonnes et le Ledger.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn warn" onclick="applyPost(true)">Confirmer PARTIEL</button>
      `;
      overlay.style.display = "flex";
      return;
    }

    // ===== REPRISE NSF
    if(kind === "retry"){
      title.textContent = "üîÅ Reprise bancaire (NSF ‚Üí replanifier)";
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne</label>
            <input disabled value="#${row.i} ¬∑ Statut banque ${row.postedStatus||"NONE"} ¬∑ Statut ligne ${row.status||"‚Äî"}" />
          </div>
          <div class="field">
            <label>Nouvelle date pr√©vue</label>
            <input id="retryDate" type="date" value="${(row.date||"").slice(0,10)}" />
          </div>
        </div>
        <div class="summary">
          Reprise = on remet la ligne ‚Äú√Ä venir‚Äù (banque NONE) avec une nouvelle date.
          Les jours et int√©r√™ts se recalculent ensuite selon la vraie date d‚Äôencaissement quand tu feras PAY√â/PARTIEL.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="applyRetry()">Confirmer reprise</button>
      `;
      overlay.style.display = "flex";
      return;
    }
  }

  // ===== Apply actions
  async function applyNSF(){
    const fee = clamp2(Number(document.getElementById("nsfFee").value || 48));
    const line = state.selected;
    closeModal();
    await apiNSF(line, fee);
    await loadLoan();
  }

  async function applyPost(isPartial){
    const amt = clamp2(Number(document.getElementById("postAmt").value || 0));
    const d = document.getElementById("postDate").value;
    const payArFirst = (document.getElementById("payArFirst").value === "true");

    if(amt <= 0){
      alert("Montant invalide.");
      return;
    }
    closeModal();
    await apiPost({
      lineId: state.selected,
      amount: amt,
      postedDate: d,
      applyToArrearsFirst: payArFirst
    });
    await loadLoan();
  }

  async function applyRetry(){
    const d = document.getElementById("retryDate").value;
    closeModal();
    await apiRetry({ lineId: state.selected, newDate: d });
    await loadLoan();
  }

  // expose
  window.openAction = openAction;
  window.resetDemo = resetDemo;
  window.closeModal = closeModal;
  window.selectRow = selectRow;

  // init
  loadLoan().catch(err => {
    console.error(err);
    alert("Impossible de joindre le backend. Lance node server/index.js sur le port 8080.");
  });
</script>
</body>
</html>
