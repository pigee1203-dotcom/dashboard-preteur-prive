<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard pr√™teur priv√©</title>
  <style>
    :root{
      --bg:#0b1220;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.52);
      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --r:18px;
      --r2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(45,212,191,.18), transparent 55%),
        radial-gradient(900px 650px at 60% 120%, rgba(251,113,133,.14), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin:6px 0 14px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(96,165,250,.9), rgba(45,212,191,.75));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 12px 30px rgba(96,165,250,.20);
    }
    h1{font-size:18px;margin:0}
    .sub{margin:2px 0 0;color:var(--muted2);font-size:12px}
    .search{
      flex:1;max-width:520px;margin:0 12px;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
    }
    .search input{width:100%;background:transparent;border:0;outline:0;color:var(--text);font-size:14px}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .cards{
      display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;
    }
    @media (max-width:980px){.search{display:none}.cards{grid-template-columns:repeat(2,1fr)}}
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius:var(--r2);
      padding:12px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .card .k{color:var(--muted2);font-size:12px;display:flex;justify-content:space-between}
    .card .v{font-weight:800;font-size:18px;margin-top:8px}
    .card .s{color:var(--muted);font-size:12px;margin-top:6px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .ph{
      padding:14px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .ph h2{margin:0;font-size:14px}
    .ph small{color:var(--muted2)}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      color:var(--text);
      padding:9px 10px;border-radius:14px;
      font-size:12px;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{border-color:rgba(96,165,250,.45); background:rgba(96,165,250,.16)}
    .btn.danger{border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.14)}
    .btn.good{border-color:rgba(45,212,191,.45); background:rgba(45,212,191,.12)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .hint{padding:10px 14px 0;color:var(--muted2);font-size:12px}
    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);white-space:nowrap;text-align:left}
    th{
      position:sticky;top:0;z-index:2;
      background:rgba(10,18,32,.85);
      backdrop-filter: blur(12px);
      color:var(--muted);
      font-weight:700;
    }
    tr:hover td{background:rgba(255,255,255,.04)}
    .status{
      padding:5px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;display:inline-flex;align-items:center;gap:8px;color:var(--muted);
    }
    .mono{font-family:var(--mono)}
    .footer{
      padding:12px 14px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      border-top:1px solid rgba(255,255,255,.08);
      color:var(--muted2);font-size:12px;
    }
    .right{display:flex;flex-direction:column;gap:12px}
    .sec{padding:14px}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kv .box{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .k{color:var(--muted2);font-size:11px}
    .v{margin-top:6px;font-weight:800}
    .events{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .ev{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .ev .m{color:var(--muted2);font-size:11px;display:flex;justify-content:space-between}
    .ev .t{margin-top:6px;font-size:12.5px}
    /* modal */
    .ov{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{
      width:min(640px,100%);
      background:rgba(16,31,59,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius:22px;
      box-shadow:0 30px 100px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .mh{padding:14px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;justify-content:space-between;align-items:center}
    .mh h3{margin:0;font-size:14px}
    .mb{padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    .field{padding:10px;border-radius:16px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10)}
    .field label{display:block;color:var(--muted2);font-size:11px;margin-bottom:8px}
    .field input,.field select{
      width:100%;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);padding:10px;border-radius:12px;outline:none;font-size:13px
    }
    .sum{margin-top:12px;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);color:var(--muted);font-size:12.5px;line-height:1.45}
    .mf{padding:12px 14px;border-top:1px solid rgba(255,255,255,.10);display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Dashboard pr√™teur priv√©</h1>
          <div class="sub">Client ¬∑ Contrat ¬∑ Calendrier ¬∑ Souffrance ‚Äî simple et clair</div>
        </div>
      </div>

      <div class="search" title="Recherche (d√©mo)">
        üîé <input placeholder="Rechercher un client, un contrat, une date‚Ä¶" />
        <span class="pill"><span class="dot good"></span> D√©mo</span>
      </div>

      <div class="pill"><span class="dot warn"></span> Mode: D√©mo</div>
    </div>

    <div class="cards" id="kpi"></div>

    <div class="grid">
      <div class="panel">
        <div class="ph">
          <div>
            <h2>Calendrier des paiements</h2>
            <small>26 paiements ¬∑ 14 jours ¬∑ Adh√©sion 45,00$</small>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="openAction('report')">üìÖ Reporter</button>
            <button class="btn danger" onclick="openAction('nsf')">‚ùå NSF</button>
            <button class="btn good" onclick="openAction('split')">‚ûó R√©partir</button>
            <button class="btn" onclick="openAction('manual')">üíµ Paiement manuel</button>
            <button class="btn" onclick="resetDemo()">‚Ü©Ô∏è Reset</button>
          </div>
        </div>

        <div class="hint">Clique une ligne pour la s√©lectionner. (D√©mo: m√™mes chiffres que Margill, actions en surcouche.)</div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Date</th><th>Total</th><th>Pr√™t</th><th>Int√©r√™t</th><th>Capital</th>
                <th>Adh√©sion</th><th>Ajustement</th><th>Statut</th><th>Solde apr√®s</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div class="footer">
          <div>R√®gles: seulement <b>7</b> ou <b>14</b> jours ¬∑ Adh√©sion toujours due ¬∑ Taux <span class="mono">18.99%</span></div>
          <div class="mono" id="sel">S√©lection: #1</div>
        </div>
      </div>

      <div class="right">
        <div class="panel">
          <div class="ph">
            <div>
              <h2>Fiche client</h2>
              <small>Tout en 1 page</small>
            </div>
            <div class="pill"><span class="dot good"></span> Actif</div>
          </div>
          <div class="sec">
            <div class="kv">
              <div class="box"><div class="k">Client</div><div class="v">Marc Savoie <span class="mono" style="font-weight:600;color:var(--muted2)">#10023</span></div></div>
              <div class="box"><div class="k">Produit</div><div class="v">Marge de cr√©dit</div></div>
              <div class="box"><div class="k">Montant pr√™t</div><div class="v mono">2 000,00 $</div></div>
              <div class="box"><div class="k">Frais ouverture</div><div class="v mono">250,00 $</div></div>
              <div class="box"><div class="k">Montant financ√©</div><div class="v mono">2 250,00 $</div></div>
              <div class="box"><div class="k">Fr√©quence</div><div class="v">14 jours</div></div>
            </div>
            <div class="kv" style="margin-top:12px">
              <div class="box"><div class="k">Banque (mode)</div><div class="v">PAD / PPA</div></div>
              <div class="box"><div class="k">Statut PAD</div><div class="v"><span class="dot good"></span> Actif</div></div>
              <div class="box"><div class="k">Pr√©f√©rence</div><div class="v">Vendredi</div></div>
              <div class="box"><div class="k">Notes</div><div class="v">‚úÖ Direct ici</div></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="ph">
            <div>
              <h2>Souffrance & √©v√©nements</h2>
              <small>Audit clair</small>
            </div>
            <button class="btn" onclick="openAction('note')">üìù Ajouter note</button>
          </div>
          <div class="sec">
            <div class="kv">
              <div class="box"><div class="k">Souffrance actuelle</div><div class="v mono" id="arrears">0,00 $</div></div>
              <div class="box"><div class="k">Prochain pr√©l√®vement</div><div class="v" id="next">15 nov 2024 ¬∑ <span class="mono">147,92 $</span></div></div>
            </div>
            <div class="events" id="events"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="ov" id="ov" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mh">
        <h3 id="mt">Action</h3>
        <button class="btn" onclick="closeModal()">‚úï Fermer</button>
      </div>
      <div class="mb" id="mb"></div>
      <div class="mf" id="mf"></div>
    </div>
  </div>

<script>
  const money = (n)=> (Number(n||0)).toLocaleString('fr-CA',{minimumFractionDigits:2,maximumFractionDigits:2})+' $';
  const fmtDate=(iso)=> new Date(iso+'T00:00:00').toLocaleDateString('fr-CA',{day:'2-digit',month:'short',year:'numeric'}).replace('.','');
  const clamp2=(n)=>Math.round((Number(n||0))*100)/100;

  const original = [
    {i:1,  date:'2024-11-15', total:147.92, interest: 9.62, adhesion:45.00, balance:2156.70},
    {i:2,  date:'2024-11-29', total:147.19, interest:16.15, adhesion:45.00, balance:2070.66},
    {i:3,  date:'2024-12-13', total:146.56, interest:15.51, adhesion:45.00, balance:1984.61},
    {i:4,  date:'2024-12-27', total:145.94, interest:14.87, adhesion:45.00, balance:1898.54},
    {i:5,  date:'2025-01-10', total:145.31, interest:14.22, adhesion:45.00, balance:1812.45},
    {i:6,  date:'2025-01-24', total:144.72, interest:13.61, adhesion:45.00, balance:1726.34},
    {i:7,  date:'2025-02-07', total:144.09, interest:12.97, adhesion:45.00, balance:1640.22},
    {i:8,  date:'2025-02-21', total:143.47, interest:12.32, adhesion:45.00, balance:1554.07},
    {i:9,  date:'2025-03-07', total:142.84, interest:11.67, adhesion:45.00, balance:1467.90},
    {i:10, date:'2025-03-21', total:142.21, interest:11.03, adhesion:45.00, balance:1381.72},
    {i:11, date:'2025-04-04', total:141.58, interest:10.38, adhesion:45.00, balance:1295.52},
    {i:12, date:'2025-04-18', total:140.95, interest: 9.73, adhesion:45.00, balance:1209.30},
    {i:13, date:'2025-05-02', total:140.33, interest: 9.08, adhesion:45.00, balance:1123.05},
    {i:14, date:'2025-05-16', total:139.70, interest: 8.44, adhesion:45.00, balance:1036.79},
    {i:15, date:'2025-05-30', total:139.07, interest: 7.79, adhesion:45.00, balance: 950.51},
    {i:16, date:'2025-06-13', total:138.44, interest: 7.14, adhesion:45.00, balance: 864.21},
    {i:17, date:'2025-06-27', total:137.82, interest: 6.49, adhesion:45.00, balance: 777.88},
    {i:18, date:'2025-07-11', total:137.19, interest: 5.84, adhesion:45.00, balance: 691.53},
    {i:19, date:'2025-07-25', total:136.56, interest: 5.19, adhesion:45.00, balance: 605.16},
    {i:20, date:'2025-08-08', total:135.93, interest: 4.55, adhesion:45.00, balance: 518.78},
    {i:21, date:'2025-08-22', total:135.31, interest: 3.90, adhesion:45.00, balance: 432.37},
    {i:22, date:'2025-09-05', total:134.68, interest: 3.25, adhesion:45.00, balance: 345.94},
    {i:23, date:'2025-09-19', total:134.05, interest: 2.60, adhesion:45.00, balance: 259.49},
    {i:24, date:'2025-10-03', total:133.42, interest: 1.95, adhesion:45.00, balance: 173.02},
    {i:25, date:'2025-10-17', total:132.80, interest: 1.30, adhesion:45.00, balance:  86.52},
    {i:26, date:'2025-10-26', total:132.17, interest: 0.42, adhesion:45.00, balance:   0.00},
  ];

  let state = { schedule:[], selected:1, arrears:0, events:[] };

  function derived(r){
    const loan = clamp2(r.total - r.adhesion);
    const cap = clamp2(loan - r.interest);
    return {loan, cap};
  }

  function resetDemo(){
    state.schedule = original.map(x=>({ ...x, adjustment:0, status:'√Ä venir', paid:false }));
    state.selected = 1;
    state.arrears = 0;
    state.events = [{ts:new Date().toISOString(), title:'Dossier charg√©', txt:'Calendrier (v√©rit√© Margill) pr√™t. Actions = surcouche.'}];
    render();
  }

  function renderKPI(){
    const financed = 2250.00;
    const interestTotal = 220.02;
    const next = state.schedule.find(r=>!r.paid && r.status!=='Annul√©') || state.schedule[0];

    const kpis = [
      {k:'Solde contrat', dot:'good', v:money(next.balance), s:'Solde apr√®s la ligne'},
      {k:'Souffrance', dot:(state.arrears>0?'bad':'good'), v:money(state.arrears), s:'Montant exigible'},
      {k:'Montant financ√©', dot:'warn', v:money(financed), s:'Inclut ouverture'},
      {k:'Int√©r√™t total', dot:'warn', v:money(interestTotal), s:'Somme int√©r√™ts'}
    ];

    document.getElementById('kpi').innerHTML = kpis.map(x=>`
      <div class="card">
        <div class="k"><span>${x.k}</span><span class="dot ${x.dot}"></span></div>
        <div class="v">${x.v}</div>
        <div class="s">${x.s}</div>
      </div>
    `).join('');

    document.getElementById('arrears').textContent = money(state.arrears);
    document.getElementById('next').innerHTML = `${fmtDate(next.date)} ¬∑ <span class="mono">${money(next.total+next.adjustment)}</span>`;
  }

  function renderTable(){
    const tb = document.getElementById('rows');
    tb.innerHTML = state.schedule.map(r=>{
      const sel = r.i===state.selected;
      const {loan, cap} = derived(r);
      const totalCollect = clamp2(r.total + r.adjustment);
      const dot = r.status==='NSF' ? 'bad' : (r.paid ? 'good' : 'warn');
      const label = r.status==='NSF' ? 'NSF' : (r.paid ? 'Pay√©' : '√Ä venir');
      return `
        <tr onclick="selectRow(${r.i})" style="${sel?'background:rgba(96,165,250,.08)':''}">
          <td class="mono">${r.i}</td>
          <td>${fmtDate(r.date)}</td>
          <td class="mono">${money(totalCollect)}</td>
          <td class="mono">${money(loan)}</td>
          <td class="mono">${money(r.interest)}</td>
          <td class="mono">${money(cap)}</td>
          <td class="mono">${money(r.adhesion)}</td>
          <td class="mono">${money(r.adjustment)}</td>
          <td><span class="status"><span class="dot ${dot}"></span>${label}</span></td>
          <td class="mono">${money(r.balance)}</td>
        </tr>
      `;
    }).join('');
    const r = state.schedule.find(x=>x.i===state.selected);
    document.getElementById('sel').textContent = `S√©lection: #${r.i} ¬∑ ${fmtDate(r.date)} ¬∑ Total ${money(r.total+r.adjustment)}`;
  }

  function renderEvents(){
    const box = document.getElementById('events');
    const items = [...state.events].slice(-6).reverse();
    box.innerHTML = items.map(e=>`
      <div class="ev">
        <div class="m"><span>${e.title}</span><span class="mono">${new Date(e.ts).toLocaleString('fr-CA',{hour:'2-digit',minute:'2-digit',year:'numeric',month:'2-digit',day:'2-digit'})}</span></div>
        <div class="t">${e.txt}</div>
      </div>
    `).join('');
  }

  function render(){ renderKPI(); renderTable(); renderEvents(); }

  function selectRow(i){ state.selected=i; render(); }

  function log(title, txt){ state.events.push({ts:new Date().toISOString(), title, txt}); }

  function openAction(kind){
    const r = state.schedule.find(x=>x.i===state.selected);
    document.getElementById('ov').style.display = 'flex';
    const mt = document.getElementById('mt');
    const mb = document.getElementById('mb');
    const mf = document.getElementById('mf');

    mt.textContent = ({report:'üìÖ Reporter', nsf:'‚ùå NSF', split:'‚ûó R√©partir', manual:'üíµ Paiement manuel', note:'üìù Note'})[kind] || 'Action';

    if(kind==='report'){
      mb.innerHTML = `
        <div class="row">
          <div class="field"><label>Ligne</label><input disabled value="#${r.i} ¬∑ ${fmtDate(r.date)} ¬∑ ${money(r.total)}"/></div>
          <div class="field">
            <label>D√©caler (7 ou 14 jours)</label>
            <select id="shift"><option value="7">+7 jours</option><option value="14">+14 jours</option></select>
          </div>
        </div>
        <div class="sum">D√©mo: on garde les m√™mes chiffres du calendrier. Le report change la date et ajoute 25,00$ en souffrance.</div>
      `;
      mf.innerHTML = `<button class="btn" onclick="closeModal()">Annuler</button><button class="btn primary" onclick="applyReport()">Confirmer</button>`;
    }

    if(kind==='nsf'){
      mb.innerHTML = `
        <div class="row">
          <div class="field"><label>Ligne</label><input disabled value="#${r.i} ¬∑ ${fmtDate(r.date)} ¬∑ ${money(r.total)}"/></div>
          <div class="field"><label>Frais NSF</label><input id="fee" type="number" step="0.01" value="48.00"/></div>
        </div>
        <div class="sum">Souffrance += paiement total + frais NSF. (Adh√©sion incluse dans le paiement.)</div>
      `;
      mf.innerHTML = `<button class="btn" onclick="closeModal()">Annuler</button><button class="btn danger" onclick="applyNSF()">Confirmer</button>`;
    }

    if(kind==='split'){
      mb.innerHTML = `
        <div class="row">
          <div class="field"><label>Souffrance</label><input disabled value="${money(state.arrears)}"/></div>
          <div class="field"><label>Sur X paiements</label><select id="n"><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div>
        </div>
        <div class="sum">On met un ‚ÄúAjustement‚Äù sur les X prochaines lignes ‚Äú√Ä venir‚Äù.</div>
      `;
      mf.innerHTML = `<button class="btn" onclick="closeModal()">Annuler</button><button class="btn good" onclick="applySplit()">Appliquer</button>`;
    }

    if(kind==='manual'){
      mb.innerHTML = `
        <div class="row">
          <div class="field"><label>Montant re√ßu</label><input id="amt" type="number" step="0.01" value="148.00"/></div>
          <div class="field"><label>Appliquer √†</label><select id="to"><option value="arrears" selected>Souffrance</option><option value="note">Note seulement</option></select></div>
        </div>
        <div class="sum">D√©mo: si ‚ÄúSouffrance‚Äù, on r√©duit la souffrance.</div>
      `;
      mf.innerHTML = `<button class="btn" onclick="closeModal()">Annuler</button><button class="btn primary" onclick="applyManual()">Enregistrer</button>`;
    }

    if(kind==='note'){
      mb.innerHTML = `
        <div class="field"><label>Note</label><input id="nt" placeholder="Ex: client reporte au prochain vendredi‚Ä¶"/></div>
        <div class="sum">Les notes apparaissent dans l‚Äôhistorique.</div>
      `;
      mf.innerHTML = `<button class="btn" onclick="closeModal()">Annuler</button><button class="btn primary" onclick="applyNote()">Ajouter</button>`;
    }
  }

  function closeModal(ev){
    if(ev && ev.target && ev.target.id!=='ov') return;
    document.getElementById('ov').style.display='none';
  }

  function applyReport(){
    const r = state.schedule.find(x=>x.i===state.selected);
    const shift = Number(document.getElementById('shift').value||7);
    const d = new Date(r.date+'T00:00:00'); d.setDate(d.getDate()+shift);
    const newIso = d.toISOString().slice(0,10);
    r.date = newIso;
    state.arrears = clamp2(state.arrears + 25.00);
    log('Report', `Ligne #${r.i} d√©plac√©e +${shift} jours ‚Üí ${fmtDate(newIso)}. Frais report 25,00$ ajout√©s en souffrance.`);
    closeModal(); render();
  }

  function applyNSF(){
    const r = state.schedule.find(x=>x.i===state.selected);
    const fee = clamp2(Number(document.getElementById('fee').value||0));
    if(r.status==='NSF'){ closeModal(); return; }
    r.status='NSF';
    state.arrears = clamp2(state.arrears + r.total + fee);
    log('NSF', `NSF sur #${r.i}. Souffrance +${money(r.total)} + ${money(fee)} frais NSF.`);
    closeModal(); render();
  }

  function applySplit(){
    const n = Number(document.getElementById('n').value||3);
    if(state.arrears<=0){ closeModal(); return; }
    const targets = state.schedule.filter(r=>!r.paid && r.status!=='NSF').slice(0,n);
    if(!targets.length){ closeModal(); return; }
    const per = clamp2(state.arrears/targets.length);
    targets.forEach(t=> t.adjustment = clamp2(t.adjustment + per));
    log('R√©partition', `Souffrance r√©partie sur ${targets.length} paiement(s): +${money(per)} ajustement par ligne.`);
    state.arrears = 0;
    closeModal(); render();
  }

  function applyManual(){
    const amt = clamp2(Number(document.getElementById('amt').value||0));
    const to = document.getElementById('to').value;
    if(amt<=0){ closeModal(); return; }
    if(to==='arrears'){
      const before = state.arrears;
      state.arrears = clamp2(Math.max(0, state.arrears-amt));
      log('Paiement manuel', `Paiement ${money(amt)} appliqu√© √† la souffrance: ${money(before)} ‚Üí ${money(state.arrears)}.`);
    } else {
      log('Paiement manuel', `Paiement re√ßu ${money(amt)} (note seulement).`);
    }
    closeModal(); render();
  }

  function applyNote(){
    const txt = (document.getElementById('nt').value||'').trim();
    if(!txt){ closeModal(); return; }
    log('Note', txt);
    closeModal(); render();
  }

  resetDemo();
</script>
</body>
</html>
