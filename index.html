<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard pr√™teur priv√©</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a30;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(45,212,191,.18), transparent 55%),
        radial-gradient(900px 650px at 60% 120%, rgba(251,113,133,.14), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      margin:8px 0 16px;
    }
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(96,165,250,.9), rgba(45,212,191,.75));
      box-shadow:0 12px 30px rgba(96,165,250,.20);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:18px;margin:0;line-height:1.2}
    .brand p{margin:0;color:var(--muted2);font-size:12px}
    .search{
      flex:1;max-width:520px;margin:0 14px;
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
    }
    .search input{
      width:100%;background:transparent;border:none;outline:none;color:var(--text);
      font-size:14px;
    }
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .grid{display:grid;grid-template-columns: 1.2fr 0.8fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .search{display:none} }
    .cards{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-bottom:14px;
    }
    @media (max-width: 980px){ .cards{grid-template-columns: repeat(2, 1fr)} }
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      padding:12px 12px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .card .label{color:var(--muted2);font-size:12px;display:flex;justify-content:space-between;gap:10px}
    .card .value{font-size:18px;margin-top:8px;font-weight:700;letter-spacing:.2px}
    .card .sub{margin-top:8px;color:var(--muted);font-size:12px}
    .panel{
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .panelHeader h2{margin:0;font-size:14px}
    .panelHeader small{color:var(--muted2)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      color:var(--text);
      padding:9px 10px;
      border-radius:14px;
      font-size:12px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease;
      display:flex;align-items:center;gap:8px;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color:rgba(96,165,250,.45); background:rgba(96,165,250,.16)}
    .btn.danger{border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.14)}
    .btn.good{border-color:rgba(45,212,191,.45); background:rgba(45,212,191,.12)}
    .btn.ghost{background:transparent}
    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px;}
    th, td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;white-space:nowrap;}
    th{
      position:sticky;top:0;z-index:2;
      background:rgba(10,18,32,.85);
      backdrop-filter: blur(12px);
      color:var(--muted);
      font-weight:600;
    }
    tr:hover td{background:rgba(255,255,255,.04)}
    .status{
      padding:5px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;
      display:inline-flex;align-items:center;gap:8px;
      color:var(--muted);
    }
    .rightCol{display:flex;flex-direction:column;gap:14px;}
    .section{padding:14px;}
    .kv{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:10px;}
    .kv .item{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .kv .k{color:var(--muted2);font-size:11px}
    .kv .v{margin-top:6px;font-weight:700}
    .mono{font-family:var(--mono)}
    .notes{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .note{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .note .meta{color:var(--muted2);font-size:11px;display:flex;justify-content:space-between}
    .note .txt{margin-top:6px;color:var(--text);font-size:12.5px}
    .footerBar{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      color:var(--muted2);
      font-size:12px;
    }
    .hint{color:var(--muted2); font-size:12px; padding:10px 14px 0;}

    /* Modal */
    .modalOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(680px, 100%);
      background:rgba(16,31,59,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius:22px;
      box-shadow:0 30px 100px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .modalHead h3{margin:0;font-size:14px}
    .modalBody{padding:14px}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width: 640px){ .row{grid-template-columns:1fr} }
    .field{
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .field label{display:block;color:var(--muted2);font-size:11px;margin-bottom:8px}
    .field input, .field select{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    .summary{
      margin-top:12px;
      padding:12px;border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12.5px;
      line-height:1.45;
    }
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Dashboard pr√™teur priv√©</h1>
          <p>Client ¬∑ Contrat ¬∑ Calendrier ¬∑ Souffrance ‚Äî simple et clair</p>
        </div>
      </div>

      <div class="search" title="Recherche (mock)">
        üîé <input placeholder="Rechercher un client, un contrat, une date‚Ä¶" />
        <span class="pill"><span class="dot good"></span> Live: mock</span>
      </div>

      <div class="pill" title="Mode">
        <span class="dot warn"></span> Mode: D√©mo
      </div>
    </div>

    <div class="cards" id="kpi"></div>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Calendrier des paiements</h2>
              <small id="subHeader">26 paiements ¬∑ 14 jours ¬∑ Adh√©sion 45,00$</small>
            </div>
            <div class="actions">
              <button class="btn primary" onclick="openAction('report')">üìÖ Reporter</button>
              <button class="btn danger" onclick="openAction('nsf')">‚ùå NSF</button>
              <button class="btn good" onclick="openAction('split')">‚ûó R√©partir souffrance</button>
              <button class="btn" onclick="openAction('manual')">üíµ Paiement manuel</button>
              <button class="btn ghost" onclick="resetDemo()">‚Ü©Ô∏è Reset</button>
            </div>
          </div>

          <div class="hint">Clique une ligne pour la s√©lectionner. (D√©mo: m√™mes chiffres + actions en surcouche.)</div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Total</th>
                  <th>Pr√™t</th>
                  <th>Int√©r√™t</th>
                  <th>Capital</th>
                  <th>Adh√©sion</th>
                  <th>Ajustement</th>
                  <th>Statut</th>
                  <th>Solde apr√®s</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div class="footerBar">
            <div>R√®gles: seulement <b>7</b> ou <b>14</b> jours ¬∑ Adh√©sion toujours due ¬∑ Taux nominal <span class="mono">18.99%</span></div>
            <div class="mono" id="selectedInfo">S√©lection: #1</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="rightCol">
        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Fiche client</h2>
              <small>Tout en 1 page</small>
            </div>
            <div class="pill"><span class="dot good"></span> Actif</div>
          </div>
          <div class="section">
            <div class="kv">
              <div class="item">
                <div class="k">Client</div>
                <div class="v">Marc Savoie <span class="mono" style="font-weight:600;color:var(--muted2)">#10023</span></div>
              </div>
              <div class="item">
                <div class="k">Produit</div>
                <div class="v">Marge de cr√©dit</div>
              </div>
              <div class="item">
                <div class="k">Montant pr√™t</div>
                <div class="v mono">2 000,00 $</div>
              </div>
              <div class="item">
                <div class="k">Frais ouverture</div>
                <div class="v mono">250,00 $</div>
              </div>
              <div class="item">
                <div class="k">Montant financ√©</div>
                <div class="v mono">2 250,00 $</div>
              </div>
              <div class="item">
                <div class="k">Fr√©quence</div>
                <div class="v">14 jours</div>
              </div>
            </div>

            <div class="kv" style="margin-top:12px">
              <div class="item">
                <div class="k">Banque (mode)</div>
                <div class="v">PAD / PPA</div>
              </div>
              <div class="item">
                <div class="k">Statut PAD</div>
                <div class="v"><span class="dot good"></span> Actif</div>
              </div>
              <div class="item">
                <div class="k">Pr√©f√©rence</div>
                <div class="v">Vendredi</div>
              </div>
              <div class="item">
                <div class="k">Notes rapides</div>
                <div class="v">‚úÖ Visible ici</div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHeader">
            <div>
              <h2>Souffrance & √©v√©nements</h2>
              <small>Audit clair</small>
            </div>
            <button class="btn" onclick="openAction('note')">üìù Ajouter note</button>
          </div>
          <div class="section">
            <div class="kv">
              <div class="item">
                <div class="k">Souffrance actuelle</div>
                <div class="v mono" id="rightArrears">0,00 $</div>
              </div>
              <div class="item">
                <div class="k">Prochain pr√©l√®vement</div>
                <div class="v" id="rightNext">15 nov 2024 ¬∑ <span class="mono">147,92 $</span></div>
              </div>
            </div>

            <div class="notes" id="events"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <h3 id="modalTitle">Action</h3>
        <button class="btn" onclick="closeModal()">‚úï Fermer</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

<script>
  // ===== Utilities
  const money = (n) => {
    const x = Number(n || 0);
    return x.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
  };
  const fmtDate = (iso) => {
    const d = new Date(iso + 'T00:00:00');
    return d.toLocaleDateString('fr-CA', { day:'2-digit', month:'short', year:'numeric' }).replace('.', '');
  };
  const clamp2 = (n) => Math.round((Number(n)||0) * 100) / 100;

  // ====== "V√©rit√©" calendrier (d√©mo)
  const originalSchedule = [
    {i:1,  date:'2024-11-15', total:147.92, interest:  9.62, adhesion:45.00, balance:2156.70},
    {i:2,  date:'2024-11-29', total:147.19, interest: 16.15, adhesion:45.00, balance:2070.66},
    {i:3,  date:'2024-12-13', total:146.56, interest: 15.51, adhesion:45.00, balance:1984.61},
    {i:4,  date:'2024-12-27', total:145.94, interest: 14.87, adhesion:45.00, balance:1898.54},
    {i:5,  date:'2025-01-10', total:145.31, interest: 14.22, adhesion:45.00, balance:1812.45},
    {i:6,  date:'2025-01-24', total:144.72, interest: 13.61, adhesion:45.00, balance:1726.34},
    {i:7,  date:'2025-02-07', total:144.09, interest: 12.97, adhesion:45.00, balance:1640.22},
    {i:8,  date:'2025-02-21', total:143.47, interest: 12.32, adhesion:45.00, balance:1554.07},
    {i:9,  date:'2025-03-07', total:142.84, interest: 11.67, adhesion:45.00, balance:1467.90},
    {i:10, date:'2025-03-21', total:142.21, interest: 11.03, adhesion:45.00, balance:1381.72},
    {i:11, date:'2025-04-04', total:141.58, interest: 10.38, adhesion:45.00, balance:1295.52},
    {i:12, date:'2025-04-18', total:140.95, interest:  9.73, adhesion:45.00, balance:1209.30},
    {i:13, date:'2025-05-02', total:140.33, interest:  9.08, adhesion:45.00, balance:1123.05},
    {i:14, date:'2025-05-16', total:139.70, interest:  8.44, adhesion:45.00, balance:1036.79},
    {i:15, date:'2025-05-30', total:139.07, interest:  7.79, adhesion:45.00, balance: 950.51},
    {i:16, date:'2025-06-13', total:138.44, interest:  7.14, adhesion:45.00, balance: 864.21},
    {i:17, date:'2025-06-27', total:137.82, interest:  6.49, adhesion:45.00, balance: 777.88},
    {i:18, date:'2025-07-11', total:137.19, interest:  5.84, adhesion:45.00, balance: 691.53},
    {i:19, date:'2025-07-25', total:136.56, interest:  5.19, adhesion:45.00, balance: 605.16},
    {i:20, date:'2025-08-08', total:135.93, interest:  4.55, adhesion:45.00, balance: 518.78},
    {i:21, date:'2025-08-22', total:135.31, interest:  3.90, adhesion:45.00, balance: 432.37},
    {i:22, date:'2025-09-05', total:134.68, interest:  3.25, adhesion:45.00, balance: 345.94},
    {i:23, date:'2025-09-19', total:134.05, interest:  2.60, adhesion:45.00, balance: 259.49},
    {i:24, date:'2025-10-03', total:133.42, interest:  1.95, adhesion:45.00, balance: 173.02},
    {i:25, date:'2025-10-17', total:132.80, interest:  1.30, adhesion:45.00, balance:  86.52},
    {i:26, date:'2025-10-26', total:132.17, interest:  0.42, adhesion:45.00, balance:   0.00},
  ];

  let state = {
    schedule: [],
    selected: 1,
    arrears: 0.00,     // souffrance (NSF etc.)
    events: []
  };

  function resetDemo(){
    state.schedule = originalSchedule.map(r => ({
      ...r,
      status: '√Ä venir',
      adjustment: 0.00,  // surcouche (ex: r√©partir, ajout)
      paid: false,
      method: 'PAD'      // PAD = pr√©l√®vement, VIREMENT = cash
    }));
    state.selected = 1;
    state.arrears = 0.00;
    state.events = [
      {ts:new Date().toISOString(), title:'Dossier charg√©', txt:'Calendrier charg√©. Teste: Reporter / NSF / R√©partir / Paiement manuel.'}
    ];
    renderAll();
  }

  function calcDerived(row){
    const loanPart = clamp2((row.total || 0) - (row.adhesion || 0));
    const capital = clamp2(loanPart - (row.interest || 0));
    return { loanPart, capital };
  }

  function renderKPI(){
    const financed = 2250.00;
    const interestTotal = 220.02; // d√©mo
    const next = state.schedule
      .filter(r => !r.paid)
      .sort((a,b)=> (a.date.localeCompare(b.date) || a.i - b.i))[0] || state.schedule[0];

    const kpis = [
      {label:'Solde contrat', dot:'good', value: money(next?.balance ?? 0), sub:'Solde apr√®s la ligne s√©lectionn√©e'},
      {label:'Souffrance', dot: state.arrears > 0 ? 'bad' : 'good', value: money(state.arrears), sub:'NSF / montants dus maintenant'},
      {label:'Montant financ√©', dot:'warn', value: money(financed), sub:'Inclut frais ouverture financ√©s'},
      {label:'Int√©r√™t total', dot:'warn', value: money(interestTotal), sub:'Somme des int√©r√™ts (d√©mo)'}
    ];

    const el = document.getElementById('kpi');
    el.innerHTML = kpis.map(k => `
      <div class="card">
        <div class="label"><span>${k.label}</span><span class="dot ${k.dot}"></span></div>
        <div class="value">${k.value}</div>
        <div class="sub">${k.sub}</div>
      </div>
    `).join('');

    document.getElementById('rightArrears').textContent = money(state.arrears);
    document.getElementById('rightNext').innerHTML = `${fmtDate(next.date)} ¬∑ <span class="mono">${money((next.total||0) + (next.adjustment||0))}</span>`;
  }

  function renderTable(){
    const tbody = document.getElementById('rows');
    // afficher dans l‚Äôordre (date, i)
    const ordered = [...state.schedule].sort((a,b)=> (a.date.localeCompare(b.date) || a.i - b.i));

    tbody.innerHTML = ordered.map(r => {
      const sel = (r.i === state.selected);
      const { loanPart, capital } = calcDerived(r);
      const totalToCollect = clamp2((r.total||0) + (r.adjustment||0));

      const statusDot =
        r.status === 'NSF' ? 'bad' :
        r.status === 'Frais report' ? 'warn' :
        (r.paid ? 'good' : 'warn');

      const statusLabel =
        r.status === 'NSF' ? 'NSF' :
        r.status === 'Frais report' ? 'Frais report' :
        (r.paid ? 'Pay√©' : '√Ä venir');

      return `
        <tr onclick="selectRow(${r.i})" style="${sel ? 'background:rgba(96,165,250,.08)' : ''}">
          <td class="mono">${r.i}</td>
          <td>${fmtDate(r.date)}</td>
          <td>${r.method || 'PAD'}</td>
          <td class="mono">${money(totalToCollect)}</td>
          <td class="mono">${money(loanPart)}</td>
          <td class="mono">${money(r.interest || 0)}</td>
          <td class="mono">${money(capital)}</td>
          <td class="mono">${money(r.adhesion || 0)}</td>
          <td class="mono">${money(r.adjustment || 0)}</td>
          <td><span class="status"><span class="dot ${statusDot}"></span>${statusLabel}</span></td>
          <td class="mono">${money(r.balance || 0)}</td>
        </tr>
      `;
    }).join('');

    const selRow = state.schedule.find(r => r.i === state.selected) || state.schedule[0];
    document.getElementById('selectedInfo').textContent =
      `S√©lection: #${selRow.i} ¬∑ ${fmtDate(selRow.date)} ¬∑ Total ${money((selRow.total||0) + (selRow.adjustment||0))}`;
  }

  function renderEvents(){
    const box = document.getElementById('events');
    const items = [...state.events].slice(-7).reverse();
    box.innerHTML = items.map(e => `
      <div class="note">
        <div class="meta">
          <span>${e.title}</span>
          <span class="mono">${new Date(e.ts).toLocaleString('fr-CA', {hour:'2-digit', minute:'2-digit', year:'numeric', month:'2-digit', day:'2-digit'})}</span>
        </div>
        <div class="txt">${e.txt}</div>
      </div>
    `).join('');
  }

  function renderAll(){
    renderKPI();
    renderTable();
    renderEvents();
  }

  function selectRow(i){
    state.selected = i;
    renderAll();
  }

  function logEvent(title, txt){
    state.events.push({ ts:new Date().toISOString(), title, txt });
  }

  // ===== MODAL
  function openAction(kind){
    const row = state.schedule.find(r => r.i === state.selected) || state.schedule[0];
    const overlay = document.getElementById('overlay');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    const foot = document.getElementById('modalFoot');

    title.textContent = ({
      report: 'üìÖ Reporter un paiement',
      nsf: '‚ùå Marquer NSF',
      split: '‚ûó R√©partir la souffrance',
      manual: 'üíµ Paiement manuel',
      note: 'üìù Ajouter une note'
    })[kind] || 'Action';

    // ===== REPORT (TA LOGIQUE)
    if(kind === 'report'){
      // cibles (paiements √† venir hors NSF) sauf la ligne source
      const targets = [...state.schedule]
        .filter(x => x.i !== row.i && !x.paid && x.status !== 'NSF')
        .sort((a,b)=> (a.date.localeCompare(b.date) || a.i - b.i))
        .map(x => `<option value="${x.i}">#${x.i} ¬∑ ${fmtDate(x.date)} ¬∑ ${money((x.total||0)+(x.adjustment||0))} ¬∑ ${x.method||'PAD'}</option>`)
        .join('');

      // dates (pour cr√©er un virement)
      const dates = [...state.schedule]
        .filter(x => !x.paid && x.status !== 'NSF')
        .sort((a,b)=> (a.date.localeCompare(b.date) || a.i - b.i))
        .map(x => `<option value="${x.date}">${fmtDate(x.date)}</option>`)
        .join('');

      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne report√©e (source)</label>
            <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ ${money((row.total||0)+(row.adjustment||0))} ¬∑ ${row.method||'PAD'}" />
          </div>
          <div class="field">
            <label>Montant √† d√©placer (sans les frais)</label>
            <input id="repAmt" type="number" step="0.01" value="${clamp2((row.total||0)+(row.adjustment||0))}" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Mode de report</label>
            <select id="repMode" onchange="toggleReportModeV3()">
              <option value="SPLIT">R√©partir sur X paiements</option>
              <option value="ONE">Ajouter sur 1 paiement pr√©cis</option>
              <option value="WIRE">Cr√©er une nouvelle ligne (VIREMENT)</option>
            </select>
          </div>
          <div class="field">
            <label>Frais de report (reste sur la ligne source)</label>
            <input disabled value="25.00" />
          </div>
        </div>

        <div id="splitBox" style="margin-top:10px">
          <div class="field">
            <label>R√©partir sur combien de paiements ?</label>
            <select id="splitN">
              <option value="1">1 paiement</option>
              <option value="2">2 paiements</option>
              <option value="3" selected>3 paiements</option>
              <option value="4">4 paiements</option>
              <option value="5">5 paiements</option>
            </select>
          </div>
        </div>

        <div id="oneBox" style="margin-top:10px; display:none">
          <div class="field">
            <label>Ajouter sur quelle ligne ?</label>
            <select id="targetLine">
              ${targets || `<option value="">Aucune ligne disponible</option>`}
            </select>
          </div>
        </div>

        <div id="wireBox" style="margin-top:10px; display:none">
          <div class="row">
            <div class="field">
              <label>Date (du calendrier)</label>
              <select id="wireDate">${dates}</select>
            </div>
            <div class="field">
              <label>Type</label>
              <input disabled value="VIREMENT (cash √† venir)" />
            </div>
          </div>
        </div>

        <div class="summary">
          ‚úÖ <b>R√®gle fixe</b> : la ligne source devient <b>25,00$</b> (Frais report) et sera <b>pr√©lev√©e (PAD)</b>.<br/>
          - SPLIT : le montant d√©plac√© est r√©parti sur X paiements √† venir (ajustement).<br/>
          - ONE : le montant d√©plac√© est ajout√© sur 1 ligne cible (ajustement).<br/>
          - WIRE : une nouvelle ligne ‚ÄúVIREMENT‚Äù est cr√©√©e (cash √† venir).
        </div>
      `;

      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="applyReportV3()">Confirmer</button>
      `;
    }

    // ===== NSF
    if(kind === 'nsf'){
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Ligne s√©lectionn√©e</label>
            <input disabled value="#${row.i} ¬∑ ${fmtDate(row.date)} ¬∑ Total ${money((row.total||0)+(row.adjustment||0))} ¬∑ ${row.method||'PAD'}" />
          </div>
          <div class="field">
            <label>Frais NSF</label>
            <input id="nsfFee" type="number" step="0.01" value="48.00" />
          </div>
        </div>
        <div class="summary">
          D√©mo : Souffrance += (paiement total actuel) + frais NSF.<br/>
          (Le paiement reste dans le calendrier, mais on marque NSF.)
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn danger" onclick="applyNSF()">Confirmer NSF</button>
      `;
    }

    // ===== R√©partir souffrance
    if(kind === 'split'){
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Souffrance actuelle</label>
            <input disabled value="${money(state.arrears)}" />
          </div>
          <div class="field">
            <label>R√©partir sur X prochains paiements</label>
            <select id="splitN2">
              <option value="2">2 paiements</option>
              <option value="3" selected>3 paiements</option>
              <option value="4">4 paiements</option>
              <option value="5">5 paiements</option>
            </select>
          </div>
        </div>
        <div class="summary">
          D√©mo : on ajoute un ajustement sur les X prochaines lignes PAD ‚Äú√† venir‚Äù.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn good" onclick="applySplitArrears()">Appliquer</button>
      `;
    }

    // ===== Paiement manuel
    if(kind === 'manual'){
      body.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Montant re√ßu</label>
            <input id="manualAmt" type="number" step="0.01" value="148.00" />
          </div>
          <div class="field">
            <label>Appliquer √†</label>
            <select id="manualTo">
              <option value="arrears" selected>Souffrance</option>
              <option value="note">Note seulement</option>
            </select>
          </div>
        </div>
        <div class="summary">
          D√©mo : si appliqu√© √† ‚ÄúSouffrance‚Äù, on r√©duit la souffrance.
        </div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="applyManual()">Enregistrer</button>
      `;
    }

    // ===== Note
    if(kind === 'note'){
      body.innerHTML = `
        <div class="field">
          <label>Note</label>
          <input id="noteTxt" placeholder="Ex: client reporte au prochain vendredi‚Ä¶" />
        </div>
        <div class="summary">Les notes restent dans l‚Äôhistorique (audit).</div>
      `;
      foot.innerHTML = `
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="applyNote()">Ajouter</button>
      `;
    }

    overlay.style.display = 'flex';
  }

  function closeModal(ev){
    if(ev && ev.target && ev.target.id !== 'overlay') return;
    document.getElementById('overlay').style.display = 'none';
  }

  // ===== REPORT helpers + action
  function toggleReportModeV3(){
    const mode = document.getElementById('repMode').value;
    document.getElementById('splitBox').style.display = (mode === 'SPLIT') ? 'block' : 'none';
    document.getElementById('oneBox').style.display   = (mode === 'ONE')   ? 'block' : 'none';
    document.getElementById('wireBox').style.display  = (mode === 'WIRE')  ? 'block' : 'none';
  }

  function applyReportV3(){
    const fee = 25.00; // R√àGLE FIXE
    const src = state.schedule.find(r => r.i === state.selected);
    const amt = clamp2(Number(document.getElementById('repAmt').value || 0));
    const mode = document.getElementById('repMode').value;

    if(!src || amt <= 0){ closeModal(); return; }

    // ‚úÖ R√àGLE: la ligne source devient 25$ PAD (frais report)
    const oldInfo = `#${src.i} (${fmtDate(src.date)})`;
    src.status = 'Frais report';
    src.method = 'PAD';
    src.total = fee;
    src.adjustment = 0.00;
    src.interest = 0.00;
    src.adhesion = 0.00;

    if(mode === 'SPLIT'){
      const n = Number(document.getElementById('splitN').value || 1);

      const targets = [...state.schedule]
        .filter(r => r.i !== src.i && !r.paid && r.status !== 'NSF' && (r.method||'PAD') === 'PAD')
        .sort((a,b)=> (a.date.localeCompare(b.date) || a.i - b.i))
        .slice(0, n);

      if(!targets.length){ closeModal(); return; }

      const per = clamp2(amt / targets.length);
      targets.forEach(t => t.adjustment = clamp2((t.adjustment || 0) + per));

      logEvent('Report (SPLIT)',
        `Source ${oldInfo} ‚Üí devient ${money(fee)} (PAD). Montant ${money(amt)} r√©parti sur ${targets.length} paiement(s) PAD: +${money(per)} chacun.`
      );
    }

    if(mode === 'ONE'){
      const targetId = Number(document.getElementById('targetLine').value || 0);
      const tgt = state.schedule.find(r => r.i === targetId);

      if(!tgt){ closeModal(); return; }

      tgt.adjustment = clamp2((tgt.adjustment || 0) + amt);

      logEvent('Report (ONE)',
        `Source ${oldInfo} ‚Üí devient ${money(fee)} (PAD). Montant ${money(amt)} ajout√© sur #${tgt.i} (${fmtDate(tgt.date)}).`
      );
    }

    if(mode === 'WIRE'){
      const d = document.getElementById('wireDate').value;
      const maxI = Math.max(...state.schedule.map(r => r.i));

      const newRow = {
        i: maxI + 1,
        date: d,
        total: amt,
        interest: 0.00,
        adhesion: 0.00,
        balance: src.balance,      // d√©mo
        adjustment: 0.00,
        status: '√Ä venir',
        paid: false,
        method: 'VIREMENT'
      };

      state.schedule.push(newRow);

      logEvent('Report (VIREMENT)',
        `Source ${oldInfo} ‚Üí devient ${money(fee)} (PAD). Nouvelle ligne VIREMENT ${fmtDate(d)} cr√©√©e pour ${money(amt)}.`
      );
    }

    closeModal();
    renderAll();
  }

  // ===== NSF
  function applyNSF(){
    const row = state.schedule.find(r => r.i === state.selected);
    const fee = clamp2(Number(document.getElementById('nsfFee').value || 0));
    if(!row){ closeModal(); return; }
    if(row.status === 'NSF'){ closeModal(); return; }

    row.status = 'NSF';
    const totalNow = clamp2((row.total||0) + (row.adjustment||0));
    state.arrears = clamp2(state.arrears + totalNow + fee);

    logEvent('NSF', `NSF sur #${row.i}. Souffrance +${money(totalNow)} + ${money(fee)} (frais NSF).`);
    closeModal();
    renderAll();
  }

  // ===== R√©partir souffrance
  function applySplitArrears(){
    const n = Number(document.getElementById('splitN2').value || 3);
    if(state.arrears <= 0){ closeModal(); return; }

    const targets = [...state.schedule]
      .filter(r => !r.paid && r.status !== 'NSF' && (r.method||'PAD') === 'PAD')
      .sort((a,b)=> (a.date.localeCompare(b.date) || a.i - b.i))
      .slice(0, n);

    if(!targets.length){ closeModal(); return; }

    const per = clamp2(state.arrears / targets.length);
    targets.forEach(t => t.adjustment = clamp2((t.adjustment || 0) + per));

    logEvent('R√©partition souffrance', `Souffrance r√©partie sur ${targets.length} paiement(s): +${money(per)} d‚Äôajustement par ligne.`);
    state.arrears = 0.00;
    closeModal();
    renderAll();
  }

  // ===== Paiement manuel
  function applyManual(){
    const amt = clamp2(Number(document.getElementById('manualAmt').value || 0));
    const to = document.getElementById('manualTo').value;
    if(amt <= 0){ closeModal(); return; }

    if(to === 'arrears'){
      const before = state.arrears;
      state.arrears = clamp2(Math.max(0, state.arrears - amt));
      logEvent('Paiement manuel', `Paiement ${money(amt)} appliqu√© √† la souffrance: ${money(before)} ‚Üí ${money(state.arrears)}.`);
    } else {
      logEvent('Paiement manuel', `Paiement re√ßu ${money(amt)} (note seulement).`);
    }
    closeModal();
    renderAll();
  }

  // ===== Notes
  function applyNote(){
    const txt = (document.getElementById('noteTxt').value || '').trim();
    if(!txt){ closeModal(); return; }
    logEvent('Note', txt);
    closeModal();
    renderAll();
  }

  // init
  resetDemo();
</script>
</body>
</html>
